import{Q as yt,X as vt,$ as Ft,Y as St,Z as Tt,T as kt,b as ee,C as wt,a0 as Ct,u as Pt}from"./jeecg-online-vendor-59c8fbe3.js";import{U as Ot,k as g,c as xt,r as Rt,e as Vt,V as F,a5 as w,a6 as E,f as P,W as U,a9 as L,a7 as $,F as Mt,a8 as jt,an as Dt,R as At,J as j,u as be,q as ye}from"./vue-bcbaddf9.js";import{B as _t}from"./BasicForm-2f1a8584.js";import"./componentMap-da21b34e.js";import{u as Et}from"./useForm-d3b54d9c.js";import"./JAddInput-5dab1a67.js";import"./JSelectUser-5289e428.js";import"./JSelectDept-085a989c.js";import"./JPopup-347128c1.js";import{Q as $t,V as Bt,z as It}from"./index-7711d1b4.js";import"./cron-parser-vendor-15f47fa7.js";import"./index-465fff25.js";import{O as Nt,a as Kt,b as Jt,c as Ut,d as Lt,l as q,V as B,S as qt,e as zt,f as ve,g as Ht}from"./useExtendComponent-48d37d9b-0de10b32.js";import{e as te}from"./constant-fe20103a-44089532.js";import{ax as Wt,ay as Qt,az as Gt,S as Fe,_ as Xt}from"./antd-vue-vendor-a78909e6.js";import"./tinymce-vendor-676f8393.js";import"./vxe-table-vendor-173f2e92.js";import"./lodash-es-vendor-9b741fb8.js";import"./BasicForm.vue_vue_type_style_index_0_lang-6d2f938d.js";import"./BasicModal-62e49180.js";import"./useWindowSizeFn-b083d2b7.js";import"./echarts-vendor-6c8e2159.js";import"./useFormItem-d5fd9260.js";import"./JUpload.vue_vue_type_style_index_0_lang-cb7e645f.js";import"./download-21271a42.js";import"./base64Conver-fa2fe1af.js";import"./index-4812645e.js";import"./index-dd03453c.js";import"./useCountdown-29b28791.js";import"./index-9df7768e.js";import"./areaDataUtil-661e31ab.js";import"./props-70bbfc6e.js";import"./JSelectBiz-49d97425.js";import"./index-ff5e2816.js";import"./codemirror-vendor-611c4582.js";import"./index-ac817054.js";import"./bem-356ebc17.js";import"./props-c7c3390f.js";import"./useContextMenu-5c399fb2.js";import"./depart.api-57663661.js";import"./JUploadModal.vue_vue_type_script_setup_true_lang-e46cb638.js";import"./user.api-79d1ef80.js";import"./customExpression-62f5afd1.js";import"./BasicTable-f6cf85af.js";import"./BasicTable.vue_vue_type_style_index_0_lang-9b2c5de1.js";import"./injectionKey-69710956.js";import"./useTable-20c32c9e.js";import"./useListPage-b93a4fee.js";import"./LinkTableListPiece-34266919-46835075.js";import"./OnlineSelectCascade-c7baf52b-18c447dd.js";import"./JModalTip-abe1515a-369b2996.js";var Yt=Object.defineProperty,Se=Object.getOwnPropertySymbols,Zt=Object.prototype.hasOwnProperty,eo=Object.prototype.propertyIsEnumerable,Te=(i,s,r)=>s in i?Yt(i,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[s]=r,z=(i,s)=>{for(var r in s||(s={}))Zt.call(s,r)&&Te(i,r,s[r]);if(Se)for(var r of Se(s))eo.call(s,r)&&Te(i,r,s[r]);return i},O=(i,s,r)=>new Promise((a,k)=>{var S=m=>{try{p(r.next(m))}catch(c){k(c)}},h=m=>{try{p(r.throw(m))}catch(c){k(c)}},p=m=>m.done?a(m.value):Promise.resolve(m.value).then(S,h);p((r=r.apply(i,s)).next())});const to={vue:Ot,"@":{hooks:{useMessage:vt,useUserStore:Ft},utils:{axios:St,cache:Tt}}};function oo(i,s){const r=Object.assign({},to,i);function a(h){if(h!=null&&h!=""){let p=h.toString().split("/"),m=r[p[0]];for(let c=1;c<p.length;c++)m=m[p[c]];return m}return null}function k(){}function S(h,p){let m="__export_"+$t(6);if(p){const c=`return function (row, customImport, ${m}) {"use strict"; ${h}}`;new Function(c)().call(s,p,a,k)}else{const c=`return function (customImport, ${m}) {"use strict"; ${h}}`;new Function(c)().call(s,a,k)}}return{executeJsEnhanced:S}}const no=/(?:\/\*[\s\S]*?\*\/|\/\/.*?\r?\n|[^{])+\{([\s\S]*)\}$/,oe={optPre:"/online/cgform/api/form/",urlButtonAction:"/online/cgform/api/doButton"},lo={name:"OnlineForm",components:{BasicForm:_t,Loading:Bt,OnlineSubForm:Nt,PrinterOutlined:Wt,DiffOutlined:Qt,FormOutlined:Gt,OnlinePopModal:Kt},props:{id:{type:String,default:""},formTemplate:{type:Number,default:1},disabled:{type:Boolean,default:!1},isTree:{type:Boolean,default:!1},pidField:{type:String,default:""},submitTip:{type:Boolean,default:!0},modalClass:{type:String,default:""},themeTemplate:{type:String,default:""}},emits:["success","rendered"],setup(i,{emit:s}){const{createMessage:r}=Pt(),a=g(null),k=g(!0),S=g(!1),h=g(1),p=g(""),m=g(!1),c=g(!1),x=xt("foreignkey",{value:{}}),V=Rt({reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0}),{onlineFormContext:f,resetContext:H}=Jt(),{formSchemas:D,defaultValueFields:M,changeDataIfArray2String:I,tableName:u,dbData:T,checkOnlyFieldValue:y,hasSubTable:ke,subTabInfo:A,refMap:W,subDataSource:N,baseColProps:we,createFormSchemas:Ce,linkDownList:co,fieldDisplayStatus:_}=Ut(i,a);let{EnhanceJS:d,initCgEnhanceJs:Pe}=Lt(f,!1);const{executeJsEnhanced:Oe}=oo({},f),[xe,{setProps:Re,validate:ne,resetFields:le,setFieldsValue:C,updateSchema:Q,getFieldsValue:G,scrollToField:Ve}]=Et({schemas:D,showActionButtonGroup:!1,baseColProps:we}),ae=g(!1);function Me(){let e=i.disabled;ae.value=e,Re({disabled:e})}function je(e,t,o){return O(this,null,function*(){yield De(),p.value="",yield le(),T.value="";let n=be(e);c.value=n,n?yield ie(t):ue(),ye(()=>{!n&&o&&C(o),Ae(),X("js","loaded"),Me()})})}function De(){return O(this,null,function*(){if(i.isTree===!0){let e=i.pidField,t=D.value;t&&t.length>0&&t.filter(o=>o.field===e).length>0&&(yield Q({field:e,componentProps:{reload:new Date().getTime()}}))}})}function Ae(){if(be(c)===!1){let e=j(M[u.value]);q(e,t=>{C(t)})}}function re(e,t){let o=j(M[e.key]);q(o,n=>{const{row:l,target:b}=t;let R=[{rowKey:l.id,values:z({},n)}];b.setValues(R)})}function ie(e){return O(this,null,function*(){let t=yield Ee(e.id);T.value=Object.assign({},e,t);let o=_e.value,n=Xt(t,...o);i.disabled&&Object.keys(n).map(l=>{!n[l]&&n[l]!==0&&n[l]!=="0"&&delete n[l]}),yield C(n),ue(t)})}function ue(e){e||(e={});let t=Object.keys(N.value);if(t&&t.length>0){let o={};for(let n of t)o[n]=e[n]||[];N.value=o}}let _e=Vt(()=>{let e=D.value,t=[];for(let o of e)t.push(o.field);return t});function Ee(e){let t=`${oe.optPre}${i.id}/${e}`;return new Promise((o,n)=>{ee.get({url:t},{isTransformResponse:!1}).then(l=>{l.success?o(l.result):(n(),r.warning(l.message))}).catch(()=>{n()})})}function $e(e){return O(this,null,function*(){h.value=e.head.tableType,u.value=e.head.tableName,k.value=e.head.tableType==1,Ne(e.head.extConfigJson),Ce(e.schema.properties,e.schema.required,y),d=Pe(e.enhanceJs),s("rendered",V);let t=yield Ht(a);t.$formValueChange=(o,n,l)=>{ot(o,n),l&&C(l),Be(o,n,l)},d&&d.setup&&me(d.setup)})}function Be(e,t,o){f.changEvent(e,t,o)}function Ie(e){f.addObject2Context("changEvent",e)}function Ne(e){let t={reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0};e&&(t=JSON.parse(e)),Object.keys(t).map(o=>{V[o]=t[o]})}function Ke(){k.value===!0?ze():Je()}function Je(){Ue().then(e=>{se(e)})}function Ue(){let e={};return new Promise((t,o)=>{ne().then(n=>t(n),({errorFields:n})=>{n&&n.length>0&&Ve(n[0][0]),o(B)})}).then(t=>(Object.assign(e,I(t)),i.themeTemplate===te?Promise.resolve({}):qe())).then(t=>(Object.assign(e,t),Promise.resolve(e))).catch(t=>((t===B||(t==null?void 0:t.code)===B)&&(r.warning("校验未通过"),t.key&&Le(t.key)),Promise.reject(null)))}function Le(e){let t=A.value;for(let o=0;o<t.length;o++)if(e==t[o].key){let n=o+"";if(K.value===n)break;if(K.value=n,t[o].relationType===0){let l=v(e);kt(300,()=>l==null?void 0:l.validateTable())}break}}function qe(){return new Promise((e,t)=>O(this,null,function*(){let o={};try{let n=A.value;for(let l=0;l<n.length;l++){let b=n[l].key,R=v(b);if(n[l].relationType==1)try{let J=yield R.getAll();o[b]=[],o[b].push(J)}catch(J){throw{code:B,key:b}}else{if(yield R.fullValidateTable())throw{code:B,key:b};o[b]=R.getTableData()}}}catch(n){t(n)}e(o)}))}function ze(){return O(this,null,function*(){try{let e=yield ne();e=Object.assign({},T.value,e),e=I(e),S.value=!0,se(e)}finally{S.value=!1}})}function se(e){at(ge,e).then(()=>{He(e)}).catch(t=>{r.warning(t)})}function He(e){Object.keys(e).map(l=>{Array.isArray(e[l])&&e[l].length==0&&(e[l]="")});let t=p.value,o=`${oe.optPre}${i.id}?tabletype=${h.value}`;t&&(o=`${t}?tabletype=${h.value}`),m.value===!0&&(e[qt]=1),x.value.field&&x.value.value&&(e[x.value.field]=x.value.value);let n=c.value===!0?"put":"post";ee.request({url:o,method:n,params:e},{isTransformResponse:!1}).then(l=>{l.success?(l.result&&(e[zt]=l.result),s("success",e),i.submitTip===!0&&r.success(l.message)):r.warning(l.message)}).finally(()=>{S.value=!1})}function We(e,t,o){t&&o?o.vxeProps?o.setValues([{rowKey:t,values:e}]):o.setValues(e):C(e)}function Qe(e,t){let o={};o[e]=t,C(o)}const K=g("0"),de=g(300),ce=g(340);function Ge(e){if(c.value===!0){let t=T.value;return Xe(t,e)}return""}function Xe(e,t){if(e){let o=e[t];return!o&&o!==0&&(o=e[t.toLowerCase()],!o&&o!==0&&(o=e[t.toUpperCase()])),o}return""}function Ye(e,t){if(d&&d[t+"_onlChange"]){let o=d[t+"_onlChange"](),n=Object.keys(e)[0];if(o[n]){let l=v(t).getFormEvent(),b=z({column:{key:n},value:e[n]},l);o[n].call(f,f,b)}}}function Ze(e,t){if(d&&d[t+"_onlChange"]){let o=d[t+"_onlChange"](f);if(e.column==="all"){let n=Object.keys(o);if(n.length>0)for(let l of n)o[l].call(f,f,e)}else{let n=e.column.key||e.col.key;o[n]&&e.row&&e.row.id&&o[n].call(f,f,e)}}}function et(e,t){t.isModalData||re(e,t)}function tt(e){return"online_"+e+":"}function ot(e,t){return O(this,null,function*(){if(!d||!d.onlChange||!e)return!1;let o=d.onlChange();if(o[e]){let n={row:yield G(),column:{key:e},value:t};o[e].call(f,f,n)}})}function me(e){let t=e.toLocaleString().match(no);if(t.length>1){let o=t[1];Oe(o)}}function X(e,t){if(e=="js"){let o=t+"_hook";d&&d[t]?d[t].call(f,f):d&&d[o]&&me(d[o])}else if(e=="action"){let o=T.value,n={formId:i.id,buttonCode:t,dataId:o.id,uiFormData:Object.assign({},o)};ee.post({url:`${oe.urlButtonAction}`,params:n},{isTransformResponse:!1}).then(l=>{l.success?r.success("处理完成!"):r.warning("处理失败!")})}}function fe(e){let t=v(e),o=[...t.getNewDataWithId(),...N.value[e]];if(!o||o.length==0)return!1;let n=[];for(let l of o)n.push(l.id);t.removeRowsById(n)}function pe(e,t){if(!t)return!1;let o=v(e);typeof t=="object"?o.addRows(t,!0):this.$message.error("添加子表数据,参数不识别!")}function nt(e,t){fe(e),pe(e,t)}function lt(e,t){!t&&t.length<=0&&(t=[]),t.map(o=>{o.hasOwnProperty("label")||(o.label=o.text)}),Q({field:e,componentProps:{options:t}})}function at(e,t){return d&&d.beforeSubmit?d.beforeSubmit(e,t):Promise.resolve()}function rt(e,t){let o=j(_);e&&e.length>0?Object.keys(o).map(n=>{!n.endsWith("_load")&&e.indexOf(n)<0&&(_[n]=!1)}):t&&t.length>0&&Object.keys(o).map(n=>{t.indexOf(n)>=0&&(_[n]=!1)})}function it(e,t){return O(this,null,function*(){p.value=t,yield le(),T.value="",c.value=!0,yield ie(e),yield ye(()=>{X("js","loaded")})})}function v(e){let t=W[e].value;if(t instanceof Array&&(t=t[0]),!t){r.warning("子表ref找不到:"+e);return}return t}function ut(){let e=V.reportPrintUrl,t=T.value.id,o=wt();Ct(e,t,o)}const[st,{openModal:he}]=It(),Y=g(""),Z=g(!0);function dt(e){Y.value=e.id,Z.value=!1,he(!0,{isUpdate:!1,tableType:"3"})}function ct(e){let t=v(e.key).getSelectedData();if(t.length!=1){r.warning("请选择一条数据");return}Y.value=e.id,Z.value=!1,he(!0,{isUpdate:!0,record:t[0]})}function mt(e){const t=e[ve];let o=Fe(e,[ve]);if(o.id){let n=Fe(z({},o),"id"),l=[{rowKey:o.id,values:n}];v(t).setValues(l)}else v(t).addRows(o,{isOnlineJS:!1,setActive:!1,emitChange:!0,isModalData:!0})}function ft(){if(i.themeTemplate===te)return;let e=A.value;if(e&&e.length>0){for(let t of e)if(t.relationType!=1){let o=v(t.key);o&&o.clearSelection()}}}function pt(){let e=G(),t=j(M[u.value]);q(t,o=>{C(o)},e)}function ht(e,t){let o=A.value;if(o&&o.length>0){let n=o.filter(l=>l.key===e);if(n.length==0)return;if(n[0].relationType==1)v(e).executeFillRule();else{let l=j(M[e]),b=j(t.row);q(l,R=>{const{row:J,target:gt}=t;let bt=[{rowKey:J.id,values:z({},R)}];gt.setValues(bt)},b)}}}let ge={tableName:u,loading:S,subActiveKey:K,onlineFormRef:a,getFieldsValue:G,setFieldsValue:C,submitFlowFlag:m,subFormHeight:de,subTableHeight:ce,refMap:W,triggleChangeValues:We,triggleChangeValue:Qe,sh:_,clearSubRows:fe,addSubRows:pe,clearThenAddRows:nt,changeOptions:lt,isUpdate:c,getSubTableInstance:v,updateSchema:Q,executeMainFillRule:pt,executeSubFillRule:ht,changEvent:()=>{},onlineFormValueChange:Ie};return H(ge),{tableName:u,onlineFormRef:a,registerForm:xe,loading:S,subActiveKey:K,hasSubTable:ke,subTabInfo:A,refMap:W,subFormHeight:de,getSubTableForeignKeyValue:Ge,isUpdate:c,handleSubFormChange:Ye,subTableHeight:ce,onlineFormDisabled:ae,subDataSource:N,getSubTableAuthPre:tt,handleAdded:et,handleSubTableDefaultValue:re,handleValueChange:Ze,openSubFormModalForAdd:dt,openSubFormModalForEdit:ct,show:je,createRootProperties:$e,handleSubmit:Ke,sh:_,handleCgButtonClick:X,handleCustomFormSh:rt,handleCustomFormEdit:it,dbData:T,onOpenReportPrint:ut,onlineExtConfigJson:V,registerPopModal:st,popTableName:Y,getPopFormData:mt,popModalRequest:Z,onCloseModal:ft,ERP:te}}},ao=["id"],ro={key:0,style:{"text-align":"right",position:"absolute",top:"6px",right:"20px","z-index":"999"}},io={key:1};function uo(i,s,r,a,k,S){const h=F("PrinterOutlined"),p=F("BasicForm"),m=F("online-sub-form"),c=F("diff-outlined"),x=F("a-button"),V=F("form-outlined"),f=F("JVxeTable"),H=F("a-tab-pane"),D=F("a-tabs"),M=F("Loading"),I=F("online-pop-modal");return w(),E("div",{id:a.tableName+"_form"},[a.dbData.id&&a.onlineExtConfigJson.reportPrintShow?(w(),E("div",ro,[P(h,{title:"打印",onClick:a.onOpenReportPrint,style:{"font-size":"16px"}},null,8,["onClick"])])):U("",!0),P(p,{ref:"onlineFormRef",onRegister:a.registerForm},null,8,["onRegister"]),r.themeTemplate!==a.ERP&&a.hasSubTable?(w(),L(D,{key:1,activeKey:a.subActiveKey,"onUpdate:activeKey":s[0]||(s[0]=u=>a.subActiveKey=u)},{default:$(()=>[(w(!0),E(Mt,null,jt(a.subTabInfo,(u,T)=>(w(),L(H,{tab:u.describe,key:T+"",forceRender:!0},{default:$(()=>[u.relationType==1?(w(),E("div",{key:0,style:Dt({"overflow-y":"auto","overflow-x":"hidden","max-height":a.subFormHeight+"px"})},[P(m,{ref_for:!0,ref:a.refMap[u.key],table:u.key,disabled:a.onlineFormDisabled,"form-template":r.formTemplate,"main-id":a.getSubTableForeignKeyValue(u.foreignKey),properties:u.properties,"required-fields":u.requiredFields,"is-update":a.isUpdate,onFormChange:y=>a.handleSubFormChange(y,u.key)},null,8,["table","disabled","form-template","main-id","properties","required-fields","is-update","onFormChange"])],4)):(w(),E("div",io,[P(f,{ref_for:!0,ref:a.refMap[u.key],toolbar:"","keep-source":"","row-number":"","row-selection":"",height:a.subTableHeight,disabled:a.onlineFormDisabled,columns:u.columns,dataSource:a.subDataSource[u.key],onValueChange:y=>a.handleValueChange(y,u.key),authPre:a.getSubTableAuthPre(u.key),onAdded:y=>a.handleAdded(u,y),onExecuteFillRule:y=>a.handleSubTableDefaultValue(u,y)},{toolbarSuffix:$(()=>[a.onlineFormDisabled?U("",!0):(w(),L(x,{key:0,type:"primary",onClick:y=>a.openSubFormModalForAdd(u)},{default:$(()=>[P(c)]),_:2},1032,["onClick"])),a.onlineFormDisabled?U("",!0):(w(),L(x,{key:1,type:"primary",onClick:y=>a.openSubFormModalForEdit(u)},{default:$(()=>[P(V)]),_:2},1032,["onClick"]))]),_:2},1032,["height","disabled","columns","dataSource","onValueChange","authPre","onAdded","onExecuteFillRule"])]))]),_:2},1032,["tab"]))),128))]),_:1},8,["activeKey"])):U("",!0),P(M,{loading:a.loading,absolute:!1},null,8,["loading"]),At(i.$slots,"bottom"),P(I,{formTableType:"3",request:a.popModalRequest,id:a.popTableName,onRegister:a.registerPopModal,onSuccess:a.getPopFormData,topTip:"",isVxeTableData:""},null,8,["request","id","onRegister","onSuccess"])],8,ao)}const so=yt(lo,[["render",uo]]),dn=Object.freeze(Object.defineProperty({__proto__:null,default:so},Symbol.toStringTag,{value:"Module"}));export{no as G,so as O,dn as a,oo as u};

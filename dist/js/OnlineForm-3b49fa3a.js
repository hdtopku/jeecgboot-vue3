import{bW as ht,c8 as bt,c9 as yt,ca as Ft,cb as vt,b$ as _t,c0 as St,aL as Ct,c2 as Et,ad as Z,ac as Ot,c1 as Tt,l as wt}from"./jeecg-online-vendor-bf2efbcb.js";import{W as Pt,k as b,r as xt,e as kt,U as _,aV as x,as as M,f as C,V as pe,ar as ge,bi as j,F as Bt,a_ as At,af as Dt,R as Rt,J as B,u as he,n as be}from"./vue-c7e3516e.js";import{B as Vt}from"./BasicForm-83ba9c88.js";import"./componentMap-a6d21ad6.js";import{u as Mt}from"./useForm-fa63344e.js";import"./JAddInput-2cbbbde9.js";import{aM as jt,aN as It,E as Jt}from"./index-fde9c72f.js";import{O as Nt,a as Ut,b as Lt,c as Kt,d as qt,l as L,V as I,S as Ht,e as Wt,f as ye,g as Gt}from"./useExtendComponent-f3ffbcdf.js";import"./index-8cf3aabb.js";import{p as zt}from"./pick-51214243.js";import{o as Fe}from"./omit-13df237f.js";import"./antd-vue-vendor-1561c1ba.js";import"./tinymce-vendor-40778af9.js";import"./lodash-es-vendor-42c8d3d4.js";import"./BasicForm.vue_vue_type_style_index_0_lang-aeaafe88.js";import"./BasicModal-ff8f2086.js";import"./useWindowSizeFn-e5cad7ae.js";import"./codemirror-vendor-96aab763.js";import"./echarts-vendor-b30c7238.js";import"./html2canvas-vendor-654dcb8a.js";import"./vxe-table-vendor-8bace23a.js";import"./useFormItem-4a12ff45.js";import"./JUpload.vue_vue_type_style_index_0_lang-3f4c90f3.js";import"./download-c8889ed9.js";import"./base64Conver-4e359726.js";import"./index-ee020524.js";import"./index-53e807bd.js";import"./useCountdown-473e4dcc.js";import"./index-ed4be6fa.js";import"./areaDataUtil-b2642a1f.js";import"./useSelectBiz-c744cf20.js";import"./props-8e8dbf4f.js";import"./index-d4783a30.js";import"./bem-deccd0b6.js";import"./props-c3781b9d.js";import"./useContextMenu-c0be0b5c.js";import"./useTreeBiz-faf9875a.js";import"./index-63ed9c18.js";import"./depart.api-25dc3d39.js";import"./JUploadModal.vue_vue_type_script_setup_true_lang-0a69d004.js";import"./user.api-dd1b3184.js";import"./_commonjsHelpers-938fab4e.js";import"./customExpression-e22f3cce.js";import"./BasicTable-29c6504d.js";import"./BasicTable.vue_vue_type_style_index_0_lang-b7d11241.js";import"./injectionKey-5da932b3.js";import"./useTable-7e303edd.js";import"./useListPage-5049b37a.js";import"./LinkTableListPiece-50f8f8cc.js";import"./OnlineSelectCascade-dee0bae8.js";import"./JModalTip-b651c0e6.js";import"./_flatRest-34ab130c.js";import"./isArray-b183d537.js";import"./toString-8deea73b.js";import"./_arrayPush-ae8b790e.js";import"./_baseClone-632ebf1c.js";import"./_baseSlice-834c0c3e.js";var Qt=Object.defineProperty,ve=Object.getOwnPropertySymbols,Yt=Object.prototype.hasOwnProperty,Xt=Object.prototype.propertyIsEnumerable,_e=(u,s,r)=>s in u?Qt(u,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):u[s]=r,K=(u,s)=>{for(var r in s||(s={}))Yt.call(s,r)&&_e(u,r,s[r]);if(ve)for(var r of ve(s))Xt.call(s,r)&&_e(u,r,s[r]);return u},w=(u,s,r)=>new Promise((a,E)=>{var S=m=>{try{p(r.next(m))}catch(f){E(f)}},g=m=>{try{p(r.throw(m))}catch(f){E(f)}},p=m=>m.done?a(m.value):Promise.resolve(m.value).then(S,g);p((r=r.apply(u,s)).next())});const Zt={vue:Pt,"@":{hooks:{useMessage:bt,useUserStore:yt},utils:{axios:Ft,cache:vt}}};function $t(u,s){const r=Object.assign({},Zt,u);function a(g){if(g!=null&&g!=""){let p=g.toString().split("/"),m=r[p[0]];for(let f=1;f<p.length;f++)m=m[p[f]];return m}return null}function E(){}function S(g,p){let f="__export_"+jt(6);if(p){const y=`return function (row, customImport, ${f}) {"use strict"; ${g}}`;new Function(y)().call(s,p,a,E)}else{const y=`return function (customImport, ${f}) {"use strict"; ${g}}`;new Function(y)().call(s,a,E)}}return{executeJsEnhanced:S}}const eo=/(?:\/\*[\s\S]*?\*\/|\/\/.*?\r?\n|[^{])+\{([\s\S]*)\}$/,$={optPre:"/online/cgform/api/form/",urlButtonAction:"/online/cgform/api/doButton"},to={name:"OnlineForm",components:{BasicForm:Vt,Loading:It,OnlineSubForm:Nt,PrinterOutlined:_t,DiffOutlined:St,FormOutlined:Ct,OnlinePopModal:Ut},props:{id:{type:String,default:""},formTemplate:{type:Number,default:1},disabled:{type:Boolean,default:!1},isTree:{type:Boolean,default:!1},pidField:{type:String,default:""},submitTip:{type:Boolean,default:!0},modalClass:{type:String,default:""}},emits:["success","rendered"],setup(u,{emit:s}){const{createMessage:r}=wt(),a=b(null),E=b(!0),S=b(!1),g=b(1),p=b(""),m=b(!1),f=b(!1),y=xt({reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0}),{onlineFormContext:d,resetContext:q}=Lt(),{formSchemas:A,defaultValueFields:k,changeDataIfArray2String:J,tableName:P,dbData:i,checkOnlyFieldValue:H,hasSubTable:F,subTabInfo:D,refMap:W,subDataSource:N,baseColProps:Se,createFormSchemas:Ce,linkDownList:io,fieldDisplayStatus:R}=Kt(u,a);let{EnhanceJS:c,initCgEnhanceJs:Ee}=qt(d,!1);const{executeJsEnhanced:Oe}=$t({},d),[Te,{setProps:we,validate:ee,resetFields:te,setFieldsValue:T,updateSchema:G,getFieldsValue:z,scrollToField:Pe}]=Mt({schemas:A,showActionButtonGroup:!1,baseColProps:Se}),oe=b(!1);function xe(){let e=u.disabled;oe.value=e,we({disabled:e})}function ke(e,t,o){return w(this,null,function*(){yield Be(),p.value="",yield te(),i.value="";let n=he(e);f.value=n,n?yield le(t):ae(),be(()=>{!n&&o&&T(o),Ae(),Q("js","loaded"),xe()})})}function Be(){return w(this,null,function*(){if(u.isTree===!0){let e=u.pidField,t=A.value;t&&t.length>0&&t.filter(n=>n.field===e).length>0&&(yield G({field:e,componentProps:{reload:new Date().getTime()}}))}})}function Ae(){if(he(f)===!1){let e=B(k[P.value]);L(e,t=>{T(t)})}}function ne(e,t){let o=B(k[e.key]);L(o,n=>{const{row:l,target:h}=t;let O=[{rowKey:l.id,values:K({},n)}];h.setValues(O)})}function le(e){return w(this,null,function*(){let t=yield Re(e.id);i.value=Object.assign({},e,t);let o=De.value,n=zt(t,...o);u.disabled&&Object.keys(n).map(l=>{!n[l]&&n[l]!==0&&n[l]!=="0"&&delete n[l]}),yield T(n),ae(t)})}function ae(e){e||(e={});let t=Object.keys(N.value);if(t&&t.length>0){let o={};for(let n of t)o[n]=e[n]||[];N.value=o}}let De=kt(()=>{let e=A.value,t=[];for(let o of e)t.push(o.field);return t});function Re(e){let t=`${$.optPre}${u.id}/${e}`;return new Promise((o,n)=>{Z.get({url:t},{isTransformResponse:!1}).then(l=>{l.success?o(l.result):(n(),r.warning(l.message))}).catch(()=>{n()})})}function Ve(e){return w(this,null,function*(){g.value=e.head.tableType,P.value=e.head.tableName,E.value=e.head.tableType==1,Ie(e.head.extConfigJson),Ce(e.schema.properties,e.schema.required,H),c=Ee(e.enhanceJs),s("rendered",y);let t=yield Gt(a);t.$formValueChange=(o,n,l)=>{et(o,n),l&&T(l),Me(o,n,l)},c&&c.setup&&se(c.setup)})}function Me(e,t,o){d.changEvent(e,t,o)}function je(e){d.addObject2Context("changEvent",e)}function Ie(e){let t={reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0};e&&(t=JSON.parse(e)),Object.keys(t).map(o=>{y[o]=t[o]})}function Je(){E.value===!0?qe():Ne()}function Ne(){Ue().then(e=>{re(e)})}function Ue(){let e={};return new Promise((t,o)=>{ee().then(n=>t(n),({errorFields:n})=>{n&&n.length>0&&Pe(n[0][0]),o(I)})}).then(t=>(Object.assign(e,J(t)),Ke())).then(t=>(Object.assign(e,t),Promise.resolve(e))).catch(t=>((t===I||(t==null?void 0:t.code)===I)&&(r.warning("\u6821\u9A8C\u672A\u901A\u8FC7"),t.key&&Le(t.key)),Promise.reject(null)))}function Le(e){let t=D.value;for(let o=0;o<t.length;o++)if(e==t[o].key){let n=o+"";if(U.value===n)break;if(U.value=n,t[o].relationType===0){let l=v(e);Et(300,()=>l==null?void 0:l.validateTable())}break}}function Ke(){return new Promise((e,t)=>w(this,null,function*(){let o={};try{let n=D.value;for(let l=0;l<n.length;l++){let h=n[l].key,O=v(h);if(n[l].relationType==1)try{let V=yield O.getAll();o[h]=[],o[h].push(V)}catch(V){throw{code:I,key:h}}else{if(yield O.fullValidateTable())throw{code:I,key:h};o[h]=O.getTableData()}}}catch(n){t(n)}e(o)}))}function qe(){return w(this,null,function*(){try{let e=yield ee();e=Object.assign({},i.value,e),e=J(e),S.value=!0,re(e)}finally{S.value=!1}})}function re(e){nt(me,e).then(()=>{He(e)}).catch(t=>{r.warning(t)})}function He(e){Object.keys(e).map(l=>{Array.isArray(e[l])&&e[l].length==0&&(e[l]="")});let t=p.value,o=`${$.optPre}${u.id}?tabletype=${g.value}`;t&&(o=`${t}?tabletype=${g.value}`),m.value===!0&&(e[Ht]=1);let n=f.value===!0?"put":"post";Z.request({url:o,method:n,params:e},{isTransformResponse:!1}).then(l=>{l.success?(l.result&&(e[Wt]=l.result),s("success",e),u.submitTip===!0&&r.success(l.message)):r.warning(l.message)}).finally(()=>{S.value=!1})}function We(e,t,o){t&&o?o.vxeProps?o.setValues([{rowKey:t,values:e}]):o.setValues(e):T(e)}function Ge(e,t){let o={};o[e]=t,T(o)}const U=b("0"),ie=b(300),ue=b(340);function ze(e){if(f.value===!0){let t=i.value;return Qe(t,e)}return""}function Qe(e,t){if(e){let o=e[t];return!o&&o!==0&&(o=e[t.toLowerCase()],!o&&o!==0&&(o=e[t.toUpperCase()])),o}return""}function Ye(e,t){if(c&&c[t+"_onlChange"]){let o=c[t+"_onlChange"](),n=Object.keys(e)[0];if(o[n]){let h=v(t).getFormEvent(),O=K({column:{key:n},value:e[n]},h);o[n].call(d,d,O)}}}function Xe(e,t){if(c&&c[t+"_onlChange"]){let o=c[t+"_onlChange"](d);if(e.column==="all"){let n=Object.keys(o);if(n.length>0)for(let l of n)o[l].call(d,d,e)}else{let n=e.column.key||e.col.key;o[n]&&e.row&&e.row.id&&o[n].call(d,d,e)}}}function Ze(e,t){t.isModalData||ne(e,t)}function $e(e){return"online_"+e+":"}function et(e,t){return w(this,null,function*(){if(!c||!c.onlChange||!e)return!1;let o=c.onlChange();if(o[e]){let l={row:yield z(),column:{key:e},value:t};o[e].call(d,d,l)}})}function se(e){let o=e.toLocaleString().match(eo);if(o.length>1){let n=o[1];Oe(n)}}function Q(e,t){if(e=="js"){let o=t+"_hook";c&&c[t]?c[t].call(d,d):c&&c[o]&&se(c[o])}else if(e=="action"){let o=i.value,n={formId:u.id,buttonCode:t,dataId:o.id,uiFormData:Object.assign({},o)};Z.post({url:`${$.urlButtonAction}`,params:n},{isTransformResponse:!1}).then(l=>{l.success?r.success("\u5904\u7406\u5B8C\u6210!"):r.warning("\u5904\u7406\u5931\u8D25!")})}}function ce(e){let t=v(e),o=[...t.getNewDataWithId(),...N.value[e]];if(!o||o.length==0)return!1;let n=[];for(let l of o)n.push(l.id);t.removeRowsById(n)}function fe(e,t){if(!t)return!1;let o=v(e);typeof t=="object"?o.addRows(t,!0):this.$message.error("\u6DFB\u52A0\u5B50\u8868\u6570\u636E,\u53C2\u6570\u4E0D\u8BC6\u522B!")}function tt(e,t){ce(e),fe(e,t)}function ot(e,t){!t&&t.length<=0&&(t=[]),t.map(o=>{o.hasOwnProperty("label")||(o.label=o.text)}),G({field:e,componentProps:{options:t}})}function nt(e,t){return c&&c.beforeSubmit?c.beforeSubmit(e,t):Promise.resolve()}function lt(e,t){let o=B(R);e&&e.length>0?Object.keys(o).map(n=>{!n.endsWith("_load")&&e.indexOf(n)<0&&(R[n]=!1)}):t&&t.length>0&&Object.keys(o).map(n=>{t.indexOf(n)>=0&&(R[n]=!1)})}function at(e,t){return w(this,null,function*(){p.value=t,yield te(),i.value="",f.value=!0,yield le(e),yield be(()=>{Q("js","loaded")})})}function v(e){let t=W[e].value;if(t instanceof Array&&(t=t[0]),!t){r.warning("\u5B50\u8868ref\u627E\u4E0D\u5230:"+e);return}return t}function rt(){let e=y.reportPrintUrl,t=i.value.id,o=Ot();Tt(e,t,o)}const[it,{openModal:de}]=Jt(),Y=b(""),X=b(!0);function ut(e){Y.value=e.id,X.value=!1,de(!0,{isUpdate:!1,tableType:"3"})}function st(e){let o=v(e.key).getSelectedData();if(o.length!=1){r.warning("\u8BF7\u9009\u62E9\u4E00\u6761\u6570\u636E");return}Y.value=e.id,X.value=!1,de(!0,{isUpdate:!0,record:o[0]})}function ct(e){const t=e[ye];let o=Fe(e,[ye]);if(o.id){let n=Fe(K({},o),"id"),l=[{rowKey:o.id,values:n}];v(t).setValues(l)}else v(t).addRows(o,{isOnlineJS:!1,setActive:!1,emitChange:!0,isModalData:!0})}function ft(){let e=D.value;if(e&&e.length>0){for(let t of e)if(t.relationType!=1){let o=v(t.key);o&&o.clearSelection()}}}function dt(){let e=z(),t=B(k[P.value]);L(t,o=>{T(o)},e)}function mt(e,t){let o=D.value;if(o&&o.length>0){let n=o.filter(l=>l.key===e);if(n.length==0)return;if(n[0].relationType==1)v(e).executeFillRule();else{let l=B(k[e]),h=B(t.row);L(l,O=>{const{row:V,target:pt}=t;let gt=[{rowKey:V.id,values:K({},O)}];pt.setValues(gt)},h)}}}let me={tableName:P,loading:S,subActiveKey:U,onlineFormRef:a,getFieldsValue:z,setFieldsValue:T,submitFlowFlag:m,subFormHeight:ie,subTableHeight:ue,refMap:W,triggleChangeValues:We,triggleChangeValue:Ge,sh:R,clearSubRows:ce,addSubRows:fe,clearThenAddRows:tt,changeOptions:ot,isUpdate:f,getSubTableInstance:v,updateSchema:G,executeMainFillRule:dt,executeSubFillRule:mt,changEvent:()=>{},onlineFormValueChange:je};return q(me),{tableName:P,onlineFormRef:a,registerForm:Te,loading:S,subActiveKey:U,hasSubTable:F,subTabInfo:D,refMap:W,subFormHeight:ie,getSubTableForeignKeyValue:ze,isUpdate:f,handleSubFormChange:Ye,subTableHeight:ue,onlineFormDisabled:oe,subDataSource:N,getSubTableAuthPre:$e,handleAdded:Ze,handleSubTableDefaultValue:ne,handleValueChange:Xe,openSubFormModalForAdd:ut,openSubFormModalForEdit:st,show:ke,createRootProperties:Ve,handleSubmit:Je,sh:R,handleCgButtonClick:Q,handleCustomFormSh:lt,handleCustomFormEdit:at,dbData:i,onOpenReportPrint:rt,onlineExtConfigJson:y,registerPopModal:it,popTableName:Y,getPopFormData:ct,popModalRequest:X,onCloseModal:ft}}},oo=["id"],no={key:0,style:{"text-align":"right",position:"absolute",top:"6px",right:"20px","z-index":"999"}},lo={key:1};function ao(u,s,r,a,E,S){const g=_("PrinterOutlined"),p=_("BasicForm"),m=_("online-sub-form"),f=_("diff-outlined"),y=_("a-button"),d=_("form-outlined"),q=_("JVxeTable"),A=_("a-tab-pane"),k=_("a-tabs"),J=_("Loading"),P=_("online-pop-modal");return x(),M("div",{id:a.tableName+"_form"},[!!a.dbData.id&&!!a.onlineExtConfigJson.reportPrintShow?(x(),M("div",no,[C(g,{title:"\u6253\u5370",onClick:a.onOpenReportPrint,style:{"font-size":"16px"}},null,8,["onClick"])])):pe("",!0),C(p,{ref:"onlineFormRef",onRegister:a.registerForm},null,8,["onRegister"]),a.hasSubTable?(x(),ge(k,{key:1,activeKey:a.subActiveKey,"onUpdate:activeKey":s[0]||(s[0]=i=>a.subActiveKey=i)},{default:j(()=>[(x(!0),M(Bt,null,At(a.subTabInfo,(i,H)=>(x(),ge(A,{tab:i.describe,key:H+"",forceRender:!0},{default:j(()=>[i.relationType==1?(x(),M("div",{key:0,style:Dt({"overflow-y":"auto","overflow-x":"hidden","max-height":a.subFormHeight+"px"})},[C(m,{ref_for:!0,ref:a.refMap[i.key],table:i.key,disabled:a.onlineFormDisabled,"form-template":r.formTemplate,"main-id":a.getSubTableForeignKeyValue(i.foreignKey),properties:i.properties,"required-fields":i.requiredFields,"is-update":a.isUpdate,onFormChange:F=>a.handleSubFormChange(F,i.key)},null,8,["table","disabled","form-template","main-id","properties","required-fields","is-update","onFormChange"])],4)):(x(),M("div",lo,[C(q,{ref_for:!0,ref:a.refMap[i.key],toolbar:"","keep-source":"","row-number":"","row-selection":"",height:a.subTableHeight,disabled:a.onlineFormDisabled,columns:i.columns,dataSource:a.subDataSource[i.key],onValueChange:F=>a.handleValueChange(F,i.key),authPre:a.getSubTableAuthPre(i.key),onAdded:F=>a.handleAdded(i,F),onExecuteFillRule:F=>a.handleSubTableDefaultValue(i,F)},{toolbarSuffix:j(()=>[C(y,{type:"primary",onClick:F=>a.openSubFormModalForAdd(i)},{default:j(()=>[C(f)]),_:2},1032,["onClick"]),C(y,{type:"primary",onClick:F=>a.openSubFormModalForEdit(i)},{default:j(()=>[C(d)]),_:2},1032,["onClick"])]),_:2},1032,["height","disabled","columns","dataSource","onValueChange","authPre","onAdded","onExecuteFillRule"])]))]),_:2},1032,["tab"]))),128))]),_:1},8,["activeKey"])):pe("",!0),C(J,{loading:a.loading,absolute:!1},null,8,["loading"]),Rt(u.$slots,"bottom"),C(P,{formTableType:"3",request:a.popModalRequest,id:a.popTableName,onRegister:a.registerPopModal,onSuccess:a.getPopFormData,topTip:"",isVxeTableData:""},null,8,["request","id","onRegister","onSuccess"])],8,oo)}var ro=ht(to,[["render",ao]]),mn=Object.freeze(Object.defineProperty({__proto__:null,default:ro},Symbol.toStringTag,{value:"Module"}));export{eo as G,ro as O,mn as a,$t as u};

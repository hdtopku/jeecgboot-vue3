var M=(e,i,u)=>new Promise((F,o)=>{var I=l=>{try{s(u.next(l))}catch(d){o(d)}},m=l=>{try{s(u.throw(l))}catch(d){o(d)}},s=l=>l.done?F(l.value):Promise.resolve(l.value).then(I,m);s((u=u.apply(e,i)).next())});import{s as x,b as ee,u as ae,C as te}from"./jeecg-online-vendor-216a3b98.js";import{B as se}from"./index-679980cc.js";import{B as oe}from"./index-d3bb5676.js";import{a1 as ne}from"./antd-vue-vendor-31afcf32.js";import{d as re,k as p,r as ue,e as le,u as r,U as g,a5 as h,a9 as B,a7 as t,f as _,E as b,al as D,am as w,a6 as A,a8 as U,F as N,V as z,ag as V,ab as q,ap as ie,aq as de,aa as k}from"./vue-249e5fad.js";import"./tinymce-vendor-676f8393.js";import"./lodash-es-vendor-c1987ca1.js";import"./echarts-vendor-6c8e2159.js";import"./vxe-table-vendor-0b109a77.js";import"./BasicModal-9db7feac.js";import"./useWindowSizeFn-be58341e.js";const fe=re({name:"loginSelect",components:{Avatar:ne,BasicModal:oe},emits:["success","register"],setup(e,{emit:i}){const u=x(),{notification:F}=ae(),o=p(!1),I=p([]),m=p(""),s=p(!1),l=p([]),d=p(""),E=p(!1),y=p(""),S=p(),f=ue({orgCode:void 0,tenantId:null}),n={maskClosable:!1,closable:!1,canFullscreen:!1,width:"500px",minHeight:20,maxHeight:20},[$,{closeModal:H}]=se(),P=le(()=>{if(r(s)&&r(o))return"请选择租户和部门";if(r(s)&&!r(o))return"请选择部门";if(!r(s)&&r(o))return"请选择租户"}),j=p({tenantId:[{required:r(o),type:"number",message:"请选择租户",trigger:"change"}],orgCode:[{required:r(s),message:"请选择部门",trigger:"change"}]}),G={labelCol:{span:4},wrapperCol:{span:18}};function J(a){var C,v;if((C=a.userInfo)!=null&&C.orgCode&&((v=a.userInfo)==null?void 0:v.orgCode)!==""){s.value=!1;return}let c=a.multi_depart;c==0?(F.warn({message:"提示",description:"您尚未归属部门,请确认账号信息",duration:3}),s.value=!1):c==2?(s.value=!0,l.value=a.departs):s.value=!1}function K(a){var C,v;if((C=a.userInfo)!=null&&C.loginTenantId&&((v=a.userInfo)==null?void 0:v.loginTenantId)!==0){o.value=!1;return}let c=a.tenantList;Array.isArray(c)&&(c.length===0?(o.value=!1,u.setTenant(f.tenantId)):c.length===1?(f.tenantId=c[0].id,o.value=!1,u.setTenant(f.tenantId)):(o.value=!0,I.value=c))}function O(){if(r(o)&&!f.tenantId)return m.value="error",!1;if(r(s)&&!f.orgCode)return d.value="error",!1;S.value.validate().then(()=>{Q().then(()=>{u.setTenant(f.tenantId),i("success")}).catch(a=>{}).finally(()=>{X()})}).catch(a=>{})}function Q(){return new Promise((a,c)=>{if(!r(s)&&!r(o))a();else{let C={orgCode:f.orgCode,loginTenantId:f.tenantId,username:r(y)};ee.put({url:"/sys/selectDepart",params:C}).then(v=>{v.userInfo?(u.setUserInfo(v.userInfo),a()):(W(v),u.logout(),c())})}})}function W(a){F.error({message:"登录失败",description:((a.response||{}).data||{}).message||a.message||"请求出现错误，请稍后再试",duration:4})}function X(){H(),L()}function Y(a){return M(this,null,function*(){a&&(y.value=u.username,yield L(),yield J(a),yield K(a),!r(s)&&!r(o)?i("success",u.getUserInfo):E.value=!0),a.isLogin=!1,u.setLoginInfo(a)})}function L(){I.value=[],m.value="",l.value=[],d.value=""}function Z(a){m.value=""}function R(a){d.value=""}return{registerModal:$,visible:E,tenantList:I,isMultiTenant:o,validate_status:m,isMultiDepart:s,departList:l,validate_status1:d,formState:f,rules:j,layout:G,formRef:S,currTitle:P,config:n,handleTenantChange:Z,handleDepartChange:R,show:Y,handleSubmit:O}}});const T=e=>(ie("data-v-456d5286"),e=e(),de(),e),ce=T(()=>k("span",null,"您隶属于多租户，请选择登录租户",-1)),pe=T(()=>k("span",{style:{color:"#ed6f6f"}},"请选择登录租户",-1)),me=T(()=>k("span",null,"您隶属于多部门，请选择登录部门",-1)),ve=T(()=>k("span",{style:{color:"#ed6f6f"}},"请选择登录部门",-1));function ge(e,i,u,F,o,I){const m=g("a-avatar"),s=g("a-tooltip"),l=g("a-select-option"),d=g("a-select"),E=g("a-form-item"),y=g("a-form"),S=g("a-button"),f=g("BasicModal");return h(),B(f,V(e.config,{onRegister:e.registerModal,title:e.currTitle,wrapClassName:"loginSelectModal",visible:e.visible,"onUpdate:visible":i[2]||(i[2]=n=>e.visible=n)}),{footer:t(()=>[_(S,{onClick:e.handleSubmit,type:"primary"},{default:t(()=>[b("确认")]),_:1},8,["onClick"])]),default:t(()=>[_(y,V({ref:"formRef",model:e.formState,rules:e.rules},e.layout,{colon:!1,class:"loginSelectForm"}),{default:t(()=>[e.isMultiTenant?(h(),B(E,{key:0,name:"tenantId","validate-status":e.validate_status},D({label:t(()=>[_(s,{placement:"topLeft"},{title:t(()=>[ce]),default:t(()=>[_(m,{style:{"background-color":"#87d068"},size:30},{default:t(()=>[b(" 租户 ")]),_:1})]),_:1})]),default:t(()=>[_(d,{value:e.formState.tenantId,"onUpdate:value":i[0]||(i[0]=n=>e.formState.tenantId=n),onChange:e.handleTenantChange,placeholder:"请选择登录租户",class:w({"valid-error":e.validate_status=="error"})},{default:t(()=>[(h(!0),A(N,null,U(e.tenantList,n=>(h(),B(l,{key:n.id,value:n.id},{default:t(()=>[b(q(n.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","onChange","class"])]),_:2},[e.validate_status=="error"?{name:"extra",fn:t(()=>[pe]),key:"0"}:void 0]),1032,["validate-status"])):z("",!0),e.isMultiDepart?(h(),B(E,{key:1,"validate-status":e.validate_status1,colon:!1},D({label:t(()=>[_(s,{placement:"topLeft"},{title:t(()=>[me]),default:t(()=>[_(m,{style:{"background-color":"rgb(104, 208, 203)"},size:30},{default:t(()=>[b(" 部门 ")]),_:1})]),_:1})]),default:t(()=>[_(d,{value:e.formState.orgCode,"onUpdate:value":i[1]||(i[1]=n=>e.formState.orgCode=n),onChange:e.handleDepartChange,placeholder:"请选择登录部门",class:w({"valid-error":e.validate_status1=="error"})},{default:t(()=>[(h(!0),A(N,null,U(e.departList,n=>(h(),B(l,{key:n.orgCode,value:n.orgCode},{default:t(()=>[b(q(n.departName),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","onChange","class"])]),_:2},[e.validate_status1=="error"?{name:"extra",fn:t(()=>[ve]),key:"0"}:void 0]),1032,["validate-status"])):z("",!0)]),_:1},16,["model","rules"])]),_:1},16,["onRegister","title","visible"])}const Le=te(fe,[["render",ge],["__scopeId","data-v-456d5286"]]);export{Le as default};

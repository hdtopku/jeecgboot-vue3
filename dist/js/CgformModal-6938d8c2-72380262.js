import{t as qe,B as Ue,z as $e,C as Ke,M as He}from"./index-26fb0584.js";import{B as ze}from"./index-9ca8f863.js";import{B as Ge}from"./BasicForm-e7d3537f.js";import"./componentMap-42aebfee.js";import{u as We}from"./useForm-b8bb8b05.js";import"./JAddInput-6e8b52df.js";import"./JSelectUser-9d666511.js";import"./JSelectDept-113b0470.js";import"./JPopup-746d3c0b.js";import"./cron-parser-vendor-b0ab0fe2.js";import"./JEllipsis.vue_vue_type_script_setup_true_lang-8153fc9b.js";import{b as v,V as Ye,Y as E,u as Ze}from"./jeecg-online-vendor-9cc54e36.js";import{I as Xe}from"./useSchemas-fc8d97ce-f4a3aead.js";import et from"./DBAttributeTable-cd1c41e5-ecac1bc1.js";import tt from"./PageAttributeTable-811185fd-673bbbb1.js";import at from"./CheckDictTable-414313f2-fd8734da.js";import lt from"./ForeignKeyTable-cb1abd1d-560d6d2c.js";import ot from"./IndexTable-4e94cd1f-951af8f9.js";import nt from"./QueryTable-4ba771ef-c20f57ab.js";import it from"./ExtendConfigModal-60f2cf86-bcc2a4b5.js";import{y as rt,m as st,c as dt,r as S}from"./cgform.data-cbdd88c3-2f9de619.js";import{D as ut}from"./useOnlineTest-0df0ae86-2162a45a.js";import{g as ct}from"./useExtendComponent-48d37d9b-e97967f5.js";import{d as bt,k as g,e as ee,p as te,r as mt,V as b,a5 as _,a9 as z,a7 as u,f as r,E as F,a6 as ae,F as ft,a8 as pt,ab as gt,W as le,aa as oe,ag as Tt,n as G,J as yt}from"./vue-5a09445c.js";import"./antd-vue-vendor-04f0af1d.js";import"./tinymce-vendor-e2919cb0.js";import"./lodash-es-vendor-70833b4a.js";import"./codemirror-vendor-f458506d.js";import"./echarts-vendor-6c8e2159.js";import"./vxe-table-vendor-c5aaa9d2.js";import"./BasicModal-d2e0602d.js";import"./useWindowSizeFn-cfb01db5.js";import"./BasicForm.vue_vue_type_style_index_0_lang-9ae993bd.js";import"./useFormItem-43cba0e8.js";/* empty css              */import"./download-1219b967.js";import"./base64Conver-fa2fe1af.js";import"./index-f43a5105.js";import"./index-89a04c4e.js";import"./useCountdown-82ecfbb7.js";import"./useFormItemSingle-8ecd3b0e.js";import"./JUpload.vue_vue_type_style_index_0_lang-5ac4f8ef.js";import"./index-a0d17b33.js";import"./index-88d76987.js";import"./areaDataUtil-1ddb02e1.js";import"./props-c570bc09.js";import"./JSelectBiz-292f2b27.js";import"./index-84c48248.js";import"./index-93698215.js";import"./bem-2217b93d.js";import"./props-17f0c5eb.js";import"./useContextMenu-73027fbb.js";import"./depart.api-8a5b83ee.js";import"./validator-79eadaee.js";import"./user.api-0a40541d.js";import"./useTableSync-dc333087-d5cb8e7b.js";import"./LinkTableConfigModal-77d7c0b9-d546dae6.js";import"./LinkTableFieldConfigModal-c5689ab0-b401beec.js";import"./FieldExtendJsonModal-48f7d67f-89272fe4.js";import"./JUploadModal.vue_vue_type_script_setup_true_lang-e33179dd.js";import"./customExpression-62f5afd1.js";import"./BasicTable-b1f7a2ba.js";import"./BasicTable.vue_vue_type_style_index_0_lang-04f23e46.js";import"./injectionKey-69710956.js";import"./useTable-c1b0a869.js";import"./useListPage-2f6289a5.js";import"./LinkTableListPiece-34266919-5eeff459.js";import"./OnlineSelectCascade-c7baf52b-260451fd.js";import"./JModalTip-abe1515a-6fa065a0.js";var vt=Object.defineProperty,ht=Object.defineProperties,Ct=Object.getOwnPropertyDescriptors,ne=Object.getOwnPropertySymbols,kt=Object.prototype.hasOwnProperty,xt=Object.prototype.propertyIsEnumerable,ie=(t,o,c)=>o in t?vt(t,o,{enumerable:!0,configurable:!0,writable:!0,value:c}):t[o]=c,J=(t,o)=>{for(var c in o||(o={}))kt.call(o,c)&&ie(t,c,o[c]);if(ne)for(var c of ne(o))xt.call(o,c)&&ie(t,c,o[c]);return t},Rt=(t,o)=>ht(t,Ct(o)),x=(t,o,c)=>new Promise((O,C)=>{var m=f=>{try{k(c.next(f))}catch(p){C(p)}},R=f=>{try{k(c.throw(f))}catch(p){C(p)}},k=f=>f.done?O(f.value):Promise.resolve(f.value).then(m,R);k((c=c.apply(t,o)).next())});const $a=t=>v.get({url:"/online/cgform/head/list",params:t}),Ka=t=>re(t,0),Ha=t=>v.delete({url:"/online/cgform/head/removeRecord",params:{id:t}},{joinParamsToUrl:!0}),za=t=>re(t,1),Ga=t=>v.delete({url:"/online/cgform/head/delete",params:{id:t}},{joinParamsToUrl:!0});function re(t,o){return v.delete({url:"/online/cgform/head/deleteBatch",params:{ids:t.join(","),flag:o}},{joinParamsToUrl:!0})}const Wa=(t,o)=>v.post({url:`/online/cgform/api/doDbSynch/${t}/${o}`,timeout:12e3,timeoutErrorMessage:"同步数据库超时，已自动刷新"}),Ya=t=>v.post({url:`/online/cgform/head/copyOnline?code=${t}`}),Za=(t,o,c)=>v.get({url:`/online/cgform/head/copyOnlineTable/${t}`,params:J({tableName:o},c)}),L={doQueryField:(t,o)=>v.get({url:"/online/cgform/field/listByHeadId",params:J({headId:t},o)}),doQueryIndexes:(t,o)=>v.get({url:"/online/cgform/index/listByHeadId",params:J({headId:t},o)}),doSaveOrUpdate:(t,o)=>o?v.put({url:"/online/cgform/api/editAll",params:t}):v.post({url:"/online/cgform/api/addAll",params:t}),editHead:t=>v.put({url:"/online/cgform/head/edit",params:t})},Dt=bt({name:"CgformModal",components:{BasicModal:ze,BasicForm:Ge,DBAttributeTable:et,PageAttributeTable:tt,CheckDictTable:at,ForeignKeyTable:lt,IndexTable:ot,QueryTable:nt,ExtendConfigModal:it,Icon:qe},emits:["success","register"],props:{actionButton:{type:Boolean,default:!0,required:!1}},setup(t,{emit:o}){const{createMessage:c}=Ze(),O=g(),C=g(!1);let m={};const R=ee(()=>C.value?"编辑":"新增"),k=g(!0),f=g(!1),p=g("dbTable"),I=g(!0),d={dbTable:g(),pageTable:g(),checkTable:g(),fkTable:g(),idxTable:g(),queryTable:g()},Q=ee(()=>{var e,a;return(a=(e=O.value)==null?void 0:e.fullScreenRef)!=null?a:!1});te("tables",d),te("fullScreenRef",Q);const{formSchemas:V}=Xe(t,{onTableTypeChange:he,onIsTreeChange:Ce,ifShowOfSubTableStr:()=>W}),[q,w]=We({schemas:V,showActionButtonGroup:!1,labelAlign:"right"}),{resetFields:U,setFieldsValue:j,validate:P}=w,[$,{closeModal:K}]=Ue(e=>{var a;C.value=(a=e==null?void 0:e.isUpdate)!=null?a:!1,C.value?Y(e==null?void 0:e.record):fe()}),M=g("");let T=mt({});const h=He(()=>ke(),150);let N=[],W=!1,A=!1,D=[];const{aiTestMode:se,aiTestTable:de,aiTableList:ue,initVirtualData:ce,tableJsonGetHelper:be,refreshCacheTableName:me}=ut();function fe(){Y({})}function Y(e){return x(this,null,function*(){var a;if(k.value=!1,p.value="dbTable",yield U(),m=Object.assign({},e),ye(m),be(m),Te(m),j(m),M.value=m.tableName,E(1,()=>I.value=!1),C.value)(a=d.dbTable.value)==null||a.setDataSource([]),yield pe(m.id),yield ge(m.id),ct(d.pageTable).then(()=>{d.pageTable.value.changePageType(m.tableType==3)});else{let{initialData:l,tempIds:n}=rt();yield Z(l,!0),N=n}})}function pe(e){return x(this,null,function*(){f.value=!0;try{let a=yield L.doQueryField(e);f.value=!1,yield Z(a)}finally{f.value=!1}})}function ge(e){return x(this,null,function*(){let a=yield L.doQueryIndexes(e);d.idxTable.value.setDataSource(a)})}function Te(e){let a={};if(e.extConfigJson)try{a=JSON.parse(e.extConfigJson)}catch(l){}T=Object.assign({},st,a,{isDesForm:e.isDesForm||"N",desFormCode:e.desFormCode||""})}function ye(e){A=e.isTree=="Y",W=e.tableType===2}function Z(e,a){return x(this,null,function*(){const{dbTable:l,pageTable:n,checkTable:s,fkTable:i,queryTable:y}=d;l.value||(yield G(),yield E(1)),l.value.setDataSource(e,a),setTimeout(()=>{n.value.setDataSource(e,a),s.value.setDataSource(e,a),i.value.setDataSource(e,a),y.value.setDataSource(e,a)},10)})}function ve(e){if(["pageTable","checkTable","fkTable","idxTable","queryTable"].indexOf(e)!==-1){const a=d.dbTable,l=d[e];a.value.tableRef.resetScrollTop(),l.value.syncTable(a)}}function he(e){e===1&&j({themeTemplate:"normal"}),d.pageTable.value.changePageType(e==3)}function Ce(e){e==="Y"?Be():Se()}function H(){h()}function ke(){return x(this,null,function*(){let{dbTable:e,pageTable:a,checkTable:l,fkTable:n,queryTable:s}=d;yield a.value.syncTable(e),yield l.value.syncTable(e),yield n.value.syncTable(e),yield s.value.syncTable(e)})}function xe(){H()}function Re(){H()}function De(e){let{oldIndex:a,newIndex:l}=e;Oe(a,l)}function Fe(e){return x(this,null,function*(){let{insertIndex:a,row:l}=e,{pageTable:n,checkTable:s,fkTable:i,queryTable:y}=d;n.value.tableRef.insertRows(l,a),s.value.tableRef.insertRows(l,a),i.value.tableRef.insertRows(l,a),y.value.tableRef.insertRows(l,a)})}function Oe(e,a){let{pageTable:l,checkTable:n,fkTable:s,queryTable:i}=d;l.value.tableRef.rowResort(e,a),n.value.tableRef.rowResort(e,a),s.value.tableRef.rowResort(e,a),i.value.tableRef.rowResort(e,a)}function Ie(e){d.pageTable.value.syncFieldShowType(e.row)}function we(e){d.pageTable.value.enableQuery(e)}function Be(){if(!A){let{dbTable:e,pageTable:a,checkTable:l}=d,n=dt();n=n.filter(s=>!e.value.tableRef.getTableData().map(i=>i.dbFieldName).includes(s.dbFieldName)),D=[],n.forEach(s=>{let i=Ke()+"__tempId";D.push(i),s.id=i}),e.value.tableRef.addRows(n,{setActive:!1}),a.value.tableRef.addRows(n,{setActive:!1}),l.value.tableRef.addRows(n,{setActive:!1}),G(()=>H()),A=!0}G(()=>{w.setFieldsValue({treeIdField:"has_child",treeParentIdField:"pid"})})}function Se(){if(D&&D.length>0){let{dbTable:e}=d;e.value.tableDeleteLines(D),D=[],A=!1}}function _e(){let e={};return new Promise((a,l)=>{P().then(n=>a({values:n}),()=>l(S))}).then(a=>(Object.assign(e,a),je())).then(a=>{Object.assign(e,a);let l=Pe(e);return Me(l)}).catch(a=>((a===S||(a==null?void 0:a.code)===S)&&c.warning("校验未通过"),Promise.reject(null)))}function je(){return new Promise((e,a)=>x(this,null,function*(){let l=Object.keys(d),n={};for(let s=0;s<l.length;s++){let i=l[s],y=d[i];try{n[i]=yield y.value.validateData(i)}catch(B){B.code===S&&(p.value=B.activeKey),a(B);return}}e(n)}))}function Pe(e){let a={head:{},fields:[],indexs:[],deleteFieldIds:[],deleteIndexIds:[]};return a.head=Object.assign(m,e.values),a.head.isDesForm=T.isDesForm,a.head.desFormCode=T.desFormCode,delete T.isDesForm,delete T.desFormCode,a.head.extConfigJson=JSON.stringify(T),e.dbTable.tableData.forEach((l,n)=>{let s=l.id,i=Object.assign({},l),y=e.pageTable.tableData[n];i=Object.assign(y,i);let B=e.checkTable.tableData[n];i=Object.assign(B,i);let Qe=e.fkTable.tableData[n];i=Object.assign(Qe,i);let Ve=e.queryTable.tableData[n];i=Object.assign(Ve,i),s==null||s===""?delete i.id:i.id=s,[].concat(N,D).includes(i.id)&&delete i.id,a.fields.push(i)}),a.deleteFieldIds=e.dbTable.deleteIds,a.indexs=e.idxTable.tableData,a.deleteIndexIds=e.idxTable.deleteIds,a}function Me(e){return new Promise((a,l)=>{let n=e.fields,s=!0;if(n&&n.length>0){let i=0;for(let y=0;y<n.length;y++)if((n[y].mainField||n[y].mainTable)&&(i+=1),i>1){s=!1;break}}s?a(e):l({code:-1,msg:"外键只允许配置一个!",error:S})})}function Ne(){k.value=!0,_e().then(e=>x(this,null,function*(){var a;if(e.fields&&e.fields.length>0)for(let l of e.fields)l.dbFieldName=l.dbFieldName.toLowerCase().trim();(a=e.head)!=null&&a.tableName&&(e.head.tableName=e.head.tableName.toLowerCase().trim()),yield L.doSaveOrUpdate(e,C.value),me(M.value,e.head.tableName),o("success"),E(1,()=>X())}),e=>{}).finally(()=>{k.value=!1})}const[Ae,Ee]=$e();function Le(e){return x(this,null,function*(){if(T=e,C.value==!0){let a=yt(T);const l={id:m.id,extConfigJson:JSON.stringify(a)};yield L.editHead(l),o("success")}})}function Je(){Ee.openModal(!0,{extConfigJson:T})}function X(){I.value=!0,E(1,()=>K())}return Rt(J({},d),{modalRef:O,title:R,confirmLoading:k,tableLoading:f,activeKey:p,onCancel:X,extConfigJson:T,formAction:w,hideTabs:I,onSubmit:Ne,onTabsChange:ve,onTableAdded:xe,onTableRemoved:Re,onTableDragged:De,onTableInserted:Fe,onTableSyncDbType:Ie,onTableQuery:we,onOpenExtConfig:Je,onExtConfigOk:Le,registerForm:q,registerModal:$,registerExtendConfigModal:Ae,aiTestMode:se,aiTestTable:de,aiTableList:ue,initVirtualData:ce})}}),Ft={style:{flex:"1","text-align":"right"}},Ot={key:0,style:{display:"inline-block","text-align":"left",position:"absolute",left:"0"}};function It(t,o,c,O,C,m){const R=b("a-button"),k=b("BasicForm"),f=b("DBAttributeTable"),p=b("a-tab-pane"),I=b("PageAttributeTable"),d=b("CheckDictTable"),Q=b("ForeignKeyTable"),V=b("IndexTable"),q=b("Icon"),w=b("a-tooltip"),U=b("QueryTable"),j=b("a-tabs"),P=b("a-spin"),$=b("a-select-option"),K=b("a-select"),M=b("ExtendConfigModal"),T=b("BasicModal");return _(),z(T,Tt({ref:"modalRef",title:t.title,width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:t.confirmLoading},t.$attrs,{onCancel:t.onCancel,onRegister:t.registerModal}),{footer:u(()=>[r(R,{onClick:t.onCancel},{default:u(()=>[F("关闭")]),_:1},8,["onClick"]),r(R,{type:"primary",loading:t.confirmLoading,preIcon:"ant-design:save",onClick:t.onSubmit},{default:u(()=>[F("保存")]),_:1},8,["loading","onClick"]),t.aiTestMode?(_(),ae("div",Ot,[r(K,{value:t.aiTestTable,"onUpdate:value":o[1]||(o[1]=h=>t.aiTestTable=h),placeholder:"请选择测试的表类型",getPopupContainer:h=>h.parentElement,style:{width:"250px",margin:"0 10px 0 20px"}},{default:u(()=>[(_(!0),ae(ft,null,pt(t.aiTableList,(h,N)=>(_(),z($,{key:N,value:h.name},{default:u(()=>[F(gt(h.title+"（"+h.name+"）"),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","getPopupContainer"]),r(R,{type:"primary",ghost:"",onClick:t.initVirtualData},{default:u(()=>[F("生成数据>>")]),_:1},8,["onClick"])])):le("",!0)]),default:u(()=>[r(P,{wrapperClassName:"p-2",spinning:t.confirmLoading},{default:u(()=>[r(k,{onRegister:t.registerForm},{extConfigButton:u(()=>[oe("div",Ft,[r(R,{preIcon:"ant-design:setting",onClick:t.onOpenExtConfig},{default:u(()=>[F("扩展配置")]),_:1},8,["onClick"])])]),_:1},8,["onRegister"]),r(P,{spinning:t.tableLoading||t.hideTabs},{default:u(()=>[t.hideTabs?le("",!0):(_(),z(j,{key:0,activeKey:t.activeKey,"onUpdate:activeKey":o[0]||(o[0]=h=>t.activeKey=h),animated:"",onChange:t.onTabsChange},{default:u(()=>[r(p,{tab:"数据库属性",key:"dbTable",forceRender:""},{default:u(()=>[r(f,{ref:"dbTable",actionButton:t.actionButton,onAdded:t.onTableAdded,onRemoved:t.onTableRemoved,onDragged:t.onTableDragged,onInserted:t.onTableInserted,onSyncDbType:t.onTableSyncDbType},null,8,["actionButton","onAdded","onRemoved","onDragged","onInserted","onSyncDbType"])]),_:1}),r(p,{tab:"页面属性",key:"pageTable",forceRender:""},{default:u(()=>[r(I,{ref:"pageTable"},null,512)]),_:1}),r(p,{tab:"校验字段",key:"checkTable",forceRender:""},{default:u(()=>[r(d,{ref:"checkTable"},null,512)]),_:1}),r(p,{tab:"外键",key:"fkTable",forceRender:""},{default:u(()=>[r(Q,{ref:"fkTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(p,{tab:"索引",key:"idxTable",forceRender:""},{default:u(()=>[r(V,{ref:"idxTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(p,{key:"queryTable",forceRender:""},{tab:u(()=>[oe("span",null,[F(" 个性查询配置 "),r(w,null,{title:u(()=>[F("允许自定义，查询表单字段控件类型！")]),default:u(()=>[r(q,{icon:"bx:help-circle"})]),_:1})])]),default:u(()=>[r(U,{ref:"queryTable",onQuery:t.onTableQuery},null,8,["onQuery"])]),_:1})]),_:1},8,["activeKey","onChange"]))]),_:1},8,["spinning"])]),_:1},8,["spinning"]),r(M,{onRegister:t.registerExtendConfigModal,parentForm:t.formAction,onOk:t.onExtConfigOk},null,8,["onRegister","parentForm","onOk"])]),_:1},16,["title","confirmLoading","onCancel","onRegister"])}const wt=Ye(Dt,[["render",It]]),Xa=Object.freeze(Object.defineProperty({__proto__:null,default:wt},Symbol.toStringTag,{value:"Module"}));export{wt as C,Ga as a,Ha as b,Ka as c,Ya as d,za as e,Wa as f,Za as g,Xa as h,$a as l};

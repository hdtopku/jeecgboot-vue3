var W=Object.defineProperty;var O=Object.getOwnPropertySymbols;var j=Object.prototype.hasOwnProperty,E=Object.prototype.propertyIsEnumerable;var N=(o,s,t)=>s in o?W(o,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[s]=t,q=(o,s)=>{for(var t in s||(s={}))j.call(s,t)&&N(o,t,s[t]);if(O)for(var t of O(s))E.call(s,t)&&N(o,t,s[t]);return o};var R=(o,s,t)=>new Promise((f,b)=>{var V=u=>{try{h(t.next(u))}catch(c){b(c)}},x=u=>{try{h(t.throw(u))}catch(c){b(c)}},h=u=>u.done?f(u.value):Promise.resolve(u.value).then(V,x);h((t=t.apply(o,s)).next())});import{B as z}from"./index-cd2db611.js";import{B as Q}from"./BasicForm-1c4cfe6b.js";import"./componentMap-bab84cb7.js";import{u as X}from"./useForm-799a6766.js";import"./JAddInput-903fbbea.js";import"./JSelectUser-14c3fad5.js";import"./JSelectDept-56a87299.js";import"./JPopup-d3d151eb.js";import{B as Y,J as v}from"./index-b03d7914.js";import"./cron-parser-vendor-d9194a40.js";import{f as Z,u as D,s as ee}from"./check.rule.data-d06c210b.js";import{_ as te}from"./antd-vue-vendor-a78909e6.js";import{d as ae,e as se,u as m,k as d,V as S,a5 as re,a9 as oe,a7 as y,f as p,ag as le}from"./vue-bcbaddf9.js";const Re=ae({__name:"CheckRuleModal",emits:["register","success"],setup(o,{emit:s}){const t=se(()=>m(f)?"编辑":"新增"),f=d(!0),[b,{resetFields:V,setFieldsValue:x,validate:h,getFieldsValue:u}]=X({schemas:Z,showActionButtonGroup:!1}),c=d("1");let T=d([]),J=d([]);const[L,{setModalProps:w,closeModal:$}]=Y(e=>R(this,null,function*(){if(yield V(),w({confirmLoading:!1}),f.value=!!(e!=null&&e.isUpdate),c.value="1",T.value=[],J.value=[],m(f)){yield x(q({},e.record));let r=e.record.ruleJson;if(r){let l=JSON.parse(r),a=[],i=[],n="1";l.forEach(g=>{g.digits==="*"?a.push(Object.assign(g,{priority:n})):(n="0",i.push(g))}),T.value=i,J.value=a}}})),B=d(),C=d();function F(e,r){return new Promise((l,a)=>{e.value.validateTable().then(i=>{if(i)c.value=r,a();else{const n=e.value.getTableData();l(n)}})})}function A(){return R(this,null,function*(){let e,r=[],l=[];h().then(a=>(e=a,F(B,"1"))).then(a=>(a&&a.length>0&&(l=a),F(C,"2"))).then(a=>{a&&a.length>0&&(r=a);let i=[],n=[];for(let _=0;_<r.length;_++){let k=r[_];k.digits="*",k.priority==="1"?i.push(k):n.push(k)}let G=i.concat(l).concat(n).map(_=>te(_,"digits","pattern","message")),H=JSON.stringify(G),I=Object.assign({},e,{ruleJson:H});K(I)}).catch(()=>{w({confirmLoading:!1})})})}function K(e){return R(this,null,function*(){try{w({confirmLoading:!0}),f.value?yield D(e):yield ee(e),$(),s("success")}finally{w({confirmLoading:!1})}})}const M=({cellValue:e},r)=>{try{new RegExp(e),r(!0)}catch(l){r(!1,"请输入正确的正则表达式")}},P=d([{title:"位数",key:"digits",type:v.inputNumber,minWidth:180,validateRules:[{required:!0,message:"${title}不能为空"},{pattern:/^[1-9]\d*$/,message:"请输入零以上的正整数"}]},{title:"规则（正则表达式）",key:"pattern",minWidth:320,type:v.input,validateRules:[{required:!0,message:"规则不能为空"},{handler:M}]},{title:"提示文本",key:"message",minWidth:180,type:v.input,validateRules:[{required:!0,message:"${title}不能为空"}]}]),U=d([{title:"优先级",key:"priority",type:v.select,defaultValue:"1",options:[{title:"优先运行",value:"1"},{title:"最后运行",value:"0"}],validateRules:[]},{title:"规则（正则表达式）",key:"pattern",width:"40%",type:v.input,validateRules:[{required:!0,message:"规则不能为空"},{handler:M}]},{title:"提示文本",key:"message",width:"20%",type:v.input,validateRules:[{required:!0,message:"${title}不能为空"}]}]);return(e,r)=>{const l=S("a-alert"),a=S("JVxeTable"),i=S("a-tab-pane"),n=S("a-tabs");return re(),oe(m(z),le(e.$attrs,{onRegister:m(L),onOk:A,title:t.value,width:1200,destroyOnClose:""}),{default:y(()=>[p(m(Q),{onRegister:m(b)},null,8,["onRegister"]),p(n,{activeKey:c.value,"onUpdate:activeKey":r[0]||(r[0]=g=>c.value=g),animated:""},{default:y(()=>[p(i,{tab:"局部规则",key:"1",forceRender:!0},{default:y(()=>[p(a,{ref_key:"vTable1",ref:B,toolbar:"",rowNumber:"",dragSort:"",rowSelection:"",maxHeight:580,dataSource:m(T),columns:P.value},{toolbarAfter:y(()=>[p(l,{type:"info",showIcon:"",message:"局部规则按照你输入的位数有序的校验",style:{"margin-bottom":"8px"}})]),_:1},8,["dataSource","columns"])]),_:1}),p(i,{tab:"全局规则",key:"2",forceRender:!0},{default:y(()=>[p(a,{ref_key:"vTable2",ref:C,toolbar:"",rowNumber:"",dragSort:"",rowSelection:"",maxHeight:580,dataSource:m(J),addSetActive:!1,columns:U.value},{toolbarAfter:y(()=>[p(l,{type:"info",showIcon:"",message:"全局规则可校验用户输入的所有字符；全局规则的优先级比局部规则的要高。",style:{"margin-bottom":"8px"}})]),_:1},8,["dataSource","columns"])]),_:1})]),_:1},8,["activeKey"])]),_:1},16,["onRegister","title"])}}});export{Re as _};

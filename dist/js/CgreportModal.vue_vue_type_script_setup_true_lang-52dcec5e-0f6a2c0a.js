import{B as ne}from"./index-32f277d2.js";import{B as de}from"./BasicForm-002087c7.js";import"./componentMap-9abc9664.js";import{u as se}from"./useForm-e1f12926.js";import"./JAddInput-6b7ccad8.js";import"./JSelectUser-acf556b2.js";import"./JSelectDept-6809f298.js";import"./JPopup-65fb74cb.js";import{J as n,B as ue}from"./index-92811877.js";import"./cron-parser-vendor-f7d0e790.js";import{useJvxeMethod as ce}from"./useJvxeMethods-d85ec32d.js";import{d as pe}from"./user.api-d0443f37.js";import{b as x,u as U}from"./jeecg-online-vendor-00671d17.js";import{d as me,k as V,r as F,e as fe,u as y,V as k,a5 as O,a9 as R,a7 as b,f as v,aa as w,E as I,ag as ge}from"./vue-bcbaddf9.js";var he=Object.defineProperty,ye=Object.defineProperties,be=Object.getOwnPropertyDescriptors,D=Object.getOwnPropertySymbols,ve=Object.prototype.hasOwnProperty,xe=Object.prototype.propertyIsEnumerable,J=(t,l,a)=>l in t?he(t,l,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[l]=a,A=(t,l)=>{for(var a in l||(l={}))ve.call(l,a)&&J(t,a,l[a]);if(D)for(var a of D(l))xe.call(l,a)&&J(t,a,l[a]);return t},ke=(t,l)=>ye(t,be(l)),j=(t,l,a)=>new Promise((m,S)=>{var f=u=>{try{s(a.next(u))}catch(N){S(N)}},h=u=>{try{s(a.throw(u))}catch(N){S(N)}},s=u=>u.done?m(u.value):Promise.resolve(u.value).then(f,h);s((a=a.apply(t,l)).next())});const{createConfirm:we}=U(),Se="/online/cgreport/param/listByHeadId",Ce="/online/cgreport/item/listByHeadId",et=t=>x.get({url:"/online/cgreport/head/list",params:t}),tt=(t,l)=>x.delete({url:"/online/cgreport/head/delete",params:t},{joinParamsToUrl:!0}).then(()=>{l()}),lt=(t,l)=>{we({title:"确认删除",content:"是否删除选中数据",okText:"确认",cancelText:"取消",iconType:"warning",onOk:()=>x.delete({url:"/online/cgreport/head/deleteBatch",data:t},{joinParamsToUrl:!0}).then(()=>{l()})})},Pe=(t,l)=>l?x.put({url:"/online/cgreport/head/editAll",params:t}):x.post({url:"/online/cgreport/head/add",params:t}),at=t=>x.get({url:"/online/cgreport/api/getParamsInfo/"+t}),Ve=()=>x.get({url:"/sys/dataSource/options"}),Ie=t=>x.get({url:"/online/cgreport/head/parseSql?"+t}),rt=[{title:"报表名字",align:"center",dataIndex:"name",width:120},{title:"报表编码",align:"center",dataIndex:"code",width:120},{title:"报表SQL",align:"center",dataIndex:"cgrSql",width:360},{title:"数据源",align:"center",dataIndex:"dbSource",width:120},{title:"创建时间",align:"center",dataIndex:"createTime",width:120}],ot=[{label:"报表名称",field:"name",component:"JInput"},{label:"报表编码",field:"code",component:"JInput"}],Ne=/^[a-z|A-Z][a-z|A-Z|\d|_|-]{0,}$/,$e=[{label:"",field:"id",component:"Input",show:!1},{label:"报表编码",field:"code",component:"Input",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},dynamicRules:({values:t,model:l})=>[{required:!0,validator:(a,m)=>new Promise((S,f)=>{if(!m)return f("请输入报表编码！");if(!Ne.test(m))return f("编码必须以字母开头，可包含数字、下划线、横杠！");let h={tableName:"onl_cgreport_head",fieldName:"code",fieldVal:m,dataId:l.id};pe(h).then(s=>{s.success?S():f("报表编码已存在!")}).catch(s=>{f(s.message||"校验失败")})})}]},{label:"报表名字",field:"name",component:"Input",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},dynamicRules:()=>[{required:!0,message:"请输入报表名字!"}]},{label:"动态数据源",field:"dbSource",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},component:"ApiSelect",componentProps:{api:Ve}},{label:"报表SQL",field:"cgrSql",component:"JCodeEditor",rules:[{required:!0,message:"请填写报表SQL"}],itemProps:{labelCol:{xs:24,sm:2},wrapperCol:{xs:24,sm:22}},componentProps:{height:"200px",fullScreen:!0},colProps:{span:20}},{label:" ",field:"analyseButton",component:"Input",slot:"analyseButton",colProps:{span:4},itemProps:{labelCol:{xs:1,sm:1},wrapperCol:{xs:23,sm:23},colon:!1}}],_e=[{title:"参数字段",key:"paramName",type:n.input,width:"200px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"参数文本",key:"paramTxt",type:n.input,width:"200px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"参数默认值",key:"paramValue",type:n.input,width:"200px",placeholder:"请输入${title}",defaultValue:""}],qe=[{title:"字段名字",key:"fieldName",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"字段文本",key:"fieldTxt",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"字段类型",key:"fieldType",minWidth:"150px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}],type:n.select,options:[{title:"数值类型",value:"Integer"},{title:"字符类型",value:"String"},{title:"日期类型",value:"Date"},{title:"时间类型",value:"Datetime"},{title:"长整型",value:"Long"}]},{title:"是否显示",key:"isShow",minWidth:"80px",align:"center",type:n.checkbox,customValue:[1,0],defaultChecked:!0},{title:"字段href",key:"fieldHref",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"查询模式",key:"searchMode",type:n.select,minWidth:"150px",placeholder:"请选择${title}",options:[{title:"单条件查询",value:"single"},{title:"范围查询",value:"group"}]},{title:"取值表达式",key:"replaceVal",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"字典code",key:"dictCode",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"分组标题",key:"groupTitle",type:n.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"是否查询",key:"isSearch",type:n.checkbox,customValue:["1","0"],minWidth:"80px",align:"center",defaultChecked:!1},{title:"是否合计",align:"center",key:"isTotal",type:n.checkbox,customValue:["1","0"],minWidth:"80px",defaultChecked:!1}],Be={style:{flex:"1","text-align":"left"}},Le=w("br",null,null,-1),Te=w("br",null,null,-1),Oe=w("br",null,null,-1),Re=w("br",null,null,-1),je=w("br",null,null,-1),We=w("span",{style:{color:"red"}},"注：参数只支持动态报表，popup暂不支持",-1),it=me({__name:"CgreportModal",emits:["register","success"],setup(t,{emit:l}){const{createMessage:a}=U(),m=V(!0),S=V(!0),f=V(["onlCgreportItem","onlCgreportParam"]),h=V("onlCgreportItem"),s=V(),u=V(),N={onlCgreportItem:u,onlCgreportParam:s},C=F({loading:!1,dataSource:[],columns:_e}),P=F({loading:!1,dataSource:[],columns:qe}),[H,{setProps:Q,resetFields:Z,setFieldsValue:z,validate:Me,validateFields:E}]=se({schemas:$e,showActionButtonGroup:!1}),[G,{setModalProps:$,closeModal:K}]=ue(e=>j(this,null,function*(){var r,o;yield le(),$({confirmLoading:!1,showCancelBtn:e==null?void 0:e.showFooter,showOkBtn:e==null?void 0:e.showFooter}),m.value=!!(e!=null&&e.isUpdate),y(m)&&(yield z(A({},e.record)),W(Se,{headId:(r=e==null?void 0:e.record)==null?void 0:r.id},C),W(Ce,{headId:(o=e==null?void 0:e.record)==null?void 0:o.id},P)),Q({disabled:!(e!=null&&e.showFooter)})})),[X,Y,W,ee]=ce(re,ae,N,h,f),te=fe(()=>y(m)?"编辑":"新增");function le(){return j(this,null,function*(){yield Z(),h.value="onlCgreportItem",C.dataSource=[],P.dataSource=[]})}function ae(e){let r=Object.assign({},e.formValue);return ke(A({},r),{onlCgreportParamList:e.tablesValue[1].tableData,onlCgreportItemList:e.tablesValue[0].tableData})}function re(e){return j(this,null,function*(){try{$({confirmLoading:!0});let r=[],o=[],d={};Object.keys(e).map(i=>{i=="onlCgreportItemList"?o=e[i]:i=="onlCgreportParamList"?r=e[i]:d[i]=e[i]}),yield Pe({head:d,params:r,items:o},m.value),K(),l("success")}finally{$({confirmLoading:!1})}})}function oe(){$({confirmLoading:!0}),E(["cgrSql","dbSource"]).then(e=>{let{cgrSql:r,dbSource:o}=e,d="sql="+encodeURIComponent(r);o&&(d+="&dbKey="+o),Ie(d).then(c=>{if(c){a.success("解析成功");let{fields:i,params:p}=c,g=i.filter(q=>q.fieldName!="__row_number__"),B=u.value.getTableData(),_=M(B,g||[],"fieldName");_=_.sort((q,T)=>q.orderNum-T.orderNum),P.dataSource=_;let ie=s.value.getTableData(),L=M(ie,p||[],"paramName");L=L.sort((q,T)=>q.orderNum-T.orderNum),C.dataSource=L}})}).catch(()=>{}).finally(()=>{$({confirmLoading:!1})})}function M(e,r,o){if(e.length>0){let d=[],c=[],i=1;for(let p of r)for(let g of e)if(g[o]==p[o]){d.push(g),c.push(p[o]),g.orderNum>i&&(i=g.orderNum);break}for(let p of r)c.indexOf(p[o])<0&&(p.orderNum=++i,d.push(p));return d}else{let d=0;for(let c of r)c.orderNum||(c.orderNum=++d);return r}}return(e,r)=>{const o=k("a-icon"),d=k("a-popover"),c=k("a-button"),i=k("a-divider"),p=k("JVxeTable"),g=k("a-tab-pane"),B=k("a-tabs");return O(),R(y(ne),ge(e.$attrs,{onRegister:y(G),title:te.value,width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:S.value,onOk:y(Y)}),{default:b(()=>[v(y(de),{onRegister:y(H),ref_key:"formRef",ref:ee},{analyseButton:b(()=>[w("div",Be,[v(d,{title:"使用指南",trigger:"hover",style:{margin:"0 10px 0 6px"}},{content:b(()=>[I(" 您可以键入“”作为一个参数，这里abc是参数的名称。例如："),Le,I(" select * from table where id = ${abc}。"),Te,I(" select * from table where id like concat('%',${abc},'%')。(mysql模糊查询)"),Oe,I(" select * from table where id like '%'||${abc}||'%'。(oracle模糊查询)"),Re,I(" select * from table where id like '%'+${abc}+'%'。(sqlserver模糊查询)"),je,We]),default:b(()=>[v(o,{type:"question-circle"})]),_:1}),v(c,{style:{"margin-left":"10px"},type:"primary",onClick:oe},{default:b(()=>[I("SQL解析")]),_:1})])]),_:1},8,["onRegister"]),v(i,{style:{margin:"1px 0"},class:"cust-divider"}),v(B,{activeKey:h.value,"onUpdate:activeKey":r[0]||(r[0]=_=>h.value=_),animated:"",onChange:y(X)},{default:b(()=>[(O(),R(g,{tab:"动态报表配置明细",key:f.value[0],forceRender:!0},{default:b(()=>[v(p,{"keep-source":"",dragSort:"",resizable:"",ref_key:"onlCgreportItem",ref:u,loading:P.loading,columns:P.columns,dataSource:P.dataSource,height:390,rowNumber:!0,rowSelection:!0,toolbar:!0},null,8,["loading","columns","dataSource"])]),_:1})),(O(),R(g,{tab:"报表参数",key:f.value[1],forceRender:!0},{default:b(()=>[v(p,{"keep-source":"",resizable:"",dragSort:"",ref_key:"onlCgreportParam",ref:s,loading:C.loading,columns:C.columns,dataSource:C.dataSource,height:390,rowNumber:!0,rowSelection:!0,toolbar:!0},null,8,["loading","columns","dataSource"])]),_:1}))]),_:1},8,["activeKey","onChange"])]),_:1},16,["onRegister","title","confirmLoading","onOk"])}}});export{lt as G,at as X,rt as Y,tt as Z,ot as e,et as j,it as t};

import{I as qe,A as Ke,E as Ue,q as xe,G as He}from"./index-6916e394.js";import{B as Ge}from"./index-a882524d.js";import{B as Ye}from"./BasicForm-030e7c21.js";import"./componentMap-90ab712d.js";import{u as ze}from"./useForm-ae9e1cbd.js";import"./JAddInput-dff0b84f.js";import{ad as v,bW as We,c2 as L,l as Xe}from"./jeecg-online-vendor-12004772.js";import{u as Ze}from"./useSchemas-fa1fd633.js";import et from"./DBAttributeTable-be36359a.js";import tt from"./PageAttributeTable-75c26f74.js";import at from"./CheckDictTable-2cbb3549.js";import lt from"./ForeignKeyTable-306c9e9b.js";import ot from"./IndexTable-25d77c74.js";import nt from"./QueryTable-cd07dd4b.js";import it from"./ExtendConfigModal-2d6e4987.js";import{u as rt,E as st,a as ut,V as w}from"./cgform.data-778ca3fc.js";import{u as dt}from"./useOnlineTest-c069fd87.js";import{g as ct}from"./useExtendComponent-840bfd85.js";import{d as ft,k as g,e as ee,p as te,r as bt,n as G,U as f,aV as I,ar as Y,bi as d,f as r,E as k,as as ae,F as mt,a_ as pt,ag as Tt,V as le,at as oe,aQ as gt,J as yt}from"./vue-c7e3516e.js";import"./lodash-es-vendor-42c8d3d4.js";import"./antd-vue-vendor-1561c1ba.js";import"./tinymce-vendor-40778af9.js";import"./codemirror-vendor-96aab763.js";import"./echarts-vendor-b30c7238.js";import"./html2canvas-vendor-654dcb8a.js";import"./vxe-table-vendor-8bace23a.js";import"./BasicModal-b901e352.js";import"./useWindowSizeFn-581ed1a8.js";import"./BasicForm.vue_vue_type_style_index_0_lang-8cb333b2.js";import"./useFormItem-cc50e63d.js";import"./JUpload.vue_vue_type_style_index_0_lang-5851070a.js";import"./download-fc124faf.js";import"./base64Conver-4e359726.js";import"./index-d83c9bcd.js";import"./index-6d615beb.js";import"./useCountdown-61c82faf.js";import"./index-fcc2460e.js";import"./areaDataUtil-13d415af.js";import"./useSelectBiz-f95680cd.js";import"./props-18305405.js";import"./index-3ce15f67.js";import"./bem-2be191b9.js";import"./props-c3781b9d.js";import"./useContextMenu-1b1215cd.js";import"./useTreeBiz-cda2af6e.js";import"./index-c5567c31.js";import"./depart.api-de6ffddd.js";import"./validator-a64fcad8.js";import"./user.api-ea86029c.js";import"./useTableSync-cd191450.js";import"./pick-51214243.js";import"./_flatRest-34ab130c.js";import"./isArray-b183d537.js";import"./toString-8deea73b.js";import"./_arrayPush-ae8b790e.js";import"./LinkTableConfigModal-aad5b48c.js";import"./omit-13df237f.js";import"./_baseClone-632ebf1c.js";import"./_baseSlice-834c0c3e.js";import"./LinkTableFieldConfigModal-6a2ecd36.js";import"./FieldExtendJsonModal-61477e5a.js";import"./JUploadModal.vue_vue_type_script_setup_true_lang-88479361.js";import"./_commonjsHelpers-938fab4e.js";import"./customExpression-e22f3cce.js";import"./BasicTable-04058a09.js";import"./BasicTable.vue_vue_type_style_index_0_lang-3c8b8bcc.js";import"./injectionKey-5da932b3.js";import"./useTable-7c8820b4.js";import"./useListPage-8d85dabf.js";import"./LinkTableListPiece-ee383d81.js";import"./OnlineSelectCascade-96168c23.js";import"./JModalTip-2822aa1b.js";var vt=Object.defineProperty,ht=Object.defineProperties,Ft=Object.getOwnPropertyDescriptors,ne=Object.getOwnPropertySymbols,Ct=Object.prototype.hasOwnProperty,_t=Object.prototype.propertyIsEnumerable,ie=(t,o,c)=>o in t?vt(t,o,{enumerable:!0,configurable:!0,writable:!0,value:c}):t[o]=c,V=(t,o)=>{for(var c in o||(o={}))Ct.call(o,c)&&ie(t,c,o[c]);if(ne)for(var c of ne(o))_t.call(o,c)&&ie(t,c,o[c]);return t},Dt=(t,o)=>ht(t,Ft(o)),_=(t,o,c)=>new Promise((R,F)=>{var b=m=>{try{C(c.next(m))}catch(p){F(p)}},D=m=>{try{C(c.throw(m))}catch(p){F(p)}},C=m=>m.done?R(m.value):Promise.resolve(m.value).then(b,D);C((c=c.apply(t,o)).next())});const Ya=t=>v.get({url:"/online/cgform/head/list",params:t}),za=t=>re(t,0),Wa=t=>v.delete({url:"/online/cgform/head/removeRecord",params:{id:t}},{joinParamsToUrl:!0}),Xa=t=>re(t,1),Za=t=>v.delete({url:"/online/cgform/head/delete",params:{id:t}},{joinParamsToUrl:!0});function re(t,o){return v.delete({url:"/online/cgform/head/deleteBatch",params:{ids:t.join(","),flag:o}},{joinParamsToUrl:!0})}const el=(t,o)=>v.post({url:`/online/cgform/api/doDbSynch/${t}/${o}`,timeout:12e3,timeoutErrorMessage:"\u540C\u6B65\u6570\u636E\u5E93\u8D85\u65F6\uFF0C\u5DF2\u81EA\u52A8\u5237\u65B0"}),tl=t=>v.post({url:`/online/cgform/head/copyOnline?code=${t}`}),al=(t,o,c)=>v.get({url:`/online/cgform/head/copyOnlineTable/${t}`,params:V({tableName:o},c)}),J={doQueryField:(t,o)=>v.get({url:"/online/cgform/field/listByHeadId",params:V({headId:t},o)}),doQueryIndexes:(t,o)=>v.get({url:"/online/cgform/index/listByHeadId",params:V({headId:t},o)}),doSaveOrUpdate:(t,o)=>o?v.put({url:"/online/cgform/api/editAll",params:t}):v.post({url:"/online/cgform/api/addAll",params:t}),editHead:t=>v.put({url:"/online/cgform/head/edit",params:t})},Bt=ft({name:"CgformModal",components:{BasicModal:Ge,BasicForm:Ye,DBAttributeTable:et,PageAttributeTable:tt,CheckDictTable:at,ForeignKeyTable:lt,IndexTable:ot,QueryTable:nt,ExtendConfigModal:it,Icon:qe},emits:["success","register"],props:{actionButton:{type:Boolean,default:!0,required:!1}},setup(t,{emit:o}){const{createMessage:c}=Xe(),R=g(),F=g(!1);let b={};const D=ee(()=>F.value?"\u7F16\u8F91":"\u65B0\u589E"),C=g(!0),m=g(!1),p=g("dbTable"),E=g(!0),u={dbTable:g(),pageTable:g(),checkTable:g(),fkTable:g(),idxTable:g(),queryTable:g()},$=ee(()=>{var e,a;return(a=(e=R.value)==null?void 0:e.fullScreenRef)!=null?a:!1});te("tables",u),te("fullScreenRef",$);const{formSchemas:Q}=Ze(t,{onTableTypeChange:he,onIsTreeChange:Fe,ifShowOfSubTableStr:()=>z}),[q,A]=ze({schemas:Q,showActionButtonGroup:!1,labelAlign:"right"}),{resetFields:K,setFieldsValue:S,validate:P}=A,[U,{closeModal:x}]=Ke(e=>{var a;F.value=(a=e==null?void 0:e.isUpdate)!=null?a:!1,F.value?W(e==null?void 0:e.record):me()}),N=g("");let y=bt({});const h=He(()=>Ce(),150);let M=[],z=!1,j=!1,B=[];const{aiTestMode:se,aiTestTable:ue,aiTableList:de,initVirtualData:ce,tableJsonGetHelper:fe,refreshCacheTableName:be}=dt();function me(){W({})}function W(e){return _(this,null,function*(){var a;if(C.value=!1,p.value="dbTable",yield K(),b=Object.assign({},e),ye(b),fe(b),ge(b),S(b),N.value=b.tableName,L(1,()=>E.value=!1),F.value)(a=u.dbTable.value)==null||a.setDataSource([]),yield pe(b.id),yield Te(b.id),ct(u.pageTable).then(()=>{u.pageTable.value.changePageType(b.tableType==3)});else{let{initialData:l,tempIds:n}=rt();yield X(l,!0),M=n}})}function pe(e){return _(this,null,function*(){m.value=!0;try{let a=yield J.doQueryField(e);m.value=!1,yield X(a)}finally{m.value=!1}})}function Te(e){return _(this,null,function*(){let a=yield J.doQueryIndexes(e);u.idxTable.value.setDataSource(a)})}function ge(e){let a={};if(e.extConfigJson)try{a=JSON.parse(e.extConfigJson)}catch(l){}y=Object.assign({},st,a,{isDesForm:e.isDesForm||"N",desFormCode:e.desFormCode||""})}function ye(e){j=e.isTree=="Y",z=e.tableType===2}function X(e,a){return _(this,null,function*(){const{dbTable:l,pageTable:n,checkTable:s,fkTable:i,queryTable:T}=u;l.value||(yield G(),yield L(1)),l.value.setDataSource(e,a),setTimeout(()=>{n.value.setDataSource(e,a),s.value.setDataSource(e,a),i.value.setDataSource(e,a),T.value.setDataSource(e,a)},10)})}function ve(e){if(["pageTable","checkTable","fkTable","idxTable","queryTable"].indexOf(e)!==-1){const a=u.dbTable,l=u[e];a.value.tableRef.resetScrollTop(),l.value.syncTable(a)}}function he(e){e===1&&S({themeTemplate:"normal"}),u.pageTable.value.changePageType(e==3)}function Fe(e){e==="Y"?Oe():we()}function H(){h()}function Ce(){return _(this,null,function*(){let{dbTable:e,pageTable:a,checkTable:l,fkTable:n,queryTable:s}=u;yield a.value.syncTable(e),yield l.value.syncTable(e),yield n.value.syncTable(e),yield s.value.syncTable(e)})}function _e(){H()}function De(){H()}function Be(e){let{oldIndex:a,newIndex:l}=e;Re(a,l)}function ke(e){return _(this,null,function*(){let{insertIndex:a,row:l}=e,{pageTable:n,checkTable:s,fkTable:i,queryTable:T}=u;n.value.tableRef.insertRows(l,a),s.value.tableRef.insertRows(l,a),i.value.tableRef.insertRows(l,a),T.value.tableRef.insertRows(l,a)})}function Re(e,a){let{pageTable:l,checkTable:n,fkTable:s,queryTable:i}=u;l.value.tableRef.rowResort(e,a),n.value.tableRef.rowResort(e,a),s.value.tableRef.rowResort(e,a),i.value.tableRef.rowResort(e,a)}function Ee(e){u.pageTable.value.syncFieldShowType(e.row)}function Ae(e){u.pageTable.value.enableQuery(e)}function Oe(){if(!j){let{dbTable:e,pageTable:a,checkTable:l}=u,n=ut();n=n.filter(s=>!e.value.tableRef.getTableData().map(T=>T.dbFieldName).includes(s.dbFieldName)),B=[],n.forEach(s=>{let i=xe()+"__tempId";B.push(i),s.id=i}),e.value.tableRef.addRows(n,{setActive:!1}),a.value.tableRef.addRows(n,{setActive:!1}),l.value.tableRef.addRows(n,{setActive:!1}),G(()=>H()),j=!0}G(()=>{A.setFieldsValue({treeIdField:"has_child",treeParentIdField:"pid"})})}function we(){if(B&&B.length>0){let{dbTable:e}=u;e.value.tableDeleteLines(B),B=[],j=!1}}function Ie(){let e={};return new Promise((a,l)=>{P().then(n=>a({values:n}),()=>l(w))}).then(a=>(Object.assign(e,a),Se())).then(a=>{Object.assign(e,a);let l=Pe(e);return Ne(l)}).catch(a=>((a===w||(a==null?void 0:a.code)===w)&&c.warning("\u6821\u9A8C\u672A\u901A\u8FC7"),Promise.reject(null)))}function Se(){return new Promise((e,a)=>_(this,null,function*(){let l=Object.keys(u),n={};for(let s=0;s<l.length;s++){let i=l[s],T=u[i];try{n[i]=yield T.value.validateData(i)}catch(O){O.code===w&&(p.value=O.activeKey),a(O);return}}e(n)}))}function Pe(e){let a={head:{},fields:[],indexs:[],deleteFieldIds:[],deleteIndexIds:[]};return a.head=Object.assign(b,e.values),a.head.isDesForm=y.isDesForm,a.head.desFormCode=y.desFormCode,delete y.isDesForm,delete y.desFormCode,a.head.extConfigJson=JSON.stringify(y),e.dbTable.tableData.forEach((l,n)=>{let s=l.id,i=Object.assign({},l),T=e.pageTable.tableData[n];i=Object.assign(T,i);let O=e.checkTable.tableData[n];i=Object.assign(O,i);let $e=e.fkTable.tableData[n];i=Object.assign($e,i);let Qe=e.queryTable.tableData[n];i=Object.assign(Qe,i),s==null||s===""?delete i.id:i.id=s,[].concat(M,B).includes(i.id)&&delete i.id,a.fields.push(i)}),a.deleteFieldIds=e.dbTable.deleteIds,a.indexs=e.idxTable.tableData,a.deleteIndexIds=e.idxTable.deleteIds,a}function Ne(e){return new Promise((a,l)=>{let n=e.fields,s=!0;if(n&&n.length>0){let i=0;for(let T=0;T<n.length;T++)if((n[T].mainField||n[T].mainTable)&&(i+=1),i>1){s=!1;break}}s?a(e):l({code:-1,msg:"\u5916\u952E\u53EA\u5141\u8BB8\u914D\u7F6E\u4E00\u4E2A!",error:w})})}function Me(){C.value=!0,Ie().then(e=>_(this,null,function*(){var a;if(e.fields&&e.fields.length>0)for(let l of e.fields)l.dbFieldName=l.dbFieldName.toLowerCase().trim();(a=e.head)!=null&&a.tableName&&(e.head.tableName=e.head.tableName.toLowerCase().trim()),yield J.doSaveOrUpdate(e,F.value),be(N.value,e.head.tableName),o("success"),L(1,()=>Z())}),e=>{}).finally(()=>{C.value=!1})}const[je,Le]=Ue();function Je(e){return _(this,null,function*(){if(y=e,F.value==!0){let a=yt(y);const l={id:b.id,extConfigJson:JSON.stringify(a)};yield J.editHead(l),o("success")}})}function Ve(){Le.openModal(!0,{extConfigJson:y})}function Z(){E.value=!0,L(1,()=>x())}return Dt(V({},u),{modalRef:R,title:D,confirmLoading:C,tableLoading:m,activeKey:p,onCancel:Z,extConfigJson:y,formAction:A,hideTabs:E,onSubmit:Me,onTabsChange:ve,onTableAdded:_e,onTableRemoved:De,onTableDragged:Be,onTableInserted:ke,onTableSyncDbType:Ee,onTableQuery:Ae,onOpenExtConfig:Ve,onExtConfigOk:Je,registerForm:q,registerModal:U,registerExtendConfigModal:je,aiTestMode:se,aiTestTable:ue,aiTableList:de,initVirtualData:ce})}}),kt={style:{flex:"1","text-align":"right"}},Rt={key:0,style:{display:"inline-block","text-align":"left",position:"absolute",left:"0"}};function Et(t,o,c,R,F,b){const D=f("a-button"),C=f("BasicForm"),m=f("DBAttributeTable"),p=f("a-tab-pane"),E=f("PageAttributeTable"),u=f("CheckDictTable"),$=f("ForeignKeyTable"),Q=f("IndexTable"),q=f("Icon"),A=f("a-tooltip"),K=f("QueryTable"),S=f("a-tabs"),P=f("a-spin"),U=f("a-select-option"),x=f("a-select"),N=f("ExtendConfigModal"),y=f("BasicModal");return I(),Y(y,gt({ref:"modalRef",title:t.title,width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:t.confirmLoading},t.$attrs,{onCancel:t.onCancel,onRegister:t.registerModal}),{footer:d(()=>[r(D,{onClick:t.onCancel},{default:d(()=>[k("\u5173\u95ED")]),_:1},8,["onClick"]),r(D,{type:"primary",loading:t.confirmLoading,preIcon:"ant-design:save",onClick:t.onSubmit},{default:d(()=>[k("\u4FDD\u5B58")]),_:1},8,["loading","onClick"]),t.aiTestMode?(I(),ae("div",Rt,[r(x,{value:t.aiTestTable,"onUpdate:value":o[1]||(o[1]=h=>t.aiTestTable=h),placeholder:"\u8BF7\u9009\u62E9\u6D4B\u8BD5\u7684\u8868\u7C7B\u578B",getPopupContainer:h=>h.parentElement,style:{width:"250px",margin:"0 10px 0 20px"}},{default:d(()=>[(I(!0),ae(mt,null,pt(t.aiTableList,(h,M)=>(I(),Y(U,{key:M,value:h.name},{default:d(()=>[k(Tt(h.title+"\uFF08"+h.name+"\uFF09"),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","getPopupContainer"]),r(D,{type:"primary",ghost:"",onClick:t.initVirtualData},{default:d(()=>[k("\u751F\u6210\u6570\u636E>>")]),_:1},8,["onClick"])])):le("",!0)]),default:d(()=>[r(P,{wrapperClassName:"p-2",spinning:t.confirmLoading},{default:d(()=>[r(C,{onRegister:t.registerForm},{extConfigButton:d(()=>[oe("div",kt,[r(D,{preIcon:"ant-design:setting",onClick:t.onOpenExtConfig},{default:d(()=>[k("\u6269\u5C55\u914D\u7F6E")]),_:1},8,["onClick"])])]),_:1},8,["onRegister"]),r(P,{spinning:t.tableLoading||t.hideTabs},{default:d(()=>[t.hideTabs?le("",!0):(I(),Y(S,{key:0,activeKey:t.activeKey,"onUpdate:activeKey":o[0]||(o[0]=h=>t.activeKey=h),animated:"",onChange:t.onTabsChange},{default:d(()=>[r(p,{tab:"\u6570\u636E\u5E93\u5C5E\u6027",key:"dbTable",forceRender:""},{default:d(()=>[r(m,{ref:"dbTable",actionButton:t.actionButton,onAdded:t.onTableAdded,onRemoved:t.onTableRemoved,onDragged:t.onTableDragged,onInserted:t.onTableInserted,onSyncDbType:t.onTableSyncDbType},null,8,["actionButton","onAdded","onRemoved","onDragged","onInserted","onSyncDbType"])]),_:1}),r(p,{tab:"\u9875\u9762\u5C5E\u6027",key:"pageTable",forceRender:""},{default:d(()=>[r(E,{ref:"pageTable"},null,512)]),_:1}),r(p,{tab:"\u6821\u9A8C\u5B57\u6BB5",key:"checkTable",forceRender:""},{default:d(()=>[r(u,{ref:"checkTable"},null,512)]),_:1}),r(p,{tab:"\u5916\u952E",key:"fkTable",forceRender:""},{default:d(()=>[r($,{ref:"fkTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(p,{tab:"\u7D22\u5F15",key:"idxTable",forceRender:""},{default:d(()=>[r(Q,{ref:"idxTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(p,{key:"queryTable",forceRender:""},{tab:d(()=>[oe("span",null,[k(" \u4E2A\u6027\u67E5\u8BE2\u914D\u7F6E "),r(A,null,{title:d(()=>[k("\u5141\u8BB8\u81EA\u5B9A\u4E49\uFF0C\u67E5\u8BE2\u8868\u5355\u5B57\u6BB5\u63A7\u4EF6\u7C7B\u578B\uFF01")]),default:d(()=>[r(q,{icon:"bx:help-circle"})]),_:1})])]),default:d(()=>[r(K,{ref:"queryTable",onQuery:t.onTableQuery},null,8,["onQuery"])]),_:1})]),_:1},8,["activeKey","onChange"]))]),_:1},8,["spinning"])]),_:1},8,["spinning"]),r(N,{onRegister:t.registerExtendConfigModal,parentForm:t.formAction,onOk:t.onExtConfigOk},null,8,["onRegister","parentForm","onOk"])]),_:1},16,["title","confirmLoading","onCancel","onRegister"])}var At=We(Bt,[["render",Et]]),ll=Object.freeze(Object.defineProperty({__proto__:null,default:At},Symbol.toStringTag,{value:"Module"}));export{At as C,Za as a,Wa as b,za as c,tl as d,Xa as e,el as f,al as g,ll as h,Ya as l};

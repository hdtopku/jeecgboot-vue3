import{bG as yt,bH as vt,bI as Ft,bJ as St,q as Tt,ap as ee,bF as kt,ao as wt,bD as Ot,bB as Pt}from"./jeecg-online-vendor-bc5d810e.js";import{U as Ct,l as h,c as xt,r as Rt,u as ge,n as ye,J as V,e as Dt,V as F,a7 as w,a8 as _,f as P,W as U,ac as L,aa as $,F as Mt,ab as Vt,aq as jt,R as At}from"./vue-86253b15.js";import"./index-2b71c6a1.js";import{O as Et,a as _t,b as $t,c as It,d as Bt,l as q,g as Jt,V as I,S as Nt,e as Kt,f as ve}from"./useExtendComponent-48d37d9b-6b127188.js";import"./lodash-es-vendor-04a44d0a.js";import{aI as Ut,aJ as Lt,F as qt}from"./index-4de4eaa0.js";import{da as Ht,db as Wt,cl as zt,p as Gt,o as Fe}from"./antd-vue-vendor-371529c2.js";import"./index-5f3b36bb.js";import{e as te}from"./constant-fe20103a-44089532.js";import{B as Qt,u as Xt}from"./useForm-61401b42.js";import"./tinymce-vendor-7c917b36.js";import"./vxe-table-vendor-6a8d95c4.js";import"./componentMap-804f169d.js";import"./useFormItem-48d9339b.js";import"./codemirror-vendor-9b2dceac.js";import"./echarts-vendor-ba343549.js";import"./index-7eb57de2.js";import"./BasicModal-8033a6fa.js";import"./useWindowSizeFn-0b39b13a.js";import"./download-dda5b956.js";import"./base64Conver-fa2fe1af.js";import"./index-c842bec9.js";import"./index-f5da07b2.js";import"./useCountdown-7a164eb2.js";import"./useFormItemSingle-1ae794f9.js";import"./JAddInput-eb55e093.js";import"./areaDataUtil-c66543dc.js";import"./JSelectUser-43c751df.js";import"./props-edbd03b5.js";import"./JSelectBiz-4759b897.js";import"./index-6c9d1f87.js";import"./index-6021b022.js";import"./bem-6904c165.js";import"./props-3eac2fce.js";import"./useContextMenu-368c1b38.js";import"./depart.api-b7cb4c93.js";import"./JSelectDept-1fac1b66.js";import"./JPopup-1441d476.js";import"./cron-parser-vendor-8edbe50a.js";import"./JEllipsis-08edf142.js";import"./JUpload-5d01fa2e.js";import"./index-8967d44c.js";import"./index-d90d28d1.js";import"./index-074f8af6.js";import"./user.api-26c541a7.js";import"./customExpression-62f5afd1.js";import"./index-4e790dc8.js";import"./BasicTable-c5288ffa.js";import"./injectionKey-69710956.js";import"./useListPage-6cefed71.js";import"./LinkTableListPiece-34266919-a0ea3d74.js";import"./OnlineSelectCascade-c7baf52b-df6d9a07.js";import"./JModalTip-abe1515a-86febb51.js";var Yt=Object.defineProperty,Se=Object.getOwnPropertySymbols,Zt=Object.prototype.hasOwnProperty,eo=Object.prototype.propertyIsEnumerable,Te=(i,s,r)=>s in i?Yt(i,s,{enumerable:!0,configurable:!0,writable:!0,value:r}):i[s]=r,H=(i,s)=>{for(var r in s||(s={}))Zt.call(s,r)&&Te(i,r,s[r]);if(Se)for(var r of Se(s))eo.call(s,r)&&Te(i,r,s[r]);return i},C=(i,s,r)=>new Promise((a,k)=>{var S=m=>{try{f(r.next(m))}catch(c){k(c)}},b=m=>{try{f(r.throw(m))}catch(c){k(c)}},f=m=>m.done?a(m.value):Promise.resolve(m.value).then(S,b);f((r=r.apply(i,s)).next())});const to={vue:Ct,"@":{hooks:{useMessage:yt,useUserStore:vt},utils:{axios:Ft,cache:St}}};function oo(i,s){const r=Object.assign({},to,i);function a(b){if(b!=null&&b!=""){let f=b.toString().split("/"),m=r[f[0]];for(let c=1;c<f.length;c++)m=m[f[c]];return m}return null}function k(){}function S(b,f){let m="__export_"+Ut(6);if(f){const c=`return function (row, customImport, ${m}) {"use strict"; ${b}}`;new Function(c)().call(s,f,a,k)}else{const c=`return function (customImport, ${m}) {"use strict"; ${b}}`;new Function(c)().call(s,a,k)}}return{executeJsEnhanced:S}}const no=/(?:\/\*[\s\S]*?\*\/|\/\/.*?\r?\n|[^{])+\{([\s\S]*)\}$/,oe={optPre:"/online/cgform/api/form/",urlButtonAction:"/online/cgform/api/doButton"},lo={name:"OnlineForm",components:{BasicForm:Qt,Loading:Lt,OnlineSubForm:Et,PrinterOutlined:Ht,DiffOutlined:Wt,FormOutlined:zt,OnlinePopModal:_t},props:{id:{type:String,default:""},formTemplate:{type:Number,default:1},disabled:{type:Boolean,default:!1},isTree:{type:Boolean,default:!1},pidField:{type:String,default:""},submitTip:{type:Boolean,default:!0},modalClass:{type:String,default:""},themeTemplate:{type:String,default:""}},emits:["success","rendered"],setup(i,{emit:s}){const{createMessage:r}=Tt(),a=h(null),k=h(!0),S=h(!1),b=h(1),f=h(""),m=h(!1),c=h(!1),x=xt("foreignkey",{value:{}}),D=Rt({reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0}),{onlineFormContext:p,resetContext:W}=$t(),{formSchemas:j,defaultValueFields:M,changeDataIfArray2String:B,tableName:u,dbData:T,checkOnlyFieldValue:y,hasSubTable:ke,subTabInfo:A,refMap:z,subDataSource:J,baseColProps:we,createFormSchemas:Oe,linkDownList:co,fieldDisplayStatus:E}=It(i,a);let{EnhanceJS:d,initCgEnhanceJs:Pe}=Bt(p,!1);const{executeJsEnhanced:Ce}=oo({},p),[xe,{setProps:Re,validate:ne,resetFields:le,setFieldsValue:O,updateSchema:G,getFieldsValue:Q,scrollToField:De}]=Xt({schemas:j,showActionButtonGroup:!1,baseColProps:we}),ae=h(!1);function Me(){let e=i.disabled;ae.value=e,Re({disabled:e})}function Ve(e,t,o){return C(this,null,function*(){yield je(),f.value="",yield le(),T.value="";let n=ge(e);c.value=n,n?yield ie(t):ue(),ye(()=>{!n&&o&&O(o),Ae(),X("js","loaded"),Me()})})}function je(){return C(this,null,function*(){if(i.isTree===!0){let e=i.pidField,t=j.value;t&&t.length>0&&t.filter(o=>o.field===e).length>0&&(yield G({field:e,componentProps:{reload:new Date().getTime()}}))}})}function Ae(){if(ge(c)===!1){let e=V(M[u.value]);q(e,t=>{O(t)})}}function re(e,t){let o=V(M[e.key]);q(o,n=>{const{row:l,target:g}=t;let R=[{rowKey:l.id,values:H({},n)}];g.setValues(R)})}function ie(e){return C(this,null,function*(){let t=yield _e(e.id);T.value=Object.assign({},e,t);let o=Ee.value,n=Gt(t,...o);i.disabled&&Object.keys(n).map(l=>{!n[l]&&n[l]!==0&&n[l]!=="0"&&delete n[l]}),yield O(n),ue(t)})}function ue(e){e||(e={});let t=Object.keys(J.value);if(t&&t.length>0){let o={};for(let n of t)o[n]=e[n]||[];J.value=o}}let Ee=Dt(()=>{let e=j.value,t=[];for(let o of e)t.push(o.field);return t});function _e(e){let t=`${oe.optPre}${i.id}/${e}`;return new Promise((o,n)=>{ee.get({url:t},{isTransformResponse:!1}).then(l=>{l.success?o(l.result):(n(),r.warning(l.message))}).catch(()=>{n()})})}function $e(e){return C(this,null,function*(){b.value=e.head.tableType,u.value=e.head.tableName,k.value=e.head.tableType==1,Je(e.head.extConfigJson),Oe(e.schema.properties,e.schema.required,y),d=Pe(e.enhanceJs),s("rendered",D);let t=yield Jt(a);t.$formValueChange=(o,n,l)=>{ot(o,n),l&&O(l),Ie(o,n,l)},d&&d.setup&&me(d.setup)})}function Ie(e,t,o){p.changEvent(e,t,o)}function Be(e){p.addObject2Context("changEvent",e)}function Je(e){let t={reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0};e&&(t=JSON.parse(e)),Object.keys(t).map(o=>{D[o]=t[o]})}function Ne(){k.value===!0?He():Ke()}function Ke(){Ue().then(e=>{se(e)})}function Ue(){let e={};return new Promise((t,o)=>{ne().then(n=>t(n),({errorFields:n})=>{n&&n.length>0&&De(n[0][0]),o(I)})}).then(t=>(Object.assign(e,B(t)),i.themeTemplate===te?Promise.resolve({}):qe())).then(t=>(Object.assign(e,t),Promise.resolve(e))).catch(t=>((t===I||(t==null?void 0:t.code)===I)&&(r.warning("校验未通过"),t.key&&Le(t.key)),Promise.reject(null)))}function Le(e){let t=A.value;for(let o=0;o<t.length;o++)if(e==t[o].key){let n=o+"";if(N.value===n)break;if(N.value=n,t[o].relationType===0){let l=v(e);kt(300,()=>l==null?void 0:l.validateTable())}break}}function qe(){return new Promise((e,t)=>C(this,null,function*(){let o={};try{let n=A.value;for(let l=0;l<n.length;l++){let g=n[l].key,R=v(g);if(n[l].relationType==1)try{let K=yield R.getAll();o[g]=[],o[g].push(K)}catch(K){throw{code:I,key:g}}else{if(yield R.fullValidateTable())throw{code:I,key:g};o[g]=R.getTableData()}}}catch(n){t(n)}e(o)}))}function He(){return C(this,null,function*(){try{let e=yield ne();e=Object.assign({},T.value,e),e=B(e),S.value=!0,se(e)}finally{S.value=!1}})}function se(e){at(he,e).then(()=>{We(e)}).catch(t=>{r.warning(t)})}function We(e){Object.keys(e).map(l=>{Array.isArray(e[l])&&e[l].length==0&&(e[l]="")});let t=f.value,o=`${oe.optPre}${i.id}?tabletype=${b.value}`;t&&(o=`${t}?tabletype=${b.value}`),m.value===!0&&(e[Nt]=1),x.value.field&&x.value.value&&(e[x.value.field]=x.value.value);let n=c.value===!0?"put":"post";ee.request({url:o,method:n,params:e},{isTransformResponse:!1}).then(l=>{l.success?(l.result&&(e[Kt]=l.result),s("success",e),i.submitTip===!0&&r.success(l.message)):r.warning(l.message)}).finally(()=>{S.value=!1})}function ze(e,t,o){t&&o?o.vxeProps?o.setValues([{rowKey:t,values:e}]):o.setValues(e):O(e)}function Ge(e,t){let o={};o[e]=t,O(o)}const N=h("0"),de=h(300),ce=h(340);function Qe(e){if(c.value===!0){let t=T.value;return Xe(t,e)}return""}function Xe(e,t){if(e){let o=e[t];return!o&&o!==0&&(o=e[t.toLowerCase()],!o&&o!==0&&(o=e[t.toUpperCase()])),o}return""}function Ye(e,t){if(d&&d[t+"_onlChange"]){let o=d[t+"_onlChange"](),n=Object.keys(e)[0];if(o[n]){let l=v(t).getFormEvent(),g=H({column:{key:n},value:e[n]},l);o[n].call(p,p,g)}}}function Ze(e,t){if(d&&d[t+"_onlChange"]){let o=d[t+"_onlChange"](p);if(e.column==="all"){let n=Object.keys(o);if(n.length>0)for(let l of n)o[l].call(p,p,e)}else{let n=e.column.key||e.col.key;o[n]&&e.row&&e.row.id&&o[n].call(p,p,e)}}}function et(e,t){t.isModalData||re(e,t)}function tt(e){return"online_"+e+":"}function ot(e,t){return C(this,null,function*(){if(!d||!d.onlChange||!e)return!1;let o=d.onlChange();if(o[e]){let n={row:yield Q(),column:{key:e},value:t};o[e].call(p,p,n)}})}function me(e){let t=e.toLocaleString().match(no);if(t.length>1){let o=t[1];Ce(o)}}function X(e,t){if(e=="js"){let o=t+"_hook";d&&d[t]?d[t].call(p,p):d&&d[o]&&me(d[o])}else if(e=="action"){let o=T.value,n={formId:i.id,buttonCode:t,dataId:o.id,uiFormData:Object.assign({},o)};ee.post({url:`${oe.urlButtonAction}`,params:n},{isTransformResponse:!1}).then(l=>{l.success?r.success("处理完成!"):r.warning("处理失败!")})}}function pe(e){let t=v(e),o=[...t.getNewDataWithId(),...J.value[e]];if(!o||o.length==0)return!1;let n=[];for(let l of o)n.push(l.id);t.removeRowsById(n)}function fe(e,t){if(!t)return!1;let o=v(e);typeof t=="object"?o.addRows(t,!0):this.$message.error("添加子表数据,参数不识别!")}function nt(e,t){pe(e),fe(e,t)}function lt(e,t){!t&&t.length<=0&&(t=[]),t.map(o=>{o.hasOwnProperty("label")||(o.label=o.text)}),G({field:e,componentProps:{options:t}})}function at(e,t){return d&&d.beforeSubmit?d.beforeSubmit(e,t):Promise.resolve()}function rt(e,t){let o=V(E);e&&e.length>0?Object.keys(o).map(n=>{!n.endsWith("_load")&&e.indexOf(n)<0&&(E[n]=!1)}):t&&t.length>0&&Object.keys(o).map(n=>{t.indexOf(n)>=0&&(E[n]=!1)})}function it(e,t){return C(this,null,function*(){f.value=t,yield le(),T.value="",c.value=!0,yield ie(e),yield ye(()=>{X("js","loaded")})})}function v(e){let t=z[e].value;if(t instanceof Array&&(t=t[0]),!t){r.warning("子表ref找不到:"+e);return}return t}function ut(){let e=D.reportPrintUrl,t=T.value.id,o=wt();Ot(e,t,o)}const[st,{openModal:be}]=qt(),Y=h(""),Z=h(!0);function dt(e){Y.value=e.id,Z.value=!1,be(!0,{isUpdate:!1,tableType:"3"})}function ct(e){let t=v(e.key).getSelectedData();if(t.length!=1){r.warning("请选择一条数据");return}Y.value=e.id,Z.value=!1,be(!0,{isUpdate:!0,record:t[0]})}function mt(e){const t=e[ve];let o=Fe(e,[ve]);if(o.id){let n=Fe(H({},o),"id"),l=[{rowKey:o.id,values:n}];v(t).setValues(l)}else v(t).addRows(o,{isOnlineJS:!1,setActive:!1,emitChange:!0,isModalData:!0})}function pt(){if(i.themeTemplate===te)return;let e=A.value;if(e&&e.length>0){for(let t of e)if(t.relationType!=1){let o=v(t.key);o&&o.clearSelection()}}}function ft(){let e=Q(),t=V(M[u.value]);q(t,o=>{O(o)},e)}function bt(e,t){let o=A.value;if(o&&o.length>0){let n=o.filter(l=>l.key===e);if(n.length==0)return;if(n[0].relationType==1)v(e).executeFillRule();else{let l=V(M[e]),g=V(t.row);q(l,R=>{const{row:K,target:ht}=t;let gt=[{rowKey:K.id,values:H({},R)}];ht.setValues(gt)},g)}}}let he={tableName:u,loading:S,subActiveKey:N,onlineFormRef:a,getFieldsValue:Q,setFieldsValue:O,submitFlowFlag:m,subFormHeight:de,subTableHeight:ce,refMap:z,triggleChangeValues:ze,triggleChangeValue:Ge,sh:E,clearSubRows:pe,addSubRows:fe,clearThenAddRows:nt,changeOptions:lt,isUpdate:c,getSubTableInstance:v,updateSchema:G,executeMainFillRule:ft,executeSubFillRule:bt,changEvent:()=>{},onlineFormValueChange:Be};return W(he),{tableName:u,onlineFormRef:a,registerForm:xe,loading:S,subActiveKey:N,hasSubTable:ke,subTabInfo:A,refMap:z,subFormHeight:de,getSubTableForeignKeyValue:Qe,isUpdate:c,handleSubFormChange:Ye,subTableHeight:ce,onlineFormDisabled:ae,subDataSource:J,getSubTableAuthPre:tt,handleAdded:et,handleSubTableDefaultValue:re,handleValueChange:Ze,openSubFormModalForAdd:dt,openSubFormModalForEdit:ct,show:Ve,createRootProperties:$e,handleSubmit:Ne,sh:E,handleCgButtonClick:X,handleCustomFormSh:rt,handleCustomFormEdit:it,dbData:T,onOpenReportPrint:ut,onlineExtConfigJson:D,registerPopModal:st,popTableName:Y,getPopFormData:mt,popModalRequest:Z,onCloseModal:pt,ERP:te}}},ao=["id"],ro={key:0,style:{"text-align":"right",position:"absolute",top:"6px",right:"20px","z-index":"999"}},io={key:1};function uo(i,s,r,a,k,S){const b=F("PrinterOutlined"),f=F("BasicForm"),m=F("online-sub-form"),c=F("diff-outlined"),x=F("a-button"),D=F("form-outlined"),p=F("JVxeTable"),W=F("a-tab-pane"),j=F("a-tabs"),M=F("Loading"),B=F("online-pop-modal");return w(),_("div",{id:a.tableName+"_form"},[a.dbData.id&&a.onlineExtConfigJson.reportPrintShow?(w(),_("div",ro,[P(b,{title:"打印",onClick:a.onOpenReportPrint,style:{"font-size":"16px"}},null,8,["onClick"])])):U("",!0),P(f,{ref:"onlineFormRef",onRegister:a.registerForm},null,8,["onRegister"]),r.themeTemplate!==a.ERP&&a.hasSubTable?(w(),L(j,{key:1,activeKey:a.subActiveKey,"onUpdate:activeKey":s[0]||(s[0]=u=>a.subActiveKey=u)},{default:$(()=>[(w(!0),_(Mt,null,Vt(a.subTabInfo,(u,T)=>(w(),L(W,{tab:u.describe,key:T+"",forceRender:!0},{default:$(()=>[u.relationType==1?(w(),_("div",{key:0,style:jt({"overflow-y":"auto","overflow-x":"hidden","max-height":a.subFormHeight+"px"})},[P(m,{ref_for:!0,ref:a.refMap[u.key],table:u.key,disabled:a.onlineFormDisabled,"form-template":r.formTemplate,"main-id":a.getSubTableForeignKeyValue(u.foreignKey),properties:u.properties,"required-fields":u.requiredFields,"is-update":a.isUpdate,onFormChange:y=>a.handleSubFormChange(y,u.key)},null,8,["table","disabled","form-template","main-id","properties","required-fields","is-update","onFormChange"])],4)):(w(),_("div",io,[P(p,{ref_for:!0,ref:a.refMap[u.key],toolbar:"","keep-source":"","row-number":"","row-selection":"",height:a.subTableHeight,disabled:a.onlineFormDisabled,columns:u.columns,dataSource:a.subDataSource[u.key],onValueChange:y=>a.handleValueChange(y,u.key),authPre:a.getSubTableAuthPre(u.key),onAdded:y=>a.handleAdded(u,y),onExecuteFillRule:y=>a.handleSubTableDefaultValue(u,y)},{toolbarSuffix:$(()=>[a.onlineFormDisabled?U("",!0):(w(),L(x,{key:0,type:"primary",onClick:y=>a.openSubFormModalForAdd(u)},{default:$(()=>[P(c)]),_:2},1032,["onClick"])),a.onlineFormDisabled?U("",!0):(w(),L(x,{key:1,type:"primary",onClick:y=>a.openSubFormModalForEdit(u)},{default:$(()=>[P(D)]),_:2},1032,["onClick"]))]),_:2},1032,["height","disabled","columns","dataSource","onValueChange","authPre","onAdded","onExecuteFillRule"])]))]),_:2},1032,["tab"]))),128))]),_:1},8,["activeKey"])):U("",!0),P(M,{loading:a.loading,absolute:!1},null,8,["loading"]),At(i.$slots,"bottom"),P(B,{formTableType:"3",request:a.popModalRequest,id:a.popTableName,onRegister:a.registerPopModal,onSuccess:a.getPopFormData,topTip:"",isVxeTableData:""},null,8,["request","id","onRegister","onSuccess"])],8,ao)}const so=Pt(lo,[["render",uo]]),mn=Object.freeze(Object.defineProperty({__proto__:null,default:so},Symbol.toStringTag,{value:"Module"}));export{no as G,so as O,mn as a,oo as u};

import{d as Ue,l as g,e as ee,p as te,r as Ve,n as G,J as $e,V as b,a7 as S,ac as z,af as Ke,aa as u,f as r,E as F,a8 as ae,F as He,ab as Ge,ae as ze,W as le,ad as oe}from"./vue-ebecda47.js";import{t as We,E as Ze,G as Ye,s as Xe,F as et}from"./index-85cfc899.js";import{B as tt}from"./index-e91e8b28.js";import"./index-a2e0ccba.js";import{ap as v,C as at,bF as E,bB as lt}from"./jeecg-online-vendor-cfb58502.js";import{I as ot}from"./useSchemas-fc8d97ce-cbe2dd61.js";import nt from"./DBAttributeTable-cd1c41e5-64644901.js";import it from"./PageAttributeTable-811185fd-1c25f984.js";import rt from"./CheckDictTable-414313f2-3ef1b95b.js";import st from"./ForeignKeyTable-cb1abd1d-7eb41752.js";import dt from"./IndexTable-4e94cd1f-92bf6697.js";import ut from"./QueryTable-4ba771ef-3839d10f.js";import ct from"./ExtendConfigModal-60f2cf86-0ed1eb35.js";import{y as bt,m as ft,c as mt,r as _}from"./cgform.data-cbdd88c3-2ccae74f.js";import{D as pt}from"./useOnlineTest-0df0ae86-624ffd01.js";import{g as gt}from"./useExtendComponent-48d37d9b-8d9aa8a0.js";import{B as Tt,u as yt}from"./useForm-21b78d9f.js";import"./antd-vue-vendor-b75e8c06.js";import"./tinymce-vendor-7c917b36.js";import"./lodash-es-vendor-cd7703c8.js";import"./codemirror-vendor-9b2dceac.js";import"./echarts-vendor-ba343549.js";import"./vxe-table-vendor-4aae63bf.js";import"./BasicModal-7e6e7ae9.js";import"./useWindowSizeFn-50bd5ea0.js";import"./componentMap-c36c4b8d.js";import"./useFormItem-ba20c4de.js";import"./index-be9b0972.js";import"./download-c9e5f3f7.js";import"./base64Conver-fa2fe1af.js";import"./index-96e99de8.js";import"./index-118a05d7.js";import"./useCountdown-00a25cd7.js";import"./useFormItemSingle-36e25e6f.js";import"./JAddInput-64f6e84f.js";import"./areaDataUtil-4a5c6609.js";import"./JSelectUser-94adcf4d.js";import"./props-c57324f9.js";import"./JSelectBiz-4fc2f082.js";import"./index-1c3e0ea1.js";import"./index-097af6f9.js";import"./bem-311698ef.js";import"./props-13a58630.js";import"./useContextMenu-eb481e60.js";import"./depart.api-1888bf18.js";import"./JSelectDept-394df716.js";import"./JPopup-f9a8bda3.js";import"./cron-parser-vendor-afad4b1e.js";import"./JEllipsis-410bb5e8.js";import"./JUpload-ffe34816.js";import"./index-ae3841ab.js";import"./index-ab54dd3c.js";import"./validator-fb5fa821.js";import"./user.api-729c8827.js";import"./useTableSync-dc333087-3f08a785.js";import"./LinkTableConfigModal-77d7c0b9-df47ed5c.js";import"./LinkTableFieldConfigModal-c5689ab0-c963fff7.js";import"./FieldExtendJsonModal-48f7d67f-6b789050.js";import"./index-38e4d5c0.js";import"./customExpression-62f5afd1.js";import"./index-993283cc.js";import"./BasicTable-46b6c894.js";import"./injectionKey-69710956.js";import"./useListPage-52971497.js";import"./LinkTableListPiece-34266919-8927295e.js";import"./OnlineSelectCascade-c7baf52b-8f32847b.js";import"./JModalTip-abe1515a-cd675860.js";var vt=Object.defineProperty,ht=Object.defineProperties,Ct=Object.getOwnPropertyDescriptors,ne=Object.getOwnPropertySymbols,kt=Object.prototype.hasOwnProperty,xt=Object.prototype.propertyIsEnumerable,ie=(t,o,c)=>o in t?vt(t,o,{enumerable:!0,configurable:!0,writable:!0,value:c}):t[o]=c,J=(t,o)=>{for(var c in o||(o={}))kt.call(o,c)&&ie(t,c,o[c]);if(ne)for(var c of ne(o))xt.call(o,c)&&ie(t,c,o[c]);return t},Rt=(t,o)=>ht(t,Ct(o)),x=(t,o,c)=>new Promise((O,C)=>{var f=m=>{try{k(c.next(m))}catch(p){C(p)}},R=m=>{try{k(c.throw(m))}catch(p){C(p)}},k=m=>m.done?O(m.value):Promise.resolve(m.value).then(f,R);k((c=c.apply(t,o)).next())});const Ua=t=>v.get({url:"/online/cgform/head/list",params:t}),Va=t=>re(t,0),$a=t=>v.delete({url:"/online/cgform/head/removeRecord",params:{id:t}},{joinParamsToUrl:!0}),Ka=t=>re(t,1),Ha=t=>v.delete({url:"/online/cgform/head/delete",params:{id:t}},{joinParamsToUrl:!0});function re(t,o){return v.delete({url:"/online/cgform/head/deleteBatch",params:{ids:t.join(","),flag:o}},{joinParamsToUrl:!0})}const Ga=(t,o)=>v.post({url:`/online/cgform/api/doDbSynch/${t}/${o}`,timeout:12e3,timeoutErrorMessage:"同步数据库超时，已自动刷新"}),za=t=>v.post({url:`/online/cgform/head/copyOnline?code=${t}`}),Wa=(t,o,c)=>v.get({url:`/online/cgform/head/copyOnlineTable/${t}`,params:J({tableName:o},c)}),L={doQueryField:(t,o)=>v.get({url:"/online/cgform/field/listByHeadId",params:J({headId:t},o)}),doQueryIndexes:(t,o)=>v.get({url:"/online/cgform/index/listByHeadId",params:J({headId:t},o)}),doSaveOrUpdate:(t,o)=>o?v.put({url:"/online/cgform/api/editAll",params:t}):v.post({url:"/online/cgform/api/addAll",params:t}),editHead:t=>v.put({url:"/online/cgform/head/edit",params:t})},Dt=Ue({name:"CgformModal",components:{BasicModal:tt,BasicForm:Tt,DBAttributeTable:nt,PageAttributeTable:it,CheckDictTable:rt,ForeignKeyTable:st,IndexTable:dt,QueryTable:ut,ExtendConfigModal:ct,Icon:We},emits:["success","register"],props:{actionButton:{type:Boolean,default:!0,required:!1}},setup(t,{emit:o}){const{createMessage:c}=at(),O=g(),C=g(!1);let f={};const R=ee(()=>C.value?"编辑":"新增"),k=g(!0),m=g(!1),p=g("dbTable"),I=g(!0),d={dbTable:g(),pageTable:g(),checkTable:g(),fkTable:g(),idxTable:g(),queryTable:g()},Q=ee(()=>{var e,a;return(a=(e=O.value)==null?void 0:e.fullScreenRef)!=null?a:!1});te("tables",d),te("fullScreenRef",Q);const{formSchemas:q}=ot(t,{onTableTypeChange:he,onIsTreeChange:Ce,ifShowOfSubTableStr:()=>W}),[U,w]=yt({schemas:q,showActionButtonGroup:!1,labelAlign:"right"}),{resetFields:V,setFieldsValue:j,validate:P}=w,[$,{closeModal:K}]=Ze(e=>{var a;C.value=(a=e==null?void 0:e.isUpdate)!=null?a:!1,C.value?Z(e==null?void 0:e.record):me()}),N=g("");let T=Ve({});const h=Ye(()=>ke(),150);let M=[],W=!1,A=!1,D=[];const{aiTestMode:se,aiTestTable:de,aiTableList:ue,initVirtualData:ce,tableJsonGetHelper:be,refreshCacheTableName:fe}=pt();function me(){Z({})}function Z(e){return x(this,null,function*(){var a;if(k.value=!1,p.value="dbTable",yield V(),f=Object.assign({},e),ye(f),be(f),Te(f),j(f),N.value=f.tableName,E(1,()=>I.value=!1),C.value)(a=d.dbTable.value)==null||a.setDataSource([]),yield pe(f.id),yield ge(f.id),gt(d.pageTable).then(()=>{d.pageTable.value.changePageType(f.tableType==3)});else{let{initialData:l,tempIds:n}=bt();yield Y(l,!0),M=n}})}function pe(e){return x(this,null,function*(){m.value=!0;try{let a=yield L.doQueryField(e);m.value=!1,yield Y(a)}finally{m.value=!1}})}function ge(e){return x(this,null,function*(){let a=yield L.doQueryIndexes(e);d.idxTable.value.setDataSource(a)})}function Te(e){let a={};if(e.extConfigJson)try{a=JSON.parse(e.extConfigJson)}catch(l){}T=Object.assign({},ft,a,{isDesForm:e.isDesForm||"N",desFormCode:e.desFormCode||""})}function ye(e){A=e.isTree=="Y",W=e.tableType===2}function Y(e,a){return x(this,null,function*(){const{dbTable:l,pageTable:n,checkTable:s,fkTable:i,queryTable:y}=d;l.value||(yield G(),yield E(1)),l.value.setDataSource(e,a),setTimeout(()=>{n.value.setDataSource(e,a),s.value.setDataSource(e,a),i.value.setDataSource(e,a),y.value.setDataSource(e,a)},10)})}function ve(e){if(["pageTable","checkTable","fkTable","idxTable","queryTable"].indexOf(e)!==-1){const a=d.dbTable,l=d[e];a.value.tableRef.resetScrollTop(),l.value.syncTable(a)}}function he(e){e===1&&j({themeTemplate:"normal"}),d.pageTable.value.changePageType(e==3)}function Ce(e){e==="Y"?Be():Se()}function H(){h()}function ke(){return x(this,null,function*(){let{dbTable:e,pageTable:a,checkTable:l,fkTable:n,queryTable:s}=d;yield a.value.syncTable(e),yield l.value.syncTable(e),yield n.value.syncTable(e),yield s.value.syncTable(e)})}function xe(){H()}function Re(){H()}function De(e){let{oldIndex:a,newIndex:l}=e;Oe(a,l)}function Fe(e){return x(this,null,function*(){let{insertIndex:a,row:l}=e,{pageTable:n,checkTable:s,fkTable:i,queryTable:y}=d;n.value.tableRef.insertRows(l,a),s.value.tableRef.insertRows(l,a),i.value.tableRef.insertRows(l,a),y.value.tableRef.insertRows(l,a)})}function Oe(e,a){let{pageTable:l,checkTable:n,fkTable:s,queryTable:i}=d;l.value.tableRef.rowResort(e,a),n.value.tableRef.rowResort(e,a),s.value.tableRef.rowResort(e,a),i.value.tableRef.rowResort(e,a)}function Ie(e){d.pageTable.value.syncFieldShowType(e.row)}function we(e){d.pageTable.value.enableQuery(e)}function Be(){if(!A){let{dbTable:e,pageTable:a,checkTable:l}=d,n=mt();n=n.filter(s=>!e.value.tableRef.getTableData().map(i=>i.dbFieldName).includes(s.dbFieldName)),D=[],n.forEach(s=>{let i=Xe()+"__tempId";D.push(i),s.id=i}),e.value.tableRef.addRows(n,{setActive:!1}),a.value.tableRef.addRows(n,{setActive:!1}),l.value.tableRef.addRows(n,{setActive:!1}),G(()=>H()),A=!0}G(()=>{w.setFieldsValue({treeIdField:"has_child",treeParentIdField:"pid"})})}function Se(){if(D&&D.length>0){let{dbTable:e}=d;e.value.tableDeleteLines(D),D=[],A=!1}}function _e(){let e={};return new Promise((a,l)=>{P().then(n=>a({values:n}),()=>l(_))}).then(a=>(Object.assign(e,a),je())).then(a=>{Object.assign(e,a);let l=Pe(e);return Ne(l)}).catch(a=>((a===_||(a==null?void 0:a.code)===_)&&c.warning("校验未通过"),Promise.reject(null)))}function je(){return new Promise((e,a)=>x(this,null,function*(){let l=Object.keys(d),n={};for(let s=0;s<l.length;s++){let i=l[s],y=d[i];try{n[i]=yield y.value.validateData(i)}catch(B){B.code===_&&(p.value=B.activeKey),a(B);return}}e(n)}))}function Pe(e){let a={head:{},fields:[],indexs:[],deleteFieldIds:[],deleteIndexIds:[]};return a.head=Object.assign(f,e.values),a.head.isDesForm=T.isDesForm,a.head.desFormCode=T.desFormCode,delete T.isDesForm,delete T.desFormCode,a.head.extConfigJson=JSON.stringify(T),e.dbTable.tableData.forEach((l,n)=>{let s=l.id,i=Object.assign({},l),y=e.pageTable.tableData[n];i=Object.assign(y,i);let B=e.checkTable.tableData[n];i=Object.assign(B,i);let Qe=e.fkTable.tableData[n];i=Object.assign(Qe,i);let qe=e.queryTable.tableData[n];i=Object.assign(qe,i),s==null||s===""?delete i.id:i.id=s,[].concat(M,D).includes(i.id)&&delete i.id,a.fields.push(i)}),a.deleteFieldIds=e.dbTable.deleteIds,a.indexs=e.idxTable.tableData,a.deleteIndexIds=e.idxTable.deleteIds,a}function Ne(e){return new Promise((a,l)=>{let n=e.fields,s=!0;if(n&&n.length>0){let i=0;for(let y=0;y<n.length;y++)if((n[y].mainField||n[y].mainTable)&&(i+=1),i>1){s=!1;break}}s?a(e):l({code:-1,msg:"外键只允许配置一个!",error:_})})}function Me(){k.value=!0,_e().then(e=>x(this,null,function*(){var a;if(e.fields&&e.fields.length>0)for(let l of e.fields)l.dbFieldName=l.dbFieldName.toLowerCase().trim();(a=e.head)!=null&&a.tableName&&(e.head.tableName=e.head.tableName.toLowerCase().trim()),yield L.doSaveOrUpdate(e,C.value),fe(N.value,e.head.tableName),o("success"),E(1,()=>X())}),e=>{}).finally(()=>{k.value=!1})}const[Ae,Ee]=et();function Le(e){return x(this,null,function*(){if(T=e,C.value==!0){let a=$e(T);const l={id:f.id,extConfigJson:JSON.stringify(a)};yield L.editHead(l),o("success")}})}function Je(){Ee.openModal(!0,{extConfigJson:T})}function X(){I.value=!0,E(1,()=>K())}return Rt(J({},d),{modalRef:O,title:R,confirmLoading:k,tableLoading:m,activeKey:p,onCancel:X,extConfigJson:T,formAction:w,hideTabs:I,onSubmit:Me,onTabsChange:ve,onTableAdded:xe,onTableRemoved:Re,onTableDragged:De,onTableInserted:Fe,onTableSyncDbType:Ie,onTableQuery:we,onOpenExtConfig:Je,onExtConfigOk:Le,registerForm:U,registerModal:$,registerExtendConfigModal:Ae,aiTestMode:se,aiTestTable:de,aiTableList:ue,initVirtualData:ce})}}),Ft={style:{flex:"1","text-align":"right"}},Ot={key:0,style:{display:"inline-block","text-align":"left",position:"absolute",left:"0"}};function It(t,o,c,O,C,f){const R=b("a-button"),k=b("BasicForm"),m=b("DBAttributeTable"),p=b("a-tab-pane"),I=b("PageAttributeTable"),d=b("CheckDictTable"),Q=b("ForeignKeyTable"),q=b("IndexTable"),U=b("Icon"),w=b("a-tooltip"),V=b("QueryTable"),j=b("a-tabs"),P=b("a-spin"),$=b("a-select-option"),K=b("a-select"),N=b("ExtendConfigModal"),T=b("BasicModal");return S(),z(T,Ke({ref:"modalRef",title:t.title,width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:t.confirmLoading},t.$attrs,{onCancel:t.onCancel,onRegister:t.registerModal}),{footer:u(()=>[r(R,{onClick:t.onCancel},{default:u(()=>[F("关闭")]),_:1},8,["onClick"]),r(R,{type:"primary",loading:t.confirmLoading,preIcon:"ant-design:save",onClick:t.onSubmit},{default:u(()=>[F("保存")]),_:1},8,["loading","onClick"]),t.aiTestMode?(S(),ae("div",Ot,[r(K,{value:t.aiTestTable,"onUpdate:value":o[1]||(o[1]=h=>t.aiTestTable=h),placeholder:"请选择测试的表类型",getPopupContainer:h=>h.parentElement,style:{width:"250px",margin:"0 10px 0 20px"}},{default:u(()=>[(S(!0),ae(He,null,Ge(t.aiTableList,(h,M)=>(S(),z($,{key:M,value:h.name},{default:u(()=>[F(ze(h.title+"（"+h.name+"）"),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","getPopupContainer"]),r(R,{type:"primary",ghost:"",onClick:t.initVirtualData},{default:u(()=>[F("生成数据>>")]),_:1},8,["onClick"])])):le("",!0)]),default:u(()=>[r(P,{wrapperClassName:"p-2",spinning:t.confirmLoading},{default:u(()=>[r(k,{onRegister:t.registerForm},{extConfigButton:u(()=>[oe("div",Ft,[r(R,{preIcon:"ant-design:setting",onClick:t.onOpenExtConfig},{default:u(()=>[F("扩展配置")]),_:1},8,["onClick"])])]),_:1},8,["onRegister"]),r(P,{spinning:t.tableLoading||t.hideTabs},{default:u(()=>[t.hideTabs?le("",!0):(S(),z(j,{key:0,activeKey:t.activeKey,"onUpdate:activeKey":o[0]||(o[0]=h=>t.activeKey=h),animated:"",onChange:t.onTabsChange},{default:u(()=>[r(p,{tab:"数据库属性",key:"dbTable",forceRender:""},{default:u(()=>[r(m,{ref:"dbTable",actionButton:t.actionButton,onAdded:t.onTableAdded,onRemoved:t.onTableRemoved,onDragged:t.onTableDragged,onInserted:t.onTableInserted,onSyncDbType:t.onTableSyncDbType},null,8,["actionButton","onAdded","onRemoved","onDragged","onInserted","onSyncDbType"])]),_:1}),r(p,{tab:"页面属性",key:"pageTable",forceRender:""},{default:u(()=>[r(I,{ref:"pageTable"},null,512)]),_:1}),r(p,{tab:"校验字段",key:"checkTable",forceRender:""},{default:u(()=>[r(d,{ref:"checkTable"},null,512)]),_:1}),r(p,{tab:"外键",key:"fkTable",forceRender:""},{default:u(()=>[r(Q,{ref:"fkTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(p,{tab:"索引",key:"idxTable",forceRender:""},{default:u(()=>[r(q,{ref:"idxTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),r(p,{key:"queryTable",forceRender:""},{tab:u(()=>[oe("span",null,[F(" 个性查询配置 "),r(w,null,{title:u(()=>[F("允许自定义，查询表单字段控件类型！")]),default:u(()=>[r(U,{icon:"bx:help-circle"})]),_:1})])]),default:u(()=>[r(V,{ref:"queryTable",onQuery:t.onTableQuery},null,8,["onQuery"])]),_:1})]),_:1},8,["activeKey","onChange"]))]),_:1},8,["spinning"])]),_:1},8,["spinning"]),r(N,{onRegister:t.registerExtendConfigModal,parentForm:t.formAction,onOk:t.onExtConfigOk},null,8,["onRegister","parentForm","onOk"])]),_:1},16,["title","confirmLoading","onCancel","onRegister"])}const wt=lt(Dt,[["render",It]]),Za=Object.freeze(Object.defineProperty({__proto__:null,default:wt},Symbol.toStringTag,{value:"Module"}));export{wt as C,Ha as a,$a as b,Va as c,za as d,Ka as e,Ga as f,Wa as g,Za as h,Ua as l};

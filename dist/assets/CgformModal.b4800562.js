import{B as xe}from"./index.caa4340a.js";import{B as Ke}from"./BasicForm.95d022b6.js";import"./helper.eb44fb2b.js";import{u as Ve}from"./useForm.7d0bc062.js";import"./JAddInput.aac09453.js";import{Z as F,j as qe,C as g,m as X,bB as ee,bH as Ue,a8 as He,bI as Ge,f2 as ze,f3 as M,G as U,b1 as Ye,r as f,s as E,Q as H,w as c,v as u,y as A,t as te,ax as We,bc as Ze,z as Xe,R as ae,aW as et,x as tt,ac as at,bN as lt,u as ot}from"./index.2920d7d8.js";import{u as nt}from"./useSchemas.d1bf8288.js";import it from"./DBAttributeTable.16e0719a.js";import rt from"./PageAttributeTable.892cdc76.js";import st from"./CheckDictTable.56805998.js";import ut from"./ForeignKeyTable.320ef67c.js";import dt from"./IndexTable.1a929661.js";import ct from"./QueryTable.00984cfb.js";import ft from"./ExtendConfigModal.2627f8ab.js";import{u as bt,E as pt,a as mt,V as S}from"./cgform.data.0e5fe2da.js";import{u as Tt}from"./useOnlineTest.fc07a070.js";import{g as gt}from"./useAutoForm.a8eff145.js";import"./BasicModal.121fcc46.js";import"./useWindowSizeFn.b67cafb9.js";import"./BasicForm.vue_vue_type_style_index_0_lang.6a768e32.js";import"./uniqBy.c347f777.js";import"./useFormItem.d8896cd3.js";import"./functional.998816d4.js";import"./download.5f449ef8.js";import"./base64Conver.030fa32c.js";import"./index.47969de5.js";import"./index.5d5d1a07.js";import"./useCountdown.98b6f42f.js";import"./JUpload.vue_vue_type_style_index_0_lang.1f61eb1d.js";import"./api.459a0480.js";import"./index.5463900c.js";import"./props.f51d8683.js";import"./index.8c738a79.js";import"./bem.e2c66aed.js";import"./props.d50ab1d9.js";import"./useContextMenu.b3efef40.js";import"./index.ab1274d5.js";import"./onMountedOrActivated.333f806a.js";import"./index.4e3911f7.js";import"./htmlmixed.879792e1.js";import"./vue.33262075.js";/* empty css             */import"./depart.api.601a452e.js";import"./validator.f8847e7f.js";import"./user.api.e5c048ee.js";import"./useTableSync.390f4eb0.js";import"./pick.c71b68c9.js";import"./_flatRest.5902502b.js";import"./isArray.66d20e0c.js";import"./toString.ebcee774.js";import"./_arrayPush.8a7e8b55.js";import"./LinkTableConfigModal.b3aab40e.js";import"./omit.3fec584b.js";import"./_baseClone.757faec1.js";import"./_baseSlice.bbf5c264.js";import"./LinkTableFieldConfigModal.9ab4eb30.js";import"./FormSchemaFactory.eb025a60.js";import"./JUploadModal.vue_vue_type_script_setup_true_lang.398e58df.js";import"./_commonjsHelpers.582fb888.js";import"./customExpression.05dc2408.js";import"./OnlineSelectCascade.c5df075f.js";import"./BasicTable.1d28b440.js";import"./BasicTable.vue_vue_type_style_index_0_lang.dc4aa8ca.js";import"./index.b5342f96.js";import"./useContentHeight.4c70673e.js";import"./useContentViewHeight.c4b5e36c.js";import"./usePageContext.0825eb55.js";import"./RedoOutlined.f3c051c4.js";import"./TableImg.vue_vue_type_style_index_0_lang.98d08963.js";import"./useListPage.393d6fc2.js";import"./useTable.602dea91.js";import"./Area.8992282f.js";import"./LinkTableListPiece.0334a6ec.js";import"./JModalTip.bf4a3166.js";var yt=Object.defineProperty,vt=Object.defineProperties,ht=Object.getOwnPropertyDescriptors,le=Object.getOwnPropertySymbols,Ct=Object.prototype.hasOwnProperty,Ft=Object.prototype.propertyIsEnumerable,oe=(t,o,d)=>o in t?yt(t,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):t[o]=d,L=(t,o)=>{for(var d in o||(o={}))Ct.call(o,d)&&oe(t,d,o[d]);if(le)for(var d of le(o))Ft.call(o,d)&&oe(t,d,o[d]);return t},_t=(t,o)=>vt(t,ht(o)),_=(t,o,d)=>new Promise((B,h)=>{var b=p=>{try{C(d.next(p))}catch(m){h(m)}},D=p=>{try{C(d.throw(p))}catch(m){h(m)}},C=p=>p.done?B(p.value):Promise.resolve(p.value).then(b,D);C((d=d.apply(t,o)).next())});const Ya=t=>F.get({url:"/online/cgform/head/list",params:t}),Wa=t=>ne(t,0),Za=t=>ne(t,1);function ne(t,o){return F.delete({url:"/online/cgform/head/deleteBatch",params:{ids:t.join(","),flag:o}},{joinParamsToUrl:!0})}const Xa=(t,o)=>F.post({url:`/online/cgform/api/doDbSynch/${t}/${o}`,timeout:12e3,timeoutErrorMessage:"\u540C\u6B65\u6570\u636E\u5E93\u8D85\u65F6\uFF0C\u5DF2\u81EA\u52A8\u5237\u65B0"}),el=t=>F.post({url:`/online/cgform/head/copyOnline?code=${t}`}),tl=(t,o,d)=>F.get({url:`/online/cgform/head/copyOnlineTable/${t}`,params:L({tableName:o},d)}),j={doQueryField:(t,o)=>F.get({url:"/online/cgform/field/listByHeadId",params:L({headId:t},o)}),doQueryIndexes:(t,o)=>F.get({url:"/online/cgform/index/listByHeadId",params:L({headId:t},o)}),doSaveOrUpdate:(t,o)=>o?F.put({url:"/online/cgform/api/editAll",params:t}):F.post({url:"/online/cgform/api/addAll",params:t}),editHead:t=>F.put({url:"/online/cgform/head/edit",params:t})},Dt=qe({name:"CgformModal",components:{BasicModal:xe,BasicForm:Ke,DBAttributeTable:it,PageAttributeTable:rt,CheckDictTable:st,ForeignKeyTable:ut,IndexTable:dt,QueryTable:ct,ExtendConfigModal:ft},emits:["success","register"],props:{actionButton:{type:Boolean,default:!0,required:!1}},setup(t,{emit:o}){const{createMessage:d}=ot(),B=g(),h=g(!1);let b={};const D=X(()=>h.value?"\u7F16\u8F91":"\u65B0\u589E"),C=g(!0),p=g(!1),m=g("dbTable"),O=g(!0),s={dbTable:g(),pageTable:g(),checkTable:g(),fkTable:g(),idxTable:g(),queryTable:g()},$=X(()=>{var e,a;return(a=(e=B.value)==null?void 0:e.fullScreenRef)!=null?a:!1});ee("tables",s),ee("fullScreenRef",$);const{formSchemas:J}=nt(t,{onTableTypeChange:ve,onIsTreeChange:he,ifShowOfSubTableStr:()=>z}),[Q,w]=Ve({schemas:J,showActionButtonGroup:!1,labelAlign:"right"}),{resetFields:I,setFieldsValue:N,validate:x}=w,[K,{closeModal:V}]=Ue(e=>{var a;h.value=(a=e==null?void 0:e.isUpdate)!=null?a:!1,h.value?Y(e==null?void 0:e.record):be()}),y=g("");let v=He({});const ie=lt(()=>Ce(),150);let G=[],z=!1,P=!1,k=[];const{aiTestMode:re,aiTestTable:se,aiTableList:ue,initVirtualData:de,tableJsonGetHelper:ce,refreshCacheTableName:fe}=Tt();function be(){Y({})}function Y(e){return _(this,null,function*(){var a;if(C.value=!1,m.value="dbTable",yield I(),b=Object.assign({},e),ge(b),ce(b),Te(b),N(b),y.value=b.tableName,M(1,()=>O.value=!1),h.value)(a=s.dbTable.value)==null||a.setDataSource([]),yield pe(b.id),yield me(b.id),gt(s.pageTable).then(()=>{s.pageTable.value.changePageType(b.tableType==3)});else{let{initialData:l,tempIds:n}=bt();yield W(l,!0),G=n}})}function pe(e){return _(this,null,function*(){p.value=!0;try{let a=yield j.doQueryField(e);p.value=!1,yield W(a)}finally{p.value=!1}})}function me(e){return _(this,null,function*(){let a=yield j.doQueryIndexes(e);s.idxTable.value.setDataSource(a)})}function Te(e){let a={};if(e.extConfigJson)try{a=JSON.parse(e.extConfigJson)}catch(l){console.error("online\u6269\u5C55JSON\u8F6C\u6362\u5931\u8D25\uFF1A",l)}v=Object.assign({},pt,a,{isDesForm:e.isDesForm||"N",desFormCode:e.desFormCode||""})}function ge(e){P=e.isTree=="Y",z=e.tableType===2}function W(e,a){return _(this,null,function*(){const{dbTable:l,pageTable:n,checkTable:r,fkTable:i,queryTable:T}=s;l.value||(yield U(),yield M(1)),l.value.setDataSource(e,a),setTimeout(()=>{n.value.setDataSource(e,a),r.value.setDataSource(e,a),i.value.setDataSource(e,a),T.value.setDataSource(e,a)},10)})}function ye(e){if(["pageTable","checkTable","fkTable","idxTable","queryTable"].indexOf(e)!==-1){const a=s.dbTable,l=s[e];a.value.tableRef.resetScrollTop(),l.value.syncTable(a)}}function ve(e){e===1&&N({themeTemplate:"normal"}),s.pageTable.value.changePageType(e==3)}function he(e){e==="Y"?we():Ee()}function q(){ie()}function Ce(){return _(this,null,function*(){let{dbTable:e,pageTable:a,checkTable:l,fkTable:n,queryTable:r}=s;yield a.value.syncTable(e),yield l.value.syncTable(e),yield n.value.syncTable(e),yield r.value.syncTable(e)})}function Fe(){q()}function _e(){q()}function De(e){let{oldIndex:a,newIndex:l}=e;Re(a,l)}function ke(e){return _(this,null,function*(){let{insertIndex:a,row:l}=e,{pageTable:n,checkTable:r,fkTable:i,queryTable:T}=s;n.value.tableRef.insertRows(l,a),r.value.tableRef.insertRows(l,a),i.value.tableRef.insertRows(l,a),T.value.tableRef.insertRows(l,a)})}function Re(e,a){let{pageTable:l,checkTable:n,fkTable:r,queryTable:i}=s;l.value.tableRef.rowResort(e,a),n.value.tableRef.rowResort(e,a),r.value.tableRef.rowResort(e,a),i.value.tableRef.rowResort(e,a)}function Be(e){s.pageTable.value.syncFieldShowType(e.row)}function Oe(e){s.pageTable.value.enableQuery(e)}function we(){if(!P){let{dbTable:e,pageTable:a,checkTable:l}=s,n=mt();n=n.filter(r=>!e.value.tableRef.getTableData().map(T=>T.dbFieldName).includes(r.dbFieldName)),k=[],n.forEach(r=>{let i=Ye()+"__tempId";k.push(i),r.id=i}),e.value.tableRef.addRows(n,{setActive:!1}),a.value.tableRef.addRows(n,{setActive:!1}),l.value.tableRef.addRows(n,{setActive:!1}),U(()=>q()),P=!0}U(()=>{w.setFieldsValue({treeIdField:"has_child",treeParentIdField:"pid"})})}function Ee(){if(k&&k.length>0){let{dbTable:e}=s;e.value.tableDeleteLines(k),k=[],P=!1}}function Ae(){let e={};return new Promise((a,l)=>{x().then(n=>a({values:n}),()=>l(S))}).then(a=>(Object.assign(e,a),Se())).then(a=>{Object.assign(e,a);let l=Ie(e);return Ne(l)}).catch(a=>(a===S||(a==null?void 0:a.code)===S?d.warning("\u6821\u9A8C\u672A\u901A\u8FC7"):console.error(a),Promise.reject(null)))}function Se(){return new Promise((e,a)=>_(this,null,function*(){let l=Object.keys(s),n={};for(let r=0;r<l.length;r++){let i=l[r],T=s[i];try{n[i]=yield T.value.validateData(i)}catch(R){R.code===S?m.value=R.activeKey:console.error(R),a(R);return}}e(n)}))}function Ie(e){let a={head:{},fields:[],indexs:[],deleteFieldIds:[],deleteIndexIds:[]};return a.head=Object.assign(b,e.values),a.head.isDesForm=v.isDesForm,a.head.desFormCode=v.desFormCode,delete v.isDesForm,delete v.desFormCode,a.head.extConfigJson=JSON.stringify(v),e.dbTable.tableData.forEach((l,n)=>{let r=l.id,i=Object.assign({},l),T=e.pageTable.tableData[n];i=Object.assign(T,i);let R=e.checkTable.tableData[n];i=Object.assign(R,i);let Je=e.fkTable.tableData[n];i=Object.assign(Je,i);let Qe=e.queryTable.tableData[n];i=Object.assign(Qe,i),r==null||r===""?delete i.id:i.id=r,[].concat(G,k).includes(i.id)&&delete i.id,a.fields.push(i)}),a.deleteFieldIds=e.dbTable.deleteIds,a.indexs=e.idxTable.tableData,a.deleteIndexIds=e.idxTable.deleteIds,a}function Ne(e){return new Promise((a,l)=>{let n=e.fields,r=!0;if(n&&n.length>0){let i=0;for(let T=0;T<n.length;T++)if((n[T].mainField||n[T].mainTable)&&(i+=1),i>1){r=!1;break}}r?a(e):l({code:-1,msg:"\u5916\u952E\u53EA\u5141\u8BB8\u914D\u7F6E\u4E00\u4E2A!",error:S})})}function Pe(){C.value=!0,Ae().then(e=>_(this,null,function*(){var a;if(e.fields&&e.fields.length>0)for(let l of e.fields)l.dbFieldName=l.dbFieldName.toLowerCase().trim();(a=e.head)!=null&&a.tableName&&(e.head.tableName=e.head.tableName.toLowerCase().trim()),yield j.doSaveOrUpdate(e,h.value),fe(y.value,e.head.tableName),o("success"),M(1,()=>Z())}),e=>{console.error(e)}).finally(()=>{C.value=!1})}const[Me,je]=Ge();function Le(e){return _(this,null,function*(){if(v=e,h.value==!0){let a=at(v);const l={id:b.id,extConfigJson:JSON.stringify(a)};yield j.editHead(l),o("success")}})}function $e(){je.openModal(!0,{extConfigJson:v})}function Z(){O.value=!0,M(1,()=>V())}return _t(L({},s),{modalRef:B,title:D,confirmLoading:C,tableLoading:p,activeKey:m,onCancel:Z,extConfigJson:v,formAction:w,hideTabs:O,onSubmit:Pe,onTabsChange:ye,onTableAdded:Fe,onTableRemoved:_e,onTableDragged:De,onTableInserted:ke,onTableSyncDbType:Be,onTableQuery:Oe,onOpenExtConfig:$e,onExtConfigOk:Le,registerForm:Q,registerModal:K,registerExtendConfigModal:Me,aiTestMode:re,aiTestTable:se,aiTableList:ue,initVirtualData:de})}}),kt={style:{flex:"1","text-align":"right"}},Rt={key:0,style:{display:"inline-block","text-align":"left",position:"absolute",left:"0"}};function Bt(t,o,d,B,h,b){const D=f("a-button"),C=f("BasicForm"),p=f("DBAttributeTable"),m=f("a-tab-pane"),O=f("PageAttributeTable"),s=f("CheckDictTable"),$=f("ForeignKeyTable"),J=f("IndexTable"),Q=f("QueryTable"),w=f("a-tabs"),I=f("a-spin"),N=f("a-select-option"),x=f("a-select"),K=f("ExtendConfigModal"),V=f("BasicModal");return E(),H(V,tt({ref:"modalRef",title:t.title,width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:t.confirmLoading},t.$attrs,{onCancel:t.onCancel,onRegister:t.registerModal}),{footer:c(()=>[u(D,{onClick:t.onCancel},{default:c(()=>[A("\u5173\u95ED")]),_:1},8,["onClick"]),u(D,{type:"primary",loading:t.confirmLoading,preIcon:"ant-design:save",onClick:t.onSubmit},{default:c(()=>[A("\u4FDD\u5B58")]),_:1},8,["loading","onClick"]),t.aiTestMode?(E(),te("div",Rt,[u(x,{value:t.aiTestTable,"onUpdate:value":o[1]||(o[1]=y=>t.aiTestTable=y),placeholder:"\u8BF7\u9009\u62E9\u6D4B\u8BD5\u7684\u8868\u7C7B\u578B",getPopupContainer:y=>y.parentElement,style:{width:"250px",margin:"0 10px 0 20px"}},{default:c(()=>[(E(!0),te(We,null,Ze(t.aiTableList,(y,v)=>(E(),H(N,{key:v,value:y.name},{default:c(()=>[A(Xe(y.title+"\uFF08"+y.name+"\uFF09"),1)]),_:2},1032,["value"]))),128))]),_:1},8,["value","getPopupContainer"]),u(D,{type:"primary",ghost:"",onClick:t.initVirtualData},{default:c(()=>[A("\u751F\u6210\u6570\u636E>>")]),_:1},8,["onClick"])])):ae("",!0)]),default:c(()=>[u(I,{wrapperClassName:"p-2",spinning:t.confirmLoading},{default:c(()=>[u(C,{onRegister:t.registerForm},{extConfigButton:c(()=>[et("div",kt,[u(D,{preIcon:"ant-design:setting",onClick:t.onOpenExtConfig},{default:c(()=>[A("\u6269\u5C55\u914D\u7F6E")]),_:1},8,["onClick"])])]),_:1},8,["onRegister"]),u(I,{spinning:t.tableLoading||t.hideTabs},{default:c(()=>[t.hideTabs?ae("",!0):(E(),H(w,{key:0,activeKey:t.activeKey,"onUpdate:activeKey":o[0]||(o[0]=y=>t.activeKey=y),animated:"",onChange:t.onTabsChange},{default:c(()=>[u(m,{tab:"\u6570\u636E\u5E93\u5C5E\u6027",key:"dbTable",forceRender:""},{default:c(()=>[u(p,{ref:"dbTable",actionButton:t.actionButton,onAdded:t.onTableAdded,onRemoved:t.onTableRemoved,onDragged:t.onTableDragged,onInserted:t.onTableInserted,onSyncDbType:t.onTableSyncDbType},null,8,["actionButton","onAdded","onRemoved","onDragged","onInserted","onSyncDbType"])]),_:1}),u(m,{tab:"\u9875\u9762\u5C5E\u6027",key:"pageTable",forceRender:""},{default:c(()=>[u(O,{ref:"pageTable"},null,512)]),_:1}),u(m,{tab:"\u6821\u9A8C\u5B57\u6BB5",key:"checkTable",forceRender:""},{default:c(()=>[u(s,{ref:"checkTable"},null,512)]),_:1}),u(m,{tab:"\u5916\u952E",key:"fkTable",forceRender:""},{default:c(()=>[u($,{ref:"fkTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),u(m,{tab:"\u7D22\u5F15",key:"idxTable",forceRender:""},{default:c(()=>[u(J,{ref:"idxTable",actionButton:t.actionButton},null,8,["actionButton"])]),_:1}),u(m,{tab:"\u67E5\u8BE2\u914D\u7F6E",key:"queryTable",forceRender:""},{default:c(()=>[u(Q,{ref:"queryTable",onQuery:t.onTableQuery},null,8,["onQuery"])]),_:1})]),_:1},8,["activeKey","onChange"]))]),_:1},8,["spinning"])]),_:1},8,["spinning"]),u(K,{onRegister:t.registerExtendConfigModal,parentForm:t.formAction,onOk:t.onExtConfigOk},null,8,["onRegister","parentForm","onOk"])]),_:1},16,["title","confirmLoading","onCancel","onRegister"])}var Ot=ze(Dt,[["render",Bt]]),al=Object.freeze(Object.defineProperty({__proto__:null,default:Ot},Symbol.toStringTag,{value:"Module"}));export{Ot as C,Wa as a,Za as b,Xa as c,el as d,tl as e,al as f,Ya as l};

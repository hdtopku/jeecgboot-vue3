import{B as e}from"./index.ee0a0c33.js";import{B as a}from"./BasicForm.79466d99.js";import"./helper.ec3e26f3.js";import{u as t}from"./useForm.ee23be26.js";import"./JAddInput.c8a1b05b.js";import{a1 as l,l as o,F as n,o as i,bB as r,bH as s,a8 as d,bI as c,f0 as u,f1 as b,Q as f,a$ as m,t as p,v as T,V as g,z as y,y as v,C as h,x as j,ax as C,bc as x,D as k,W as R,aW as D,B as F,ac as O,bN as w,u as S}from"./index.b3c93d64.js";import{u as I}from"./useSchemas.9d70572e.js";import B from"./DBAttributeTable.0b267035.js";import _ from"./PageAttributeTable.f913fc9c.js";import M from"./CheckDictTable.2406f5a2.js";import P from"./ForeignKeyTable.9784e750.js";import A from"./IndexTable.4584a013.js";import L from"./QueryTable.d8253783.js";import N from"./ExtendConfigModal.30615ea5.js";import{u as E,E as J,a as q,V as K}from"./cgform.data.35cb6cbd.js";import{u as Q}from"./useOnlineTest.06579696.js";import{g as V}from"./useAutoForm.99026cbc.js";import"./BasicModal.2a8ad889.js";import"./useWindowSizeFn.e6386ae5.js";import"./uniqBy.30d2558a.js";import"./useFormItem.d029403d.js";import"./functional.3bb51b91.js";import"./download.261c8978.js";import"./base64Conver.030fa32c.js";import"./index.d2e70b0d.js";import"./index.17ec2e33.js";import"./useCountdown.cb4ad478.js";import"./JUpload.6bcc6fce.js";import"./api.dced5d87.js";import"./index.ef2039b9.js";import"./props.a4f5d1ca.js";import"./index.c4683457.js";import"./bem.3d3e77ca.js";import"./props.c13d8268.js";import"./useContextMenu.de287960.js";import"./index.9bbe419b.js";import"./onMountedOrActivated.d3784e6c.js";import"./index.36d6c198.js";import"./htmlmixed.ba3cd961.js";import"./vue.8c416d71.js";/* empty css             */import"./depart.api.429e062c.js";import"./validator.08db3aa9.js";import"./user.api.f4883dd0.js";import"./useTableSync.03a6700e.js";import"./pick.dbff1c58.js";import"./_flatRest.ff1861ce.js";import"./isArray.40a4ed15.js";import"./toString.cf909882.js";import"./_arrayPush.8821345e.js";import"./LinkTableConfigModal.ddb9013a.js";import"./omit.d6518a29.js";import"./_baseClone.a8082016.js";import"./_baseSlice.23bb44df.js";import"./LinkTableFieldConfigModal.c8372a08.js";import"./FormSchemaFactory.936572ec.js";import"./JUploadModal.99ff436d.js";import"./_commonjsHelpers.7ef9cff5.js";import"./customExpression.58041e91.js";import"./OnlineSelectCascade.dcdd0bf2.js";import"./BasicTable.cdd414e6.js";import"./index.4258d6df.js";import"./useContentHeight.7565ed37.js";import"./useContentViewHeight.d3266665.js";import"./usePageContext.f338fb2a.js";import"./RedoOutlined.c563bb0b.js";import"./TableImg.6cb3a734.js";import"./useListPage.4511beac.js";import"./useTable.4670d269.js";import"./Area.12431eca.js";import"./LinkTableListPiece.fe1feec9.js";import"./JModalTip.1007764b.js";var H=Object.defineProperty,U=Object.defineProperties,$=Object.getOwnPropertyDescriptors,z=Object.getOwnPropertySymbols,W=Object.prototype.hasOwnProperty,G=Object.prototype.propertyIsEnumerable,Y=(e,a,t)=>a in e?H(e,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[a]=t,X=(e,a)=>{for(var t in a||(a={}))W.call(a,t)&&Y(e,t,a[t]);if(z)for(var t of z(a))G.call(a,t)&&Y(e,t,a[t]);return e},Z=(e,a,t)=>new Promise(((l,o)=>{var n=e=>{try{r(t.next(e))}catch(a){o(a)}},i=e=>{try{r(t.throw(e))}catch(a){o(a)}},r=e=>e.done?l(e.value):Promise.resolve(e.value).then(n,i);r((t=t.apply(e,a)).next())}));const ee=e=>l.get({url:"/online/cgform/head/list",params:e}),ae=e=>le(e,0),te=e=>le(e,1);function le(e,a){return l.delete({url:"/online/cgform/head/deleteBatch",params:{ids:e.join(","),flag:a}},{joinParamsToUrl:!0})}const oe=(e,a)=>l.post({url:`/online/cgform/api/doDbSynch/${e}/${a}`,timeout:12e3,timeoutErrorMessage:"同步数据库超时，已自动刷新"}),ne=e=>l.post({url:`/online/cgform/head/copyOnline?code=${e}`}),ie=(e,a,t)=>l.get({url:`/online/cgform/head/copyOnlineTable/${e}`,params:X({tableName:a},t)}),re=(e,a)=>l.get({url:"/online/cgform/field/listByHeadId",params:X({headId:e},a)}),se=(e,a)=>l.get({url:"/online/cgform/index/listByHeadId",params:X({headId:e},a)}),de=(e,a)=>a?l.put({url:"/online/cgform/api/editAll",params:e}):l.post({url:"/online/cgform/api/addAll",params:e}),ce=e=>l.put({url:"/online/cgform/head/edit",params:e}),ue=o({name:"CgformModal",components:{BasicModal:e,BasicForm:a,DBAttributeTable:B,PageAttributeTable:_,CheckDictTable:M,ForeignKeyTable:P,IndexTable:A,QueryTable:L,ExtendConfigModal:N},emits:["success","register"],props:{actionButton:{type:Boolean,default:!0,required:!1}},setup(e,{emit:a}){const{createMessage:l}=S(),o=n(),u=n(!1);let p={};const T=i((()=>u.value?"编辑":"新增")),g=n(!0),y=n(!1),v=n("dbTable"),h=n(!0),j={dbTable:n(),pageTable:n(),checkTable:n(),fkTable:n(),idxTable:n(),queryTable:n()},C=i((()=>{var e,a;return null!=(a=null==(e=o.value)?void 0:e.fullScreenRef)&&a}));r("tables",j),r("fullScreenRef",C);const{formSchemas:x}=I(e,{onTableTypeChange:function(e){1===e&&F({themeTemplate:"normal"});j.pageTable.value.changePageType(3==e)},onIsTreeChange:function(e){"Y"===e?function(){if(!z){let{dbTable:e,pageTable:a,checkTable:t}=j,l=q();l=l.filter((a=>!e.value.tableRef.getTableData().map((e=>e.dbFieldName)).includes(a.dbFieldName))),W=[],l.forEach((e=>{let a=m()+"__tempId";W.push(a),e.id=a})),e.value.tableRef.addRows(l,{setActive:!1}),a.value.tableRef.addRows(l,{setActive:!1}),t.value.tableRef.addRows(l,{setActive:!1}),f((()=>ie())),z=!0}f((()=>{R.setFieldsValue({treeIdField:"has_child",treeParentIdField:"pid"})}))}():function(){if(W&&W.length>0){let{dbTable:e}=j;e.value.tableDeleteLines(W),W=[],z=!1}}()},ifShowOfSubTableStr:()=>H}),[k,R]=t({schemas:x,showActionButtonGroup:!1,labelAlign:"right"}),{resetFields:D,setFieldsValue:F,validate:B}=R,[_,{closeModal:M}]=s((e=>{var a;u.value=null!=(a=null==e?void 0:e.isUpdate)&&a,u.value?oe(null==e?void 0:e.record):oe({})})),P=n("");let A=d({});const L=w((()=>function(){return Z(this,null,(function*(){let{dbTable:e,pageTable:a,checkTable:t,fkTable:l,queryTable:o}=j;yield a.value.syncTable(e),yield t.value.syncTable(e),yield l.value.syncTable(e),yield o.value.syncTable(e)}))}()),150);let N=[],H=!1,z=!1,W=[];const{aiTestMode:G,aiTestTable:Y,aiTableList:ee,initVirtualData:ae,tableJsonGetHelper:te,refreshCacheTableName:le}=Q();function oe(e){return Z(this,null,(function*(){var a,t;if(g.value=!1,v.value="dbTable",yield D(),p=Object.assign({},e),z="Y"==(t=p).isTree,H=2===t.tableType,te(p),function(e){let a={};if(e.extConfigJson)try{a=JSON.parse(e.extConfigJson)}catch(t){}A=Object.assign({},J,a,{isDesForm:e.isDesForm||"N",desFormCode:e.desFormCode||""})}(p),F(p),P.value=p.tableName,b(1,(()=>h.value=!1)),u.value)null==(a=j.dbTable.value)||a.setDataSource([]),yield function(e){return Z(this,null,(function*(){y.value=!0;try{let a=yield re(e);y.value=!1,yield ne(a)}finally{y.value=!1}}))}(p.id),yield function(e){return Z(this,null,(function*(){let a=yield se(e);j.idxTable.value.setDataSource(a)}))}(p.id),V(j.pageTable).then((()=>{j.pageTable.value.changePageType(3==p.tableType)}));else{let{initialData:e,tempIds:a}=E();yield ne(e,!0),N=a}}))}function ne(e,a){return Z(this,null,(function*(){const{dbTable:t,pageTable:l,checkTable:o,fkTable:n,queryTable:i}=j;t.value||(yield f(),yield b(1)),t.value.setDataSource(e,a),setTimeout((()=>{l.value.setDataSource(e,a),o.value.setDataSource(e,a),n.value.setDataSource(e,a),i.value.setDataSource(e,a)}),10)}))}function ie(){L()}function ue(){let e={};return new Promise(((e,a)=>{B().then((a=>e({values:a})),(()=>a(K)))})).then((a=>(Object.assign(e,a),function(){return new Promise(((e,a)=>Z(this,null,(function*(){let t=Object.keys(j),l={};for(let e=0;e<t.length;e++){let n=t[e],i=j[n];try{l[n]=yield i.value.validateData(n)}catch(o){return o.code===K&&(v.value=o.activeKey),void a(o)}}e(l)}))))}()))).then((a=>{Object.assign(e,a);let t=function(e){let a={head:{},fields:[],indexs:[],deleteFieldIds:[],deleteIndexIds:[]};return a.head=Object.assign(p,e.values),a.head.isDesForm=A.isDesForm,a.head.desFormCode=A.desFormCode,delete A.isDesForm,delete A.desFormCode,a.head.extConfigJson=JSON.stringify(A),e.dbTable.tableData.forEach(((t,l)=>{let o=t.id,n=Object.assign({},t),i=e.pageTable.tableData[l];n=Object.assign(i,n);let r=e.checkTable.tableData[l];n=Object.assign(r,n);let s=e.fkTable.tableData[l];n=Object.assign(s,n);let d=e.queryTable.tableData[l];n=Object.assign(d,n),null==o||""===o?delete n.id:n.id=o,[].concat(N,W).includes(n.id)&&delete n.id,a.fields.push(n)})),a.deleteFieldIds=e.dbTable.deleteIds,a.indexs=e.idxTable.tableData,a.deleteIndexIds=e.idxTable.deleteIds,a}(e);return function(e){return new Promise(((a,t)=>{let l=e.fields,o=!0;if(l&&l.length>0){let e=0;for(let a=0;a<l.length;a++)if((l[a].mainField||l[a].mainTable)&&(e+=1),e>1){o=!1;break}}o?a(e):t({code:-1,msg:"外键只允许配置一个!",error:K})}))}(t)})).catch((e=>(e!==K&&(null==e?void 0:e.code)!==K||l.warning("校验未通过"),Promise.reject(null))))}const[be,fe]=c();function me(){h.value=!0,b(1,(()=>M()))}return pe=X({},j),U(pe,$({modalRef:o,title:T,confirmLoading:g,tableLoading:y,activeKey:v,onCancel:me,extConfigJson:A,formAction:R,hideTabs:h,onSubmit:function(){g.value=!0,ue().then((e=>Z(this,null,(function*(){var t;if(e.fields&&e.fields.length>0)for(let a of e.fields)a.dbFieldName=a.dbFieldName.toLowerCase().trim();(null==(t=e.head)?void 0:t.tableName)&&(e.head.tableName=e.head.tableName.toLowerCase().trim()),yield de(e,u.value),le(P.value,e.head.tableName),a("success"),b(1,(()=>me()))}))),(e=>{})).finally((()=>{g.value=!1}))},onTabsChange:function(e){if(-1!==["pageTable","checkTable","fkTable","idxTable","queryTable"].indexOf(e)){const a=j.dbTable,t=j[e];a.value.tableRef.resetScrollTop(),t.value.syncTable(a)}},onTableAdded:function(){ie()},onTableRemoved:function(){ie()},onTableDragged:function(e){let{oldIndex:a,newIndex:t}=e;!function(e,a){let{pageTable:t,checkTable:l,fkTable:o,queryTable:n}=j;t.value.tableRef.rowResort(e,a),l.value.tableRef.rowResort(e,a),o.value.tableRef.rowResort(e,a),n.value.tableRef.rowResort(e,a)}(a,t)},onTableInserted:function(e){return Z(this,null,(function*(){let{insertIndex:a,row:t}=e,{pageTable:l,checkTable:o,fkTable:n,queryTable:i}=j;l.value.tableRef.insertRows(t,a),o.value.tableRef.insertRows(t,a),n.value.tableRef.insertRows(t,a),i.value.tableRef.insertRows(t,a)}))},onTableSyncDbType:function(e){j.pageTable.value.syncFieldShowType(e.row)},onTableQuery:function(e){j.pageTable.value.enableQuery(e)},onOpenExtConfig:function(){fe.openModal(!0,{extConfigJson:A})},onExtConfigOk:function(e){return Z(this,null,(function*(){if(A=e,1==u.value){let e=O(A);const t={id:p.id,extConfigJson:JSON.stringify(e)};yield ce(t),a("success")}}))},registerForm:k,registerModal:_,registerExtendConfigModal:be,aiTestMode:G,aiTestTable:Y,aiTableList:ee,initVirtualData:ae}));var pe}}),be={style:{flex:"1","text-align":"right"}},fe={key:0,style:{display:"inline-block","text-align":"left",position:"absolute",left:"0"}};var me=u(ue,[["render",function(e,a,t,l,o,n){const i=p("a-button"),r=p("BasicForm"),s=p("DBAttributeTable"),d=p("a-tab-pane"),c=p("PageAttributeTable"),u=p("CheckDictTable"),b=p("ForeignKeyTable"),f=p("IndexTable"),m=p("QueryTable"),O=p("a-tabs"),w=p("a-spin"),S=p("a-select-option"),I=p("a-select"),B=p("ExtendConfigModal"),_=p("BasicModal");return T(),g(_,F({ref:"modalRef",title:e.title,width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:e.confirmLoading},e.$attrs,{onCancel:e.onCancel,onRegister:e.registerModal}),{footer:y((()=>[v(i,{onClick:e.onCancel},{default:y((()=>[h("关闭")])),_:1},8,["onClick"]),v(i,{type:"primary",loading:e.confirmLoading,preIcon:"ant-design:save",onClick:e.onSubmit},{default:y((()=>[h("保存")])),_:1},8,["loading","onClick"]),e.aiTestMode?(T(),j("div",fe,[v(I,{value:e.aiTestTable,"onUpdate:value":a[1]||(a[1]=a=>e.aiTestTable=a),placeholder:"请选择测试的表类型",getPopupContainer:e=>e.parentElement,style:{width:"250px",margin:"0 10px 0 20px"}},{default:y((()=>[(T(!0),j(C,null,x(e.aiTableList,((e,a)=>(T(),g(S,{key:a,value:e.name},{default:y((()=>[h(k(e.title+"（"+e.name+"）"),1)])),_:2},1032,["value"])))),128))])),_:1},8,["value","getPopupContainer"]),v(i,{type:"primary",ghost:"",onClick:e.initVirtualData},{default:y((()=>[h("生成数据>>")])),_:1},8,["onClick"])])):R("",!0)])),default:y((()=>[v(w,{wrapperClassName:"p-2",spinning:e.confirmLoading},{default:y((()=>[v(r,{onRegister:e.registerForm},{extConfigButton:y((()=>[D("div",be,[v(i,{preIcon:"ant-design:setting",onClick:e.onOpenExtConfig},{default:y((()=>[h("扩展配置")])),_:1},8,["onClick"])])])),_:1},8,["onRegister"]),v(w,{spinning:e.tableLoading||e.hideTabs},{default:y((()=>[e.hideTabs?R("",!0):(T(),g(O,{key:0,activeKey:e.activeKey,"onUpdate:activeKey":a[0]||(a[0]=a=>e.activeKey=a),animated:"",onChange:e.onTabsChange},{default:y((()=>[v(d,{tab:"数据库属性",key:"dbTable",forceRender:""},{default:y((()=>[v(s,{ref:"dbTable",actionButton:e.actionButton,onAdded:e.onTableAdded,onRemoved:e.onTableRemoved,onDragged:e.onTableDragged,onInserted:e.onTableInserted,onSyncDbType:e.onTableSyncDbType},null,8,["actionButton","onAdded","onRemoved","onDragged","onInserted","onSyncDbType"])])),_:1}),v(d,{tab:"页面属性",key:"pageTable",forceRender:""},{default:y((()=>[v(c,{ref:"pageTable"},null,512)])),_:1}),v(d,{tab:"校验字段",key:"checkTable",forceRender:""},{default:y((()=>[v(u,{ref:"checkTable"},null,512)])),_:1}),v(d,{tab:"外键",key:"fkTable",forceRender:""},{default:y((()=>[v(b,{ref:"fkTable",actionButton:e.actionButton},null,8,["actionButton"])])),_:1}),v(d,{tab:"索引",key:"idxTable",forceRender:""},{default:y((()=>[v(f,{ref:"idxTable",actionButton:e.actionButton},null,8,["actionButton"])])),_:1}),v(d,{tab:"查询配置",key:"queryTable",forceRender:""},{default:y((()=>[v(m,{ref:"queryTable",onQuery:e.onTableQuery},null,8,["onQuery"])])),_:1})])),_:1},8,["activeKey","onChange"]))])),_:1},8,["spinning"])])),_:1},8,["spinning"]),v(B,{onRegister:e.registerExtendConfigModal,parentForm:e.formAction,onOk:e.onExtConfigOk},null,8,["onRegister","parentForm","onOk"])])),_:1},16,["title","confirmLoading","onCancel","onRegister"])}]]),pe=Object.freeze(Object.defineProperty({__proto__:null,default:me},Symbol.toStringTag,{value:"Module"}));export{me as C,ae as a,te as b,oe as c,ne as d,ie as e,pe as f,ee as l};

var y=Object.defineProperty;var d=Object.getOwnPropertySymbols;var C=Object.prototype.hasOwnProperty,S=Object.prototype.propertyIsEnumerable;var g=(t,e,n)=>e in t?y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n,p=(t,e)=>{for(var n in e||(e={}))C.call(e,n)&&g(t,n,e[n]);if(d)for(var n of d(e))S.call(e,n)&&g(t,n,e[n]);return t};var m=(t,e,n)=>new Promise((o,r)=>{var a=s=>{try{i(n.next(s))}catch(u){r(u)}},l=s=>{try{i(n.throw(s))}catch(u){r(u)}},i=s=>s.done?o(s.value):Promise.resolve(s.value).then(a,l);i((n=n.apply(t,e)).next())});import{d5 as getAuthCache,d6 as setAuthCache,F as ref,a7 as reactive,d7 as useRouter,L as unref,j as filterMultiDictText,h,d8 as markRaw,d9 as defineAsyncComponent,da as importViewsFile,ab as toRaw,u as useMessage,a1 as defHttp}from"./index.6c1aeca2.js";import{useMethods}from"./useMethods.eccfa16d.js";function httpGroupRequest(t,e,n=1e3*30){return e==null||e===""?(console.log("--------popup----------getFrom  DB-------with---no--groupId "),t()):getAuthCache(e)?(console.log("---------popup--------getFrom  Cache--------groupId = "+e),Promise.resolve(getAuthCache(e))):(console.log("--------popup----------getFrom  DB---------groupId = "+e),t().then(o=>(setAuthCache(e,o),Promise.resolve(o))))}function usePopBiz(props,tableRef){const{createMessage}=useMessage(),visible=ref(!1),loading=ref(!1),cgRpConfigId=ref(""),title=ref("\u5217\u8868"),iSorter=ref(""),queryInfo=ref([]),queryParam=ref({}),dynamicParam=ref({}),dictOptions=ref({}),dataSource=ref([]),columns=ref([]),configUrl=reactive({getColumnsAndData:"/online/cgreport/api/getColumnsAndData/",getColumns:"/online/cgreport/api/getRpColumns/",getData:"/online/cgreport/api/getData/",getQueryInfo:"/online/cgreport/api/getQueryInfo/",export:"/online/cgreport/api/exportManySheetXls/"}),checkedKeys=ref([]),selectRows=ref([]);let clickThenCheckFlag=!0;props.clickToRowSelect===!1&&(clickThenCheckFlag=!1);const rowSelection={fixed:!0,selectedRowKeys:checkedKeys,selectionRows:selectRows,onChange:onSelectChange},indexColumnProps={dataIndex:"index",width:"15px"},pagination=reactive({current:1,pageSize:10,pageSizeOptions:["10","20","30"],showQuickJumper:!0,showSizeChanger:!0,total:0,showTotal:t=>onShowTotal(t),realPageSize:10,realTotal:0,isTotal:"",onShowSizeChange:(t,e)=>onSizeChange(t,e)});function onSelectChange(t){if(!t||t.length==0)selectRows.value=[];else for(let e=0;e<t.length;e++){let n=combineRowKey(getRowByKey(t[e])),o=unref(checkedKeys);if(n&&o.indexOf(n)<0){let r=getRowByKey(t[e]);r&&selectRows.value.push(r)}}checkedKeys.value=t}function filterUnuseSelect(){selectRows.value=unref(selectRows).filter(t=>{let e=combineRowKey(t);return unref(checkedKeys).indexOf(e)>=0})}function getRowByKey(t){let e=unref(dataSource).filter(n=>combineRowKey(n)===t);return e&&e.length>0?e[0]:""}function combineRowKey(t){let e=(t==null?void 0:t.id)||"";return Object.keys(t).forEach(n=>{e=n=="rowIndex"?t[n]+e:e+t[n]}),e=e.length>50?e.substring(0,50):e,e}function loadColumnsInfo(){let t=`${configUrl.getColumns}${props.code}`,e=props.groupId?`${props.groupId}${t}`:"";httpGroupRequest(()=>defHttp.get({url:t},{isTransformResponse:!1,successMessageMode:"none"}),e).then(n=>{if(n.success){initDictOptionData(n.result.dictOptions),cgRpConfigId.value=n.result.cgRpConfigId,title.value=n.result.cgRpConfigName;let o=n.result.columns;for(let r=0;r<o.length;r++){if(o[r].customRender){let a=o[r].customRender;o[r].customRender=({text:l})=>filterMultiDictText(unref(dictOptions)[a],l+"")}unref(iSorter)&&o[r].dataIndex===unref(iSorter).column&&(o[r].sortOrder=unref(iSorter).order==="asc"?"ascend":"descend")}o[0].key!=="rowIndex"&&o.unshift({title:"\u5E8F\u53F7",dataIndex:"rowIndex",key:"rowIndex",width:60,align:"center",customRender:function({text:r}){return parseInt(r)+1}}),columns.value=[...o],initQueryInfo(null)}})}function loadColumnsAndData(){pagination.isTotal="";let t=`${configUrl.getColumnsAndData}${props.id}`,e=props.groupId?`${props.groupId}${t}`:"";httpGroupRequest(()=>defHttp.get({url:t},{isTransformResponse:!1,successMessageMode:"none"}),e).then(n=>{if(n.success){initDictOptionData(n.result.dictOptions),cgRpConfigId.value=props.id;let{columns:o,cgreportHeadName:r,fieldHrefSlots:a,isGroupTitle:l}=n.result;title.value=r;const i={};a.forEach(u=>i[u.slotName]=u);let s=handleColumnHrefAndDict(o,i);clickThenCheckFlag===!0&&s.unshift({title:"\u5E8F\u53F7",dataIndex:"rowIndex",key:"rowIndex",width:60,align:"center",customRender:function({text:u}){return parseInt(u)+1}}),l===!0&&(s=handleGroupTitle(s)),columns.value=[...s],initQueryInfo(n.result.data)}else createMessage.warning(n.message)})}function handleSumColumn(t,e){let n=getNeedSumColumns(t);if(pagination.isTotal==""&&(n.length>0?(pagination.isTotal=!0,dataSource.value.length==pagination.pageSize&&dataSource.value.pop(),pagination.realPageSize=pagination.pageSize-1):pagination.isTotal=!1),pagination.isTotal){let o={};n.forEach(r=>{let a=0;dataSource.value.forEach(i=>{i[r]!=null&&i[r]!=""&&(a+=parseFloat(i[r]))}),o[r]=isNaN(a)?"\u5305\u542B\u975E\u6570\u5B57\u5185\u5BB9":a.toFixed(2);let l=t.find(i=>i.dataIndex==r);l&&l.fieldType=="Long"&&(o[r]=parseInt(o[r]))}),dataSource.value.push(o),pagination.realTotal=e,pagination.total=Number(e)+Number(Math.floor(e/pagination.realPageSize))}}function getNeedSumColumns(t){let e=[];for(let n of t)if(n.isTotal==="1"&&e.push(n.dataIndex),n.children&&n.children.length>0){let o=getNeedSumColumns(n.children);o.length>0&&e.push(...o)}return e}function handleColumnHrefAndDict(t,e){for(let n of t){let{customRender:o,hrefSlotName:r,fieldType:a}=n;if(a=="Date")n.customRender=({text:l})=>l?l.length>10?l.substring(0,10):l:"";else if(!r&&n.scopedSlots&&n.scopedSlots.customRender&&e.hasOwnProperty(n.scopedSlots.customRender)&&(r=n.scopedSlots.customRender),o||r){let l=o,i="_replace_text_";n.customRender=({text:s,record:u})=>{let c=s;if(l)if(l.startsWith(i)){let f=l.replace(i,"");c=u[f]}else c=filterMultiDictText(unref(dictOptions)[l],s+"");if(n.showLength&&c&&c.length>n.showLength&&(c=c.substr(0,n.showLength)+"..."),r){let f=e[r];if(f)return h("a",{onClick:()=>handleClickFieldHref(f,u)},c)}return c}}}return t}function handleGroupTitle(t){let e=[];for(let n of t)if(unref(iSorter)&&n.dataIndex===unref(iSorter).column&&(n.sortOrder=unref(iSorter).order==="asc"?"ascend":"descend"),n.groupTitle){let o=e.findIndex(r=>r.title===n.groupTitle);if(o!==-1)e[o].children.push(n);else{let r={},a=[];a.push(n),r.title=n.groupTitle,r.align="center",r.children=a,e.push(r)}}else e.push(n);return e}let router=useRouter();function handleClickFieldHref(field,record){let href=field.href,urlPattern=/(ht|f)tp(s?)\:\/\/[0-9a-zA-Z]([-.\w]*[0-9a-zA-Z])*(:(0-9)*)*(\/?)([a-zA-Z0-9\-\.\?\,\'\/\\\+&amp;%\$#_]*)?/,compPattern=/\.vue(\?.*)?$/,jsPattern=/{{([^}]+)}}/g;typeof href=="string"&&(href=href.trim().replace(/\${([^}]+)?}/g,(t,e)=>record[e]),jsPattern.test(href)&&(href=href.replace(jsPattern,function(text,s0){try{return eval(s0)}catch(t){return console.error(t),text}})),urlPattern.test(href)?window.open(href,"_blank"):compPattern.test(href)?openHrefCompModal(href):router.push(href))}function handleExport(){const{handleExportXls:t}=useMethods();let e=`${configUrl.export}${cgRpConfigId.value}`,n=getQueryParams(),o=unref(checkedKeys);o.length>0&&(n.force_id=o.map(r=>{var a;return(a=getRowByKey(r))==null?void 0:a.id}).filter(r=>r!=null&&r!=="").join(",")),t(title.value,e,n)}function onSizeChange(t,e){pagination.isTotal="",pagination.pageSize=e,pagination.isTotal?pagination.realPageSize=e-1:pagination.realPageSize=e,pagination.current=1}function onShowTotal(t){let e=(pagination.current-1)*pagination.realPageSize+1,n=e+(pagination.isTotal?dataSource.value.length-1:dataSource.value.length)-1,o=pagination.isTotal?pagination.realTotal:t;return e+"-"+n+" \u5171"+o+"\u6761"}function visibleChange(t){return m(this,null,function*(){visible.value=t,t&&loadColumnsInfo()})}function initQueryInfo(t){let e=`${configUrl.getQueryInfo}${unref(cgRpConfigId)}`,n=props.groupId?`${props.groupId}${e}`:"";httpGroupRequest(()=>defHttp.get({url:e},{isTransformResponse:!1,successMessageMode:"none"}),n).then(o=>{o.success?(dynamicParamHandler(o.result),queryInfo.value=o.result,console.log("queryInfo==>",queryInfo.value),t&&setDataSource(t),loadData(1)):createMessage.warning(o.message)})}function loadData(t){t==1&&(pagination.current=1);let e=getQueryParams();console.log("params",e),loading.value=!0;let n=`${configUrl.getData}${unref(cgRpConfigId)}`,o=props.groupId?`${props.groupId}${n}${JSON.stringify(e)}`:"";httpGroupRequest(()=>defHttp.get({url:n,params:e},{isTransformResponse:!1,successMessageMode:"none"}),o).then(r=>{loading.value=!1;let a=r.result;console.log("\u8868\u683C\u4FE1\u606F:",a),setDataSource(a)})}function setDataSource(t){var e;if(t){pagination.total=Number(t.total);let n=(e=pagination==null?void 0:pagination.current)!=null?e:1;for(let o=0;o<t.records.length;o++)t.records[o].rowIndex||(t.records[o].rowIndex=o+(n-1)*10);dataSource.value=t.records}else pagination.total=0,dataSource.value=[];handleSumColumn(columns.value,pagination.total)}function getQueryParams(){let t={};unref(dynamicParam)&&Object.keys(unref(dynamicParam)).map(n=>{t["self_"+n]=unref(dynamicParam)[n]});let e=Object.assign(t,unref(queryParam),unref(iSorter));return e.pageNo=pagination.current,e.pageSize=pagination.realPageSize,filterObj(e)}function dynamicParamHandler(t){if(t&&t.length>0){let n={};for(let o of t)o.mode==="single"&&(n[o.field]="");queryParam.value=p({},n)}props.routeQuery&&(queryParam.value=Object.assign(queryParam.value,props.routeQuery));let e={};props.param&&Object.keys(props.param).map(n=>{let o=props.param[n];n in queryParam&&(o&&o.startsWith("'")&&o.endsWith("'")&&(o=o.substring(1,o.length-1)),unref(queryParam)[n]=o),e[n]=props.param[n]}),dynamicParam.value=p({},e)}function handleChangeInTable(t,e,n){console.log(t,e,n),Object.keys(n).length>0&&(iSorter.value={column:n.field,order:n.order==="ascend"?"asc":"desc"},unref(columns).forEach(o=>{o.dataIndex===n.field&&(o.sortOrder=n.order)})),pagination.current=t.current,pagination.pageSize=t.pageSize,loadData()}function clickThenCheck(t){if(clickThenCheckFlag===!0){let e=combineRowKey(t);if(!unref(checkedKeys)||unref(checkedKeys).length==0){let n=[],o=[];n.push(t),o.push(e),checkedKeys.value=o,selectRows.value=n}else if(unref(checkedKeys).indexOf(e)<0)checkedKeys.value.push(e),selectRows.value.push(t);else{let n=unref(checkedKeys).indexOf(e);checkedKeys.value.splice(n,1),selectRows.value.splice(n,1)}}}function initDictOptionData(t){let e={};Object.keys(t).map(n=>{e[n]=t[n].filter(o=>o!=null)}),dictOptions.value=e}function filterObj(t){if(typeof t=="object"){for(let e in t)t.hasOwnProperty(e)&&(t[e]==null||t[e]==null||t[e]==="")&&delete t[e];return t}}const dialogStyle={top:0,left:0,height:"100%",margin:0,padding:0},hrefComponent=ref({model:{title:"",okText:"\u5173\u95ED",width:"100%",visible:!1,destroyOnClose:!0,style:dialogStyle,bodyStyle:{padding:"8px",height:"calc(100vh - 108px)",overflow:"auto",overflowX:"hidden"},cancelButtonProps:{style:{display:"none"}}},on:{ok:()=>hrefComponent.value.model.visible=!1,cancel:()=>hrefComponent.value.model.visible=!1},is:null,params:{}});function openHrefCompModal(t){let e=t.indexOf("?"),n=t;if(e!==-1){n=t.substring(0,e);let r=t.substring(e+1,t.length).split("&"),a={};r.forEach(l=>{let i=l.split("=");a[i[0]]=i[1]}),hrefComponent.value.params=a}else hrefComponent.value.params={};hrefComponent.value.model.visible=!0,hrefComponent.value.model.title="\u64CD\u4F5C",hrefComponent.value.is=markRaw(defineAsyncComponent(()=>importViewsFile(n)))}function getOkSelectRows(){let t=unref(selectRows),e=checkedKeys.value;if(console.log("arr",t),!e||e.length<=0)return[];if(!t||t.length<=0)return[];let n=[];for(let o of e)for(let r=0;r<t.length;r++){let a=combineRowKey(t[r]);if(o===a){n.push(toRaw(t[r]));break}}return n}return[{visibleChange,loadColumnsInfo,loadColumnsAndData,dynamicParamHandler,loadData,handleChangeInTable,combineRowKey,clickThenCheck,filterUnuseSelect,handleExport,getOkSelectRows},{hrefComponent,visible,rowSelection,checkedKeys,selectRows,pagination,dataSource,columns,indexColumnProps,loading,title,iSorter,queryInfo,queryParam,dictOptions}]}export{usePopBiz as u};

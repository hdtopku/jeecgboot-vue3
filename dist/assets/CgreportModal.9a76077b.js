import{B as ne}from"./index.696f9d2b.js";import{B as ie}from"./BasicForm.8686bc8b.js";import"./helper.dae66a79.js";import{u as se}from"./useForm.900aea93.js";import"./JAddInput.40436f5c.js";import{a1 as y,dz as i,l as ce,F as x,a7 as R,bG as de,o as pe,L as h,t as C,v as O,V as T,z as B,y as _,aV as b,C as D,B as me,u as j}from"./index.df6cbb3d.js";import{useJvxeMethod as fe}from"./useJvxeMethods.b894a75c.js";import{d as ge}from"./user.api.175c78d4.js";import"./BasicModal.e43862ee.js";import"./useWindowSizeFn.87f9f2e2.js";import"./uniqBy.e3808e33.js";import"./useFormItem.2be14484.js";import"./functional.78b6c3eb.js";import"./download.7309a450.js";import"./base64Conver.030fa32c.js";import"./index.bbb41f7e.js";import"./index.af8068b1.js";import"./useCountdown.62194240.js";import"./JUpload.b938f4f4.js";import"./api.1cb48a64.js";import"./index.9f431460.js";import"./props.bc182eb5.js";import"./index.c0884eed.js";import"./bem.5fa20b7a.js";import"./props.9345007b.js";import"./useContextMenu.c6597c00.js";import"./index.6f447a9e.js";import"./onMountedOrActivated.52712096.js";import"./index.c3549ccd.js";import"./htmlmixed.978f590c.js";import"./vue.26970574.js";/* empty css             */import"./depart.api.37e03c1e.js";import"./vxeUtils.80b68765.js";var he=Object.defineProperty,Fe=Object.defineProperties,Be=Object.getOwnPropertyDescriptors,M=Object.getOwnPropertySymbols,_e=Object.prototype.hasOwnProperty,ye=Object.prototype.propertyIsEnumerable,W=(t,u,o)=>u in t?he(t,u,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[u]=o,z=(t,u)=>{for(var o in u||(u={}))_e.call(u,o)&&W(t,o,u[o]);if(M)for(var o of M(u))ye.call(u,o)&&W(t,o,u[o]);return t},Ce=(t,u)=>Fe(t,Be(u)),$=(t,u,o)=>new Promise((m,E)=>{var f=d=>{try{c(o.next(d))}catch(S){E(S)}},F=d=>{try{c(o.throw(d))}catch(S){E(S)}},c=d=>d.done?m(d.value):Promise.resolve(d.value).then(f,F);c((o=o.apply(t,u)).next())});const{createConfirm:be}=j(),Ee="/online/cgreport/param/listByHeadId",ve="/online/cgreport/item/listByHeadId",Ct=t=>y.get({url:"/online/cgreport/head/list",params:t}),bt=(t,u)=>y.delete({url:"/online/cgreport/head/delete",params:t},{joinParamsToUrl:!0}).then(()=>{u()}),Et=(t,u)=>{be({title:"\u786E\u8BA4\u5220\u9664",content:"\u662F\u5426\u5220\u9664\u9009\u4E2D\u6570\u636E",okText:"\u786E\u8BA4",cancelText:"\u53D6\u6D88",iconType:"warning",onOk:()=>y.delete({url:"/online/cgreport/head/deleteBatch",data:t},{joinParamsToUrl:!0}).then(()=>{u()})})},Ae=(t,u)=>u?y.put({url:"/online/cgreport/head/editAll",params:t}):y.post({url:"/online/cgreport/head/add",params:t}),vt=t=>y.get({url:"/online/cgreport/api/getParamsInfo/"+t}),xe=()=>y.get({url:"/sys/dataSource/options"}),De=t=>y.get({url:"/online/cgreport/head/parseSql?"+t}),At=[{title:"\u62A5\u8868\u540D\u5B57",align:"center",dataIndex:"name",width:120},{title:"\u62A5\u8868\u7F16\u7801",align:"center",dataIndex:"code",width:120},{title:"\u62A5\u8868SQL",align:"center",dataIndex:"cgrSql",width:360},{title:"\u6570\u636E\u6E90",align:"center",dataIndex:"dbSource",width:120},{title:"\u521B\u5EFA\u65F6\u95F4",align:"center",dataIndex:"createTime",width:120}],xt=[{label:"\u62A5\u8868\u540D\u79F0",field:"name",component:"JInput"},{label:"\u62A5\u8868\u7F16\u7801",field:"code",component:"JInput"}],Se=/^[a-z|A-Z][a-z|A-Z|\d|_|-]{0,}$/,Pe=[{label:"",field:"id",component:"Input",show:!1},{label:"\u62A5\u8868\u7F16\u7801",field:"code",component:"Input",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},dynamicRules:({values:t,model:u})=>(console.log("values:",t),[{required:!0,validator:(o,m)=>new Promise((E,f)=>{if(!m)return f("\u8BF7\u8F93\u5165\u62A5\u8868\u7F16\u7801\uFF01");if(!Se.test(m))return f("\u7F16\u7801\u5FC5\u987B\u4EE5\u5B57\u6BCD\u5F00\u5934\uFF0C\u53EF\u5305\u542B\u6570\u5B57\u3001\u4E0B\u5212\u7EBF\u3001\u6A2A\u6760\uFF01");let F={tableName:"onl_cgreport_head",fieldName:"code",fieldVal:m,dataId:u.id};ge(F).then(c=>{c.success?E():f("\u62A5\u8868\u7F16\u7801\u5DF2\u5B58\u5728!")}).catch(c=>{f(c.message||"\u6821\u9A8C\u5931\u8D25")})})}])},{label:"\u62A5\u8868\u540D\u5B57",field:"name",component:"Input",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},dynamicRules:()=>[{required:!0,message:"\u8BF7\u8F93\u5165\u62A5\u8868\u540D\u5B57!"}]},{label:"\u52A8\u6001\u6570\u636E\u6E90",field:"dbSource",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},component:"ApiSelect",componentProps:{api:xe}},{label:"\u62A5\u8868SQL",field:"cgrSql",component:"JCodeEditor",rules:[{required:!0,message:"\u8BF7\u586B\u5199\u62A5\u8868SQL"}],itemProps:{labelCol:{xs:24,sm:2},wrapperCol:{xs:24,sm:22}},componentProps:{height:"200px",fullScreen:!0},colProps:{span:20}},{label:" ",field:"analyseButton",component:"Input",slot:"analyseButton",colProps:{span:4},itemProps:{labelCol:{xs:1,sm:1},wrapperCol:{xs:23,sm:23},colon:!1}}],we=[{title:"\u53C2\u6570\u5B57\u6BB5",key:"paramName",type:i.input,width:"200px",placeholder:"\u8BF7\u8F93\u5165${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}\u4E0D\u80FD\u4E3A\u7A7A"}]},{title:"\u53C2\u6570\u6587\u672C",key:"paramTxt",type:i.input,width:"200px",placeholder:"\u8BF7\u8F93\u5165${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}\u4E0D\u80FD\u4E3A\u7A7A"}]},{title:"\u53C2\u6570\u9ED8\u8BA4\u503C",key:"paramValue",type:i.input,width:"200px",placeholder:"\u8BF7\u8F93\u5165${title}",defaultValue:""}],ke=[{title:"\u5B57\u6BB5\u540D\u5B57",key:"fieldName",type:i.input,minWidth:"150px",placeholder:"\u8BF7\u8F93\u5165${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}\u4E0D\u80FD\u4E3A\u7A7A"}]},{title:"\u5B57\u6BB5\u6587\u672C",key:"fieldTxt",type:i.input,minWidth:"150px",placeholder:"\u8BF7\u8F93\u5165${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}\u4E0D\u80FD\u4E3A\u7A7A"}]},{title:"\u5B57\u6BB5\u7C7B\u578B",key:"fieldType",minWidth:"150px",placeholder:"\u8BF7\u8F93\u5165${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}\u4E0D\u80FD\u4E3A\u7A7A"}],type:i.select,options:[{title:"\u6570\u503C\u7C7B\u578B",value:"Integer"},{title:"\u5B57\u7B26\u7C7B\u578B",value:"String"},{title:"\u65E5\u671F\u7C7B\u578B",value:"Date"},{title:"\u65F6\u95F4\u7C7B\u578B",value:"Datetime"},{title:"\u957F\u6574\u578B",value:"Long"}]},{title:"\u662F\u5426\u663E\u793A",key:"isShow",minWidth:"80px",align:"center",type:i.checkbox,customValue:[1,0],defaultChecked:!0},{title:"\u5B57\u6BB5href",key:"fieldHref",type:i.input,minWidth:"150px",placeholder:"\u8BF7\u8F93\u5165${title}",defaultValue:""},{title:"\u67E5\u8BE2\u6A21\u5F0F",key:"searchMode",type:i.select,minWidth:"150px",placeholder:"\u8BF7\u9009\u62E9${title}",options:[{title:"\u5355\u6761\u4EF6\u67E5\u8BE2",value:"single"},{title:"\u8303\u56F4\u67E5\u8BE2",value:"group"}]},{title:"\u53D6\u503C\u8868\u8FBE\u5F0F",key:"replaceVal",type:i.input,minWidth:"150px",placeholder:"\u8BF7\u8F93\u5165${title}",defaultValue:""},{title:"\u5B57\u5178code",key:"dictCode",type:i.input,minWidth:"150px",placeholder:"\u8BF7\u8F93\u5165${title}",defaultValue:""},{title:"\u5206\u7EC4\u6807\u9898",key:"groupTitle",type:i.input,minWidth:"150px",placeholder:"\u8BF7\u8F93\u5165${title}",defaultValue:""},{title:"\u662F\u5426\u67E5\u8BE2",key:"isSearch",type:i.checkbox,customValue:["1","0"],minWidth:"80px",align:"center",defaultChecked:!1},{title:"\u662F\u5426\u5408\u8BA1",align:"center",key:"isTotal",type:i.checkbox,customValue:["1","0"],minWidth:"80px",defaultChecked:!1}],Ie={style:{flex:"1","text-align":"left"}},Ve=b("br",null,null,-1),Le=b("br",null,null,-1),Oe=b("br",null,null,-1),Te=b("br",null,null,-1),$e=b("br",null,null,-1),qe=b("span",{style:{color:"red"}},"\u6CE8\uFF1A\u53C2\u6570\u53EA\u652F\u6301\u52A8\u6001\u62A5\u8868\uFF0Cpopup\u6682\u4E0D\u652F\u6301",-1),Ne=ce({__name:"CgreportModal",emits:["register","success"],setup(t,{emit:u}){const{createMessage:o}=j(),m=x(!0),E=x(!0),f=x(["onlCgreportItem","onlCgreportParam"]),F=x("onlCgreportItem"),c=x(),d=x(),S={onlCgreportItem:d,onlCgreportParam:c},v=R({loading:!1,dataSource:[],columns:we}),A=R({loading:!1,dataSource:[],columns:ke}),[J,{setProps:U,resetFields:K,setFieldsValue:Q,validate:Re,validateFields:H}]=se({schemas:Pe,showActionButtonGroup:!1}),[G,{setModalProps:P,closeModal:Z}]=de(e=>$(this,null,function*(){var r,l;yield ue(),P({confirmLoading:!1,showCancelBtn:e==null?void 0:e.showFooter,showOkBtn:e==null?void 0:e.showFooter}),m.value=!!(e!=null&&e.isUpdate),h(m)&&(yield Q(z({},e.record)),q(Ee,{headId:(r=e==null?void 0:e.record)==null?void 0:r.id},v),q(ve,{headId:(l=e==null?void 0:e.record)==null?void 0:l.id},A)),U({disabled:!(e!=null&&e.showFooter)})})),[X,Y,q,ee]=fe(re,oe,S,F,f),te=pe(()=>h(m)?"\u7F16\u8F91":"\u65B0\u589E");function ue(){return $(this,null,function*(){yield K(),F.value="onlCgreportItem",v.dataSource=[],A.dataSource=[]})}function oe(e){let r=Object.assign({},e.formValue);return Ce(z({},r),{onlCgreportParamList:e.tablesValue[1].tableData,onlCgreportItemList:e.tablesValue[0].tableData})}function re(e){return $(this,null,function*(){try{P({confirmLoading:!0});let r=[],l=[],a={};Object.keys(e).map(n=>{n=="onlCgreportItemList"?l=e[n]:n=="onlCgreportParamList"?r=e[n]:a[n]=e[n]});let s={head:a,params:r,items:l};console.log("\u62A5\u8868\u914D\u7F6E\u4FDD\u5B58\u8BF7\u6C42\u53C2\u6570",s),yield Ae(s,m.value),Z(),u("success")}finally{P({confirmLoading:!1})}})}function le(){P({confirmLoading:!0}),H(["cgrSql","dbSource"]).then(e=>{let{cgrSql:r,dbSource:l}=e,a="sql="+encodeURIComponent(r);l&&(a+="&dbKey="+l),console.log("urlParam----",a),De(a).then(s=>{if(s){o.success("\u89E3\u6790\u6210\u529F");let{fields:n,params:p}=s,g=n.filter(k=>k.fieldName!="__row_number__"),I=d.value.getTableData(),w=N(I,g||[],"fieldName");w=w.sort((k,L)=>k.orderNum-L.orderNum),A.dataSource=w;let ae=c.value.getTableData(),V=N(ae,p||[],"paramName");V=V.sort((k,L)=>k.orderNum-L.orderNum),v.dataSource=V}})}).catch(()=>{console.log("\u89E3\u6790\u5931\u8D25")}).finally(()=>{P({confirmLoading:!1})})}function N(e,r,l){if(e.length>0){let a=[],s=[],n=1;for(let p of r)for(let g of e)if(g[l]==p[l]){a.push(g),s.push(p[l]),g.orderNum>n&&(n=g.orderNum);break}for(let p of r)s.indexOf(p[l])<0&&(p.orderNum=++n,a.push(p));return a}else{let a=0;for(let s of r)s.orderNum||(s.orderNum=++a);return r}}return(e,r)=>{const l=C("a-icon"),a=C("a-popover"),s=C("a-button"),n=C("a-divider"),p=C("JVxeTable"),g=C("a-tab-pane"),I=C("a-tabs");return O(),T(h(ne),me(e.$attrs,{onRegister:h(G),title:h(te),width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:E.value,onOk:h(Y)}),{default:B(()=>[_(h(ie),{onRegister:h(J),ref_key:"formRef",ref:ee},{analyseButton:B(()=>[b("div",Ie,[_(a,{title:"\u4F7F\u7528\u6307\u5357",trigger:"hover",style:{margin:"0 10px 0 6px"}},{content:B(()=>[D(" \u60A8\u53EF\u4EE5\u952E\u5165\u201C\u201D\u4F5C\u4E3A\u4E00\u4E2A\u53C2\u6570\uFF0C\u8FD9\u91CCabc\u662F\u53C2\u6570\u7684\u540D\u79F0\u3002\u4F8B\u5982\uFF1A"),Ve,D(" select * from table where id = ${abc}\u3002"),Le,D(" select * from table where id like concat('%',${abc},'%')\u3002(mysql\u6A21\u7CCA\u67E5\u8BE2)"),Oe,D(" select * from table where id like '%'||${abc}||'%'\u3002(oracle\u6A21\u7CCA\u67E5\u8BE2)"),Te,D(" select * from table where id like '%'+${abc}+'%'\u3002(sqlserver\u6A21\u7CCA\u67E5\u8BE2)"),$e,qe]),default:B(()=>[_(l,{type:"question-circle"})]),_:1}),_(s,{style:{"margin-left":"10px"},type:"primary",onClick:le},{default:B(()=>[D("SQL\u89E3\u6790")]),_:1})])]),_:1},8,["onRegister"]),_(n,{style:{margin:"1px 0"},class:"cust-divider"}),_(I,{activeKey:F.value,"onUpdate:activeKey":r[0]||(r[0]=w=>F.value=w),onChange:h(X)},{default:B(()=>[(O(),T(g,{tab:"\u52A8\u6001\u62A5\u8868\u914D\u7F6E\u660E\u7EC6",key:f.value[0],forceRender:!0},{default:B(()=>[_(p,{"keep-source":"",dragSort:"",resizable:"",ref_key:"onlCgreportItem",ref:d,loading:A.loading,columns:A.columns,dataSource:A.dataSource,height:390,rowNumber:!0,rowSelection:!0,toolbar:!0},null,8,["loading","columns","dataSource"])]),_:1})),(O(),T(g,{tab:"\u62A5\u8868\u53C2\u6570",key:f.value[1],forceRender:!0},{default:B(()=>[_(p,{"keep-source":"",resizable:"",dragSort:"",ref_key:"onlCgreportParam",ref:c,loading:v.loading,columns:v.columns,dataSource:v.dataSource,height:390,rowNumber:!0,rowSelection:!0,toolbar:!0},null,8,["loading","columns","dataSource"])]),_:1}))]),_:1},8,["activeKey","onChange"])]),_:1},16,["onRegister","title","confirmLoading","onOk"])}}});var Dt=Object.freeze(Object.defineProperty({__proto__:null,default:Ne},Symbol.toStringTag,{value:"Module"}));export{Dt as C,Ne as _,Et as b,At as c,bt as d,vt as g,Ct as l,xt as s};

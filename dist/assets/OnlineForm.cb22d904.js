import{eY as rt,es as ut,F as p,a7 as st,o as ft,bH as ct,t as v,v as T,x as D,y as F,W as ce,V as de,z as V,aw as dt,bb as mt,Y as pt,X as ht,ab as z,eZ as gt,a1 as Q,r as bt,f6 as yt,u as vt,L as me,Q as pe}from"./index.b3d2a891.js";import{B as Ft}from"./BasicForm.2d2aa4ab.js";import"./helper.1b3fdfba.js";import{u as _t}from"./useForm.96d1836c.js";import"./JAddInput.43004d14.js";import{V as x,S as St,b as Ct,O as he}from"./FormSchemaFactory.9ae4ff2e.js";import{O as Pt,P as Ot,D as wt,a as At,u as Tt,b as Bt,c as kt,l as ge,g as Et}from"./useAutoForm.22ab24e4.js";import"./index.2d23bddf.js";import{p as Dt}from"./pick.dbff1c58.js";import{o as be}from"./omit.d6518a29.js";import"./JUpload.7bcd35c5.js";import"./JUploadModal.bcdb9954.js";import"./OnlineSelectCascade.c7e8662f.js";import{F as Vt}from"./BasicTable.5ee1302a.js";import"./TableImg.7ccb5f8d.js";import"./Area.5314b018.js";import"./functional.4d8eb9e7.js";import"./LinkTableListPiece.7d4741d4.js";import"./_flatRest.ff1861ce.js";import"./isArray.40a4ed15.js";import"./toString.cf909882.js";import"./_arrayPush.8821345e.js";import"./_baseClone.a8082016.js";import"./uniqBy.4cec2220.js";import"./BasicModal.7efd78fc.js";import"./useWindowSizeFn.ab02708a.js";import"./useFormItem.c06072f5.js";import"./download.2189cbe2.js";import"./base64Conver.030fa32c.js";import"./index.ea39cbd7.js";import"./index.792f7f1c.js";import"./useCountdown.a4eb9495.js";import"./index.96560ef2.js";import"./api.1d3c1927.js";import"./props.eccfb3be.js";import"./index.7afb8201.js";import"./bem.8fd44f61.js";import"./props.9df65a00.js";import"./useContextMenu.2f0b587d.js";import"./index.bc22d773.js";import"./onMountedOrActivated.12413c39.js";import"./index.bcdb3c55.js";import"./htmlmixed.6d768be1.js";import"./vue.1e0c6574.js";/* empty css             */import"./depart.api.7ce3d710.js";import"./user.api.365c9555.js";import"./_commonjsHelpers.7ef9cff5.js";import"./customExpression.58041e91.js";import"./useListPage.c9ea079e.js";import"./useTable.99eebf43.js";import"./index.2ff6eac0.js";import"./useContentHeight.0b543e32.js";import"./useContentViewHeight.b97dff8b.js";import"./usePageContext.2dbf8e50.js";import"./RedoOutlined.b10d0ad6.js";import"./JModalTip.a4f047a6.js";import"./_baseSlice.23bb44df.js";var xt=Object.defineProperty,ye=Object.getOwnPropertySymbols,Rt=Object.prototype.hasOwnProperty,Mt=Object.prototype.propertyIsEnumerable,ve=(u,s,i)=>s in u?xt(u,s,{enumerable:!0,configurable:!0,writable:!0,value:i}):u[s]=i,Y=(u,s)=>{for(var i in s||(s={}))Rt.call(s,i)&&ve(u,i,s[i]);if(ye)for(var i of ye(s))Mt.call(s,i)&&ve(u,i,s[i]);return u},C=(u,s,i)=>new Promise((a,B)=>{var S=h=>{try{_(i.next(h))}catch(m){B(m)}},P=h=>{try{_(i.throw(h))}catch(m){B(m)}},_=h=>h.done?a(h.value):Promise.resolve(h.value).then(S,P);_((i=i.apply(u,s)).next())});const G={optPre:"/online/cgform/api/form/",urlButtonAction:"/online/cgform/api/doButton"},jt={name:"OnlineForm",components:{BasicForm:Ft,Loading:ut,OnlineSubForm:Pt,PrinterOutlined:Ot,DiffOutlined:wt,FormOutlined:Vt,OnlinePopModal:At},props:{id:{type:String,default:""},formTemplate:{type:Number,default:1},disabled:{type:Boolean,default:!1},isTree:{type:Boolean,default:!1},pidField:{type:String,default:""},submitTip:{type:Boolean,default:!0}},emits:["success","rendered"],setup(u,{emit:s}){console.log("onlineForm-setup\u300B\u300B");const{createMessage:i}=vt(),a=p(null),B=p(!0),S=p(!1),P=p(1),_=p(""),h=p(!1),m=p(!1),O=st({reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0}),{onlineFormContext:d,resetContext:N}=Tt(),{formSchemas:k,defaultValueFields:R,changeDataIfArray2String:M,tableName:w,dbData:r,checkOnlyFieldValue:J,hasSubTable:b,subTabInfo:L,refMap:y,subDataSource:j,baseColProps:Fe,createFormSchemas:_e,linkDownList:Ut,fieldDisplayStatus:E}=Bt(u,a);let{EnhanceJS:f,initCgEnhanceJs:Se}=kt(d,!1);console.log("--------v3_hello-----------"),console.log("--formSchemas----------",k),w.value="v3_hello";const[Ce,{setProps:Pe,validate:X,resetFields:Z,setFieldsValue:A,updateSchema:U,getFieldsValue:$,scrollToField:Oe}]=_t({schemas:k,showActionButtonGroup:!1,baseColProps:Fe}),ee=p(!1);function we(){let e=u.disabled;ee.value=e,Pe({disabled:e})}function Ae(e,t,l){return C(this,null,function*(){console.log("\u65B0\u589E\u7F16\u8F91\u8FDB\u5165\u8868\u5355\u300B\u300Bform",t),yield Te(),_.value="",yield Z(),r.value="";let o=me(e);m.value=o,o?yield le(t):oe(),pe(()=>{!o&&l&&A(l),Be(),q("js","loaded"),we()})})}function Te(){return C(this,null,function*(){if(u.isTree===!0){let e=u.pidField,t=k.value;t&&t.length>0?t.filter(o=>o.field===e).length>0&&(yield U({field:e,componentProps:{reload:new Date().getTime()}})):console.log("\u6CA1\u6709\u62FF\u5230\u8868\u5355\u914D\u7F6E\u4FE1\u606F\uFF0C\u53EF\u80FD\u662F\u7B2C\u4E00\u6B21\u6253\u5F00\u65B0\u589E\u9875\u9762")}})}function Be(){if(me(m)===!1){let e=z(R[w.value]);ge(e,t=>{A(t)})}}function te(e,t){let l=z(R[e.key]);ge(l,o=>{const{row:n,target:g}=t;let c=[{rowKey:n.id,values:Y({},o)}];g.setValues(c)})}function le(e){return C(this,null,function*(){let t=yield Ee(e.id);r.value=Object.assign({},e,t);let l=ke.value,o=Dt(t,...l);u.disabled&&Object.keys(o).map(n=>{!o[n]&&o[n]!==0&&o[n]!=="0"&&delete o[n]}),yield A(o),oe(t)})}function oe(e){e||(e={});let t=Object.keys(j.value);if(t&&t.length>0){let l={};for(let o of t)l[o]=e[o]||[];j.value=l}}let ke=ft(()=>{let e=k.value,t=[];for(let l of e)t.push(l.field);return t});function Ee(e){let t=`${G.optPre}${u.id}/${e}`;return new Promise((l,o)=>{Q.get({url:t},{isTransformResponse:!1}).then(n=>{n.success?l(n.result):(o(),i.warning(n.message))}).catch(()=>{o()})})}function De(e){return C(this,null,function*(){P.value=e.head.tableType,w.value=e.head.tableName,B.value=e.head.tableType==1,Ve(e.head.extConfigJson),_e(e.schema.properties,e.schema.required,J),f=Se(e.enhanceJs),s("rendered",O);let t=yield Et(a);t.$formValueChange=(l,o,n)=>{Ye(l,o),n&&A(n)}})}function Ve(e){let t={reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:1,modalMinWidth:"",commentStatus:0};e&&(t=JSON.parse(e)),Object.keys(t).map(l=>{O[l]=t[l]})}function xe(){B.value===!0?Ne():Re()}function Re(){Me().then(e=>{ne(e)})}function Me(){let e={};return new Promise((t,l)=>{X().then(o=>t(o),({errorFields:o})=>{o&&o.length>0&&Oe(o[0][0]),l(x)})}).then(t=>(Object.assign(e,M(t)),Ie())).then(t=>(Object.assign(e,t),Promise.resolve(e))).catch(t=>(t===x||(t==null?void 0:t.code)===x?(i.warning("\u6821\u9A8C\u672A\u901A\u8FC7"),t.key&&je(t.key)):console.error(t),Promise.reject(null)))}function je(e){let t=L.value;for(let l=0;l<t.length;l++)if(e==t[l].key){let o=l+"";if(I.value===o)break;if(I.value=o,t[l].relationType===0){let n=y[e].value;n=Array.isArray(n)?n[0]:n,gt(300,()=>n==null?void 0:n.validateTable())}break}}function Ie(){return new Promise((e,t)=>C(this,null,function*(){let l={};try{let o=L.value;for(let n=0;n<o.length;n++){let g=o[n].key,c=y[g].value;if(c instanceof Array&&(c=c[0]),o[n].relationType==1)try{let H=yield c.getAll();l[g]=[],l[g].push(H)}catch(H){throw{code:x,key:g}}else{if(yield c.fullValidateTable())throw{code:x,key:g};l[g]=c.getTableData()}}}catch(o){t(o)}e(l)}))}function Ne(){return C(this,null,function*(){try{let e=yield X();e=Object.assign({},r.value,e),e=M(e),S.value=!0,ne(e)}finally{S.value=!1}})}function ne(e){Ze(fe,e).then(()=>{Je(e)}).catch(t=>{i.warning(t)})}function Je(e){Object.keys(e).map(n=>{Array.isArray(e[n])&&e[n].length==0&&(e[n]="")}),console.log("\u63D0\u4EA4\u8868\u5355\u6570\u636E\u300B\u300B\u300Bform:",e);let t=_.value,l=`${G.optPre}${u.id}?tabletype=${P.value}`;t&&(l=`${t}?tabletype=${P.value}`),h.value===!0&&(e[St]=1);let o=m.value===!0?"put":"post";Q.request({url:l,method:o,params:e},{isTransformResponse:!1}).then(n=>{n.success?(n.result&&(e[Ct]=n.result),s("success",e),u.submitTip===!0&&i.success(n.message)):i.warning(n.message)}).finally(()=>{S.value=!1})}function Le(e,t,l){t&&l?l.vxeProps?l.setValues([{rowKey:t,values:e}]):l.setValues(e):A(e)}function Ue(e,t){let l={};l[e]=t,A(l)}const I=p("0"),ae=p(300),ie=p(340);function qe(e){if(m.value===!0){let t=r.value;return Ke(t,e)}return""}function Ke(e,t){if(e){let l=e[t];return!l&&l!==0&&(l=e[t.toLowerCase()],!l&&l!==0&&(l=e[t.toUpperCase()])),l}return""}function We(e,t){if(f&&f[t+"_onlChange"]){let l=f[t+"_onlChange"](),o=Object.keys(e)[0];if(l[o]){let n=y[t].value;n instanceof Array&&(n=n[0]);let g=n.getFormEvent(),c=Y({column:{key:o},value:e[o]},g);l[o].call(d,d,c)}}}function He(e,t){if(f&&f[t+"_onlChange"]){let l=f[t+"_onlChange"](d);if(e.column==="all"){let o=Object.keys(l);if(o.length>0)for(let n of o)l[n].call(d,d,e)}else{let o=e.column.key||e.col.key;l[o]&&e.row&&e.row.id&&l[o].call(d,d,e)}}}function ze(e,t){console.log("handleAdded",e,t),te(e,t)}function Qe(e){return"online_"+e+":"}function Ye(e,t){return C(this,null,function*(){if(!f||!f.onlChange||!e)return!1;let l=f.onlChange();if(l[e]){let n={row:yield $(),column:{key:e},value:t};l[e].call(d,d,n)}})}function q(e,t){if(e=="js")f&&f[t]&&f[t].call(d,d);else if(e=="action"){let l=r.value,o={formId:u.id,buttonCode:t,dataId:l.id,uiFormData:Object.assign({},l)};Q.post({url:`${G.urlButtonAction}`,params:o},{isTransformResponse:!1}).then(n=>{n.success?i.success("\u5904\u7406\u5B8C\u6210!"):i.warning("\u5904\u7406\u5931\u8D25!")})}}function re(e){let t=y[e].value,l=[...t.getNewDataWithId(),...j.value[e]];if(!l||l.length==0)return!1;let o=[];for(let n of l)o.push(n.id);t.removeRowsById(o)}function ue(e,t){if(!t)return!1;let l=y[e].value;typeof t=="object"?l.addRows(t,!0):this.$message.error("\u6DFB\u52A0\u5B50\u8868\u6570\u636E,\u53C2\u6570\u4E0D\u8BC6\u522B!")}function Ge(e,t){re(e),ue(e,t)}function Xe(e,t){!t&&t.length<=0&&(t=[]),t.map(l=>{l.hasOwnProperty("label")||(l.label=l.text)}),U({field:e,componentProps:{options:t}})}function Ze(e,t){return f&&f.beforeSubmit?f.beforeSubmit(e,t):Promise.resolve()}function $e(e,t){let l=z(E);e&&e.length>0?Object.keys(l).map(o=>{!o.endsWith("_load")&&e.indexOf(o)<0&&(E[o]=!1)}):t&&t.length>0&&Object.keys(l).map(o=>{t.indexOf(o)>=0&&(E[o]=!1)})}function et(e,t){return C(this,null,function*(){console.log("\u81EA\u5B9A\u4E49\u5F39\u7A97\u6253\u5F00online\u8868\u5355\u300B\u300Bform",e),_.value=t,yield Z(),r.value="",m.value=!0,yield le(e),yield pe(()=>{q("js","loaded")})})}function tt(e){let t=y[e].value;return t instanceof Array&&(t=t[0]),t}function lt(){let e=O.reportPrintUrl,t=r.value.id,l=bt();yt(e,t,l)}const[ot,{openModal:se}]=ct(),K=p(""),W=p(!0);function nt(e){console.log("openSubFormModalForAdd",e),K.value=e.id,W.value=!1,se(!0,{})}function at(e){let t=y[e.key];if(!t||!t.value){i.warning("\u5B50\u8868ref\u627E\u4E0D\u5230:"+e.key);return}t=t.value,Array.isArray(t)&&(t=t[0]);let l=t.getSelectedData();if(l.length!=1){i.warning("\u8BF7\u9009\u62E9\u4E00\u6761\u6570\u636E");return}K.value=e.id,W.value=!1,se(!0,{isUpdate:!0,record:l[0]})}function it(e){const t=e[he];let l=be(e,[he]);if(l.id){const o=y[t];if(!o||!o.value){i.warning("\u5B50\u8868ref\u627E\u4E0D\u5230:"+t);return}let n=be(Y({},l),"id"),g=[{rowKey:l.id,values:n}],c=o.value;c instanceof Array&&(c=c[0]),c.setValues(g)}else{let o=y[t].value;o instanceof Array&&(o=o[0]),o.addRows(l,{isOnlineJS:!1,setActive:!1,emitChange:!0})}}let fe={tableName:w,loading:S,subActiveKey:I,onlineFormRef:a,getFieldsValue:$,setFieldsValue:A,submitFlowFlag:h,subFormHeight:ae,subTableHeight:ie,refMap:y,triggleChangeValues:Le,triggleChangeValue:Ue,sh:E,clearSubRows:re,addSubRows:ue,clearThenAddRows:Ge,changeOptions:Xe,isUpdate:m,getSubTableInstance:tt,updateSchema:U};return N(fe),{tableName:w,onlineFormRef:a,registerForm:Ce,loading:S,subActiveKey:I,hasSubTable:b,subTabInfo:L,refMap:y,subFormHeight:ae,getSubTableForeignKeyValue:qe,isUpdate:m,handleSubFormChange:We,subTableHeight:ie,onlineFormDisabled:ee,subDataSource:j,getSubTableAuthPre:Qe,handleAdded:ze,handleSubTableDefaultValue:te,handleValueChange:He,openSubFormModalForAdd:nt,openSubFormModalForEdit:at,show:Ae,createRootProperties:De,handleSubmit:xe,sh:E,handleCgButtonClick:q,handleCustomFormSh:$e,handleCustomFormEdit:et,dbData:r,onOpenReportPrint:lt,onlineExtConfigJson:O,registerPopModal:ot,popTableName:K,getPopFormData:it,popModalRequest:W}}},It=["id"],Nt={key:0,style:{"text-align":"right",position:"absolute",top:"6px",right:"20px","z-index":"999"}},Jt={key:1};function Lt(u,s,i,a,B,S){const P=v("PrinterOutlined"),_=v("BasicForm"),h=v("online-sub-form"),m=v("diff-outlined"),O=v("a-button"),d=v("form-outlined"),N=v("JVxeTable"),k=v("a-tab-pane"),R=v("a-tabs"),M=v("Loading"),w=v("online-pop-modal");return T(),D("div",{id:a.tableName+"_form"},[!!a.dbData.id&&!!a.onlineExtConfigJson.reportPrintShow?(T(),D("div",Nt,[F(P,{title:"\u6253\u5370",onClick:a.onOpenReportPrint,style:{"font-size":"16px"}},null,8,["onClick"])])):ce("",!0),F(_,{ref:"onlineFormRef",onRegister:a.registerForm},null,8,["onRegister"]),a.hasSubTable?(T(),de(R,{key:1,activeKey:a.subActiveKey,"onUpdate:activeKey":s[0]||(s[0]=r=>a.subActiveKey=r)},{default:V(()=>[(T(!0),D(dt,null,mt(a.subTabInfo,(r,J)=>(T(),de(k,{tab:r.describe,key:J+"",forceRender:!0},{default:V(()=>[r.relationType==1?(T(),D("div",{key:0,style:pt({"overflow-y":"auto","overflow-x":"hidden","max-height":a.subFormHeight+"px"})},[F(h,{ref_for:!0,ref:a.refMap[r.key],table:r.key,disabled:a.onlineFormDisabled,"form-template":i.formTemplate,"main-id":a.getSubTableForeignKeyValue(r.foreignKey),properties:r.properties,"required-fields":r.requiredFields,"is-update":a.isUpdate,onFormChange:b=>a.handleSubFormChange(b,r.key)},null,8,["table","disabled","form-template","main-id","properties","required-fields","is-update","onFormChange"])],4)):(T(),D("div",Jt,[F(N,{ref_for:!0,ref:a.refMap[r.key],toolbar:"","keep-source":"","row-number":"","row-selection":"",height:a.subTableHeight,disabled:a.onlineFormDisabled,columns:r.columns,dataSource:a.subDataSource[r.key],onValueChange:b=>a.handleValueChange(b,r.key),authPre:a.getSubTableAuthPre(r.key),onAdded:b=>a.handleAdded(r,b),onExecuteFillRule:b=>a.handleSubTableDefaultValue(r,b)},{toolbarSuffix:V(()=>[F(O,{type:"primary",onClick:b=>a.openSubFormModalForAdd(r)},{default:V(()=>[F(m)]),_:2},1032,["onClick"]),F(O,{type:"primary",onClick:b=>a.openSubFormModalForEdit(r)},{default:V(()=>[F(d)]),_:2},1032,["onClick"])]),_:2},1032,["height","disabled","columns","dataSource","onValueChange","authPre","onAdded","onExecuteFillRule"])]))]),_:2},1032,["tab"]))),128))]),_:1},8,["activeKey"])):ce("",!0),F(M,{loading:a.loading,absolute:!1},null,8,["loading"]),ht(u.$slots,"bottom"),F(w,{request:a.popModalRequest,id:a.popTableName,onRegister:a.registerPopModal,onSuccess:a.getPopFormData,topTip:""},null,8,["request","id","onRegister","onSuccess"])],8,It)}var zl=rt(jt,[["render",Lt]]);export{zl as default};

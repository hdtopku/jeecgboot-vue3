import{B as e}from"./index.ee0a0c33.js";import{B as t}from"./BasicForm.79466d99.js";import"./helper.ec3e26f3.js";import{u as l}from"./useForm.ee23be26.js";import"./JAddInput.c8a1b05b.js";import{a1 as a,dz as r,l as o,F as i,a8 as n,bH as d,o as s,L as u,t as c,v as p,V as m,z as f,y as g,aW as h,C as b,B as y,u as x}from"./index.b3c93d64.js";import{useJvxeMethod as v}from"./useJvxeMethods.73e0aba1.js";import{d as j}from"./user.api.f4883dd0.js";import"./BasicModal.2a8ad889.js";import"./useWindowSizeFn.e6386ae5.js";import"./uniqBy.30d2558a.js";import"./useFormItem.d029403d.js";import"./functional.3bb51b91.js";import"./download.261c8978.js";import"./base64Conver.030fa32c.js";import"./index.d2e70b0d.js";import"./index.17ec2e33.js";import"./useCountdown.cb4ad478.js";import"./JUpload.6bcc6fce.js";import"./api.dced5d87.js";import"./index.ef2039b9.js";import"./props.a4f5d1ca.js";import"./index.c4683457.js";import"./bem.3d3e77ca.js";import"./props.c13d8268.js";import"./useContextMenu.de287960.js";import"./index.9bbe419b.js";import"./onMountedOrActivated.d3784e6c.js";import"./index.36d6c198.js";import"./htmlmixed.ba3cd961.js";import"./vue.8c416d71.js";/* empty css             */import"./depart.api.429e062c.js";import"./vxeUtils.d5914e34.js";var k=Object.defineProperty,w=Object.defineProperties,S=Object.getOwnPropertyDescriptors,C=Object.getOwnPropertySymbols,I=Object.prototype.hasOwnProperty,P=Object.prototype.propertyIsEnumerable,_=(e,t,l)=>t in e?k(e,t,{enumerable:!0,configurable:!0,writable:!0,value:l}):e[t]=l,V=(e,t)=>{for(var l in t||(t={}))I.call(t,l)&&_(e,l,t[l]);if(C)for(var l of C(t))P.call(t,l)&&_(e,l,t[l]);return e},$=(e,t,l)=>new Promise(((a,r)=>{var o=e=>{try{n(l.next(e))}catch(t){r(t)}},i=e=>{try{n(l.throw(e))}catch(t){r(t)}},n=e=>e.done?a(e.value):Promise.resolve(e.value).then(o,i);n((l=l.apply(e,t)).next())}));const{createConfirm:O}=x(),q=e=>a.get({url:"/online/cgreport/head/list",params:e}),N=(e,t)=>a.delete({url:"/online/cgreport/head/delete",params:e},{joinParamsToUrl:!0}).then((()=>{t()})),L=(e,t)=>{O({title:"确认删除",content:"是否删除选中数据",okText:"确认",cancelText:"取消",iconType:"warning",onOk:()=>a.delete({url:"/online/cgreport/head/deleteBatch",data:e},{joinParamsToUrl:!0}).then((()=>{t()}))})},B=e=>a.get({url:"/online/cgreport/api/getParamsInfo/"+e}),R=[{title:"报表名字",align:"center",dataIndex:"name",width:120},{title:"报表编码",align:"center",dataIndex:"code",width:120},{title:"报表SQL",align:"center",dataIndex:"cgrSql",width:360},{title:"数据源",align:"center",dataIndex:"dbSource",width:120},{title:"创建时间",align:"center",dataIndex:"createTime",width:120}],T=[{label:"报表名称",field:"name",component:"JInput"},{label:"报表编码",field:"code",component:"JInput"}],W=/^[a-z|A-Z][a-z|A-Z|\d|_|-]{0,}$/,F=[{label:"",field:"id",component:"Input",show:!1},{label:"报表编码",field:"code",component:"Input",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},dynamicRules:({values:e,model:t})=>[{required:!0,validator:(e,l)=>new Promise(((e,a)=>{if(!l)return a("请输入报表编码！");if(!W.test(l))return a("编码必须以字母开头，可包含数字、下划线、横杠！");let r={tableName:"onl_cgreport_head",fieldName:"code",fieldVal:l,dataId:t.id};j(r).then((t=>{t.success?e():a("报表编码已存在!")})).catch((e=>{a(e.message||"校验失败")}))}))}]},{label:"报表名字",field:"name",component:"Input",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},dynamicRules:()=>[{required:!0,message:"请输入报表名字!"}]},{label:"动态数据源",field:"dbSource",colProps:{sm:24,xs:24,md:12,lg:8,xl:8,xxl:8},component:"ApiSelect",componentProps:{api:()=>a.get({url:"/sys/dataSource/options"})}},{label:"报表SQL",field:"cgrSql",component:"JCodeEditor",rules:[{required:!0,message:"请填写报表SQL"}],itemProps:{labelCol:{xs:24,sm:2},wrapperCol:{xs:24,sm:22}},componentProps:{height:"200px",fullScreen:!0},colProps:{span:20}},{label:" ",field:"analyseButton",component:"Input",slot:"analyseButton",colProps:{span:4},itemProps:{labelCol:{xs:1,sm:1},wrapperCol:{xs:23,sm:23},colon:!1}}],M=[{title:"参数字段",key:"paramName",type:r.input,width:"200px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"参数文本",key:"paramTxt",type:r.input,width:"200px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"参数默认值",key:"paramValue",type:r.input,width:"200px",placeholder:"请输入${title}",defaultValue:""}],z=[{title:"字段名字",key:"fieldName",type:r.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"字段文本",key:"fieldTxt",type:r.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}]},{title:"字段类型",key:"fieldType",minWidth:"150px",placeholder:"请输入${title}",defaultValue:"",validateRules:[{required:!0,message:"${title}不能为空"}],type:r.select,options:[{title:"数值类型",value:"Integer"},{title:"字符类型",value:"String"},{title:"日期类型",value:"Date"},{title:"时间类型",value:"Datetime"},{title:"长整型",value:"Long"}]},{title:"是否显示",key:"isShow",minWidth:"80px",align:"center",type:r.checkbox,customValue:[1,0],defaultChecked:!0},{title:"字段href",key:"fieldHref",type:r.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"查询模式",key:"searchMode",type:r.select,minWidth:"150px",placeholder:"请选择${title}",options:[{title:"单条件查询",value:"single"},{title:"范围查询",value:"group"}]},{title:"取值表达式",key:"replaceVal",type:r.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"字典code",key:"dictCode",type:r.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"分组标题",key:"groupTitle",type:r.input,minWidth:"150px",placeholder:"请输入${title}",defaultValue:""},{title:"是否查询",key:"isSearch",type:r.checkbox,customValue:["1","0"],minWidth:"80px",align:"center",defaultChecked:!1},{title:"是否合计",align:"center",key:"isTotal",type:r.checkbox,customValue:["1","0"],minWidth:"80px",defaultChecked:!1}],A={style:{flex:"1","text-align":"left"}},D=h("br",null,null,-1),J=h("br",null,null,-1),U=h("br",null,null,-1),H=h("br",null,null,-1),K=h("br",null,null,-1),Q=h("span",{style:{color:"red"}},"注：参数只支持动态报表，popup暂不支持",-1),E=o({__name:"CgreportModal",emits:["register","success"],setup(r,{emit:o}){const{createMessage:j}=x(),k=i(!0),C=i(!0),I=i(["onlCgreportItem","onlCgreportParam"]),P=i("onlCgreportItem"),_=i(),O=i(),q={onlCgreportItem:O,onlCgreportParam:_},N=n({loading:!1,dataSource:[],columns:M}),L=n({loading:!1,dataSource:[],columns:z}),[B,{setProps:R,resetFields:T,setFieldsValue:W,validate:E,validateFields:Z}]=l({schemas:F,showActionButtonGroup:!1}),[G,{setModalProps:X,closeModal:Y}]=d((e=>$(this,null,(function*(){var t,l;yield function(){return $(this,null,(function*(){yield T(),P.value="onlCgreportItem",N.dataSource=[],L.dataSource=[]}))}(),X({confirmLoading:!1,showCancelBtn:null==e?void 0:e.showFooter,showOkBtn:null==e?void 0:e.showFooter}),k.value=!!(null==e?void 0:e.isUpdate),u(k)&&(yield W(V({},e.record)),le("/online/cgreport/param/listByHeadId",{headId:null==(t=null==e?void 0:e.record)?void 0:t.id},N),le("/online/cgreport/item/listByHeadId",{headId:null==(l=null==e?void 0:e.record)?void 0:l.id},L)),R({disabled:!(null==e?void 0:e.showFooter)})})))),[ee,te,le,ae]=v((function(e){return $(this,null,(function*(){try{X({confirmLoading:!0});let t=[],l=[],r={};Object.keys(e).map((a=>{"onlCgreportItemList"==a?l=e[a]:"onlCgreportParamList"==a?t=e[a]:r[a]=e[a]}));let i={head:r,params:t,items:l};yield((e,t)=>t?a.put({url:"/online/cgreport/head/editAll",params:e}):a.post({url:"/online/cgreport/head/add",params:e}))(i,k.value),Y(),o("success")}finally{X({confirmLoading:!1})}}))}),(function(e){let t=Object.assign({},e.formValue);return l=V({},t),a={onlCgreportParamList:e.tablesValue[1].tableData,onlCgreportItemList:e.tablesValue[0].tableData},w(l,S(a));var l,a}),q,P,I),re=s((()=>u(k)?"编辑":"新增"));function oe(){X({confirmLoading:!0}),Z(["cgrSql","dbSource"]).then((e=>{let{cgrSql:t,dbSource:l}=e,r="sql="+encodeURIComponent(t);var o;l&&(r+="&dbKey="+l),(o=r,a.get({url:"/online/cgreport/head/parseSql?"+o})).then((e=>{if(e){j.success("解析成功");let{fields:t,params:l}=e,a=t.filter((e=>"__row_number__"!=e.fieldName)),r=ie(O.value.getTableData(),a||[],"fieldName");r=r.sort(((e,t)=>e.orderNum-t.orderNum)),L.dataSource=r;let o=ie(_.value.getTableData(),l||[],"paramName");o=o.sort(((e,t)=>e.orderNum-t.orderNum)),N.dataSource=o}}))})).catch((()=>{})).finally((()=>{X({confirmLoading:!1})}))}function ie(e,t,l){if(e.length>0){let a=[],r=[],o=1;for(let i of t)for(let t of e)if(t[l]==i[l]){a.push(t),r.push(i[l]),t.orderNum>o&&(o=t.orderNum);break}for(let e of t)r.indexOf(e[l])<0&&(e.orderNum=++o,a.push(e));return a}{let e=0;for(let l of t)l.orderNum||(l.orderNum=++e);return t}}return(l,a)=>{const r=c("a-icon"),o=c("a-popover"),i=c("a-button"),n=c("a-divider"),d=c("JVxeTable"),s=c("a-tab-pane"),x=c("a-tabs");return p(),m(u(e),y(l.$attrs,{onRegister:u(G),title:u(re),width:1200,maskClosable:!1,defaultFullscreen:!0,confirmLoading:C.value,onOk:u(te)}),{default:f((()=>[g(u(t),{onRegister:u(B),ref_key:"formRef",ref:ae},{analyseButton:f((()=>[h("div",A,[g(o,{title:"使用指南",trigger:"hover",style:{margin:"0 10px 0 6px"}},{content:f((()=>[b(" 您可以键入“”作为一个参数，这里abc是参数的名称。例如："),D,b(" select * from table where id = ${abc}。"),J,b(" select * from table where id like concat('%',${abc},'%')。(mysql模糊查询)"),U,b(" select * from table where id like '%'||${abc}||'%'。(oracle模糊查询)"),H,b(" select * from table where id like '%'+${abc}+'%'。(sqlserver模糊查询)"),K,Q])),default:f((()=>[g(r,{type:"question-circle"})])),_:1}),g(i,{style:{"margin-left":"10px"},type:"primary",onClick:oe},{default:f((()=>[b("SQL解析")])),_:1})])])),_:1},8,["onRegister"]),g(n,{style:{margin:"1px 0"},class:"cust-divider"}),g(x,{activeKey:P.value,"onUpdate:activeKey":a[0]||(a[0]=e=>P.value=e),onChange:u(ee)},{default:f((()=>[(p(),m(s,{tab:"动态报表配置明细",key:I.value[0],forceRender:!0},{default:f((()=>[g(d,{"keep-source":"",dragSort:"",resizable:"",ref_key:"onlCgreportItem",ref:O,loading:L.loading,columns:L.columns,dataSource:L.dataSource,height:390,rowNumber:!0,rowSelection:!0,toolbar:!0},null,8,["loading","columns","dataSource"])])),_:1})),(p(),m(s,{tab:"报表参数",key:I.value[1],forceRender:!0},{default:f((()=>[g(d,{"keep-source":"",resizable:"",dragSort:"",ref_key:"onlCgreportParam",ref:_,loading:N.loading,columns:N.columns,dataSource:N.dataSource,height:390,rowNumber:!0,rowSelection:!0,toolbar:!0},null,8,["loading","columns","dataSource"])])),_:1}))])),_:1},8,["activeKey","onChange"])])),_:1},16,["onRegister","title","confirmLoading","onOk"])}}});var Z=Object.freeze(Object.defineProperty({__proto__:null,default:E},Symbol.toStringTag,{value:"Module"}));export{Z as C,E as _,L as b,R as c,N as d,B as g,q as l,T as s};

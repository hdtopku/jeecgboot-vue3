import{O as ONL_FORM_TABLE_NAME,F as FormSchemaFactory,a as ONL_AUTH_PRE,V as VALIDATE_FAILED,S as SUBMIT_FLOW_KEY}from"./FormSchemaFactory.c7393278.js";import{d as duplicateCheck}from"./user.api.ceae0e75.js";import{c as commonjsGlobal}from"./_commonjsHelpers.7ef9cff5.js";import{y as createVNode,av as AntdIcon,a8 as reactive,f0 as _export_sfc,F as ref,o as computed,L as unref,bH as useModalInner,l as defineComponent,cI as Button,H as watch,h,cl as PlusOutlined,er as EditOutlined,aN as propTypes,bI as useModal,al as useDebounceFn,dL as useRouter,ac as toRaw,eg as usePermissionStore,f6 as replaceAll,a1 as defHttp,Q as nextTick,aa as watchEffect,j as filterMultiDictText,f7 as markRaw,f8 as defineAsyncComponent,f9 as importViewsFile,a as getFileAccessHttpUrl,d7 as useUserStore,ew as Loading,t as resolveComponent,v as openBlock,V as createBlock,x as createElementBlock,z as withCtx,C as createTextVNode,D as toDisplayString,W as createCommentVNode,B as mergeProps,aW as createBaseVNode,ax as Fragment,bc as renderList,E as normalizeClass,r as getToken,fa as goJmReportViewPage,u as useMessage}from"./index.b2c24a42.js";import{C as CustomExpression}from"./customExpression.58041e91.js";import{T as TableAction,l as add}from"./helper.c50e6850.js";import OnlineSelectCascade from"./OnlineSelectCascade.3bb41065.js";import{B as BasicModal}from"./index.12c6f6d1.js";import{B as BasicForm}from"./BasicForm.fb9b9310.js";import{u as useForm}from"./useForm.5a9ed278.js";import"./JAddInput.2ba637e0.js";import{p as pick$1}from"./pick.dbff1c58.js";import{B as BasicTable,F as FormOutlined}from"./BasicTable.fa29c153.js";import"./TableImg.2942a3dc.js";import{useListPage}from"./useListPage.ddd6479e.js";import{g as getAreaTextByCode}from"./Area.f37a4b8c.js";import{c as createImgPreview}from"./functional.d6fe070d.js";import LinkTableListPiece from"./LinkTableListPiece.3767b554.js";import JModalTip from"./JModalTip.ebca1866.js";var DiffOutlined$2={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M476 399.1c0-3.9-3.1-7.1-7-7.1h-42c-3.8 0-7 3.2-7 7.1V484h-84.5c-4.1 0-7.5 3.1-7.5 7v42c0 3.8 3.4 7 7.5 7H420v84.9c0 3.9 3.2 7.1 7 7.1h42c3.9 0 7-3.2 7-7.1V540h84.5c4.1 0 7.5-3.2 7.5-7v-42c0-3.9-3.4-7-7.5-7H476v-84.9zM560.5 704h-225c-4.1 0-7.5 3.2-7.5 7v42c0 3.8 3.4 7 7.5 7h225c4.1 0 7.5-3.2 7.5-7v-42c0-3.8-3.4-7-7.5-7zm-7.1-502.6c-6-6-14.1-9.4-22.6-9.4H192c-17.7 0-32 14.3-32 32v704c0 17.7 14.3 32 32 32h512c17.7 0 32-14.3 32-32V397.3c0-8.5-3.4-16.6-9.4-22.6L553.4 201.4zM664 888H232V264h282.2L664 413.8V888zm190.2-581.4L611.3 72.9c-6-5.7-13.9-8.9-22.2-8.9H296c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h277l219 210.6V824c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V329.6c0-8.7-3.5-17-9.8-23z"}}]},name:"diff",theme:"outlined"},DiffOutlinedSvg=DiffOutlined$2;function _objectSpread$2(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?Object(arguments[t]):{},l=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(l=l.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),l.forEach((function(t){_defineProperty$2(e,t,n[t])}))}return e}function _defineProperty$2(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var DiffOutlined=function(e,t){var n=_objectSpread$2({},e,t.attrs);return createVNode(AntdIcon,_objectSpread$2({},n,{icon:DiffOutlinedSvg}),null)};DiffOutlined.displayName="DiffOutlined",DiffOutlined.inheritAttrs=!1;var DiffOutlined$1=DiffOutlined,MinusCircleFilled$2={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm192 472c0 4.4-3.6 8-8 8H328c-4.4 0-8-3.6-8-8v-48c0-4.4 3.6-8 8-8h368c4.4 0 8 3.6 8 8v48z"}}]},name:"minus-circle",theme:"filled"},MinusCircleFilledSvg=MinusCircleFilled$2;function _objectSpread$1(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?Object(arguments[t]):{},l=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(l=l.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),l.forEach((function(t){_defineProperty$1(e,t,n[t])}))}return e}function _defineProperty$1(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var MinusCircleFilled=function(e,t){var n=_objectSpread$1({},e,t.attrs);return createVNode(AntdIcon,_objectSpread$1({},n,{icon:MinusCircleFilledSvg}),null)};MinusCircleFilled.displayName="MinusCircleFilled",MinusCircleFilled.inheritAttrs=!1;var MinusCircleFilled$1=MinusCircleFilled,PrinterOutlined$2={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M820 436h-40c-4.4 0-8 3.6-8 8v40c0 4.4 3.6 8 8 8h40c4.4 0 8-3.6 8-8v-40c0-4.4-3.6-8-8-8zm32-104H732V120c0-4.4-3.6-8-8-8H300c-4.4 0-8 3.6-8 8v212H172c-44.2 0-80 35.8-80 80v328c0 17.7 14.3 32 32 32h168v132c0 4.4 3.6 8 8 8h424c4.4 0 8-3.6 8-8V772h168c17.7 0 32-14.3 32-32V412c0-44.2-35.8-80-80-80zM360 180h304v152H360V180zm304 664H360V568h304v276zm200-140H732V500H292v204H160V412c0-6.6 5.4-12 12-12h680c6.6 0 12 5.4 12 12v292z"}}]},name:"printer",theme:"outlined"},PrinterOutlinedSvg=PrinterOutlined$2;function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?Object(arguments[t]):{},l=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(l=l.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),l.forEach((function(t){_defineProperty(e,t,n[t])}))}return e}function _defineProperty(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var PrinterOutlined=function(e,t){var n=_objectSpread({},e,t.attrs);return createVNode(AntdIcon,_objectSpread({},n,{icon:PrinterOutlinedSvg}),null)};PrinterOutlined.displayName="PrinterOutlined",PrinterOutlined.inheritAttrs=!1;var PrinterOutlined$1=PrinterOutlined,__defProp=Object.defineProperty,__defProps=Object.defineProperties,__getOwnPropDescs=Object.getOwnPropertyDescriptors,__getOwnPropSymbols=Object.getOwnPropertySymbols,__hasOwnProp=Object.prototype.hasOwnProperty,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(e,t,n)=>t in e?__defProp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,__spreadValues=(e,t)=>{for(var n in t||(t={}))__hasOwnProp.call(t,n)&&__defNormalProp(e,n,t[n]);if(__getOwnPropSymbols)for(var n of __getOwnPropSymbols(t))__propIsEnum.call(t,n)&&__defNormalProp(e,n,t[n]);return e},__spreadProps=(e,t)=>__defProps(e,__getOwnPropDescs(t)),__async=(e,t,n)=>new Promise(((l,o)=>{var i=e=>{try{r(n.next(e))}catch(t){o(t)}},a=e=>{try{r(n.throw(e))}catch(t){o(t)}},r=e=>e.done?l(e.value):Promise.resolve(e.value).then(i,a);r((n=n.apply(e,t)).next())})),dayjs_min={exports:{}};dayjs_min.exports=function(){var e=1e3,t=6e4,n=36e5,l="millisecond",o="second",i="minute",a="hour",r="day",s="week",u="month",d="quarter",c="year",f="date",p="Invalid Date",m=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,h=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,g={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(e){var t=["th","st","nd","rd"],n=e%100;return"["+e+(t[(n-20)%10]||t[n]||t[0])+"]"}},b=function(e,t,n){var l=String(e);return!l||l.length>=t?e:""+Array(t+1-l.length).join(n)+e},y={s:b,z:function(e){var t=-e.utcOffset(),n=Math.abs(t),l=Math.floor(n/60),o=n%60;return(t<=0?"+":"-")+b(l,2,"0")+":"+b(o,2,"0")},m:function e(t,n){if(t.date()<n.date())return-e(n,t);var l=12*(n.year()-t.year())+(n.month()-t.month()),o=t.clone().add(l,u),i=n-o<0,a=t.clone().add(l+(i?-1:1),u);return+(-(l+(n-o)/(i?o-a:a-o))||0)},a:function(e){return e<0?Math.ceil(e)||0:Math.floor(e)},p:function(e){return{M:u,y:c,w:s,d:r,D:f,h:a,m:i,s:o,ms:l,Q:d}[e]||String(e||"").toLowerCase().replace(/s$/,"")},u:function(e){return void 0===e}},v="en",_={};_[v]=g;var C=function(e){return e instanceof x},S=function e(t,n,l){var o;if(!t)return v;if("string"==typeof t){var i=t.toLowerCase();_[i]&&(o=i),n&&(_[i]=n,o=i);var a=t.split("-");if(!o&&a.length>1)return e(a[0])}else{var r=t.name;_[r]=t,o=r}return!l&&o&&(v=o),o||!l&&v},T=function(e,t){if(C(e))return e.clone();var n="object"==typeof t?t:{};return n.date=e,n.args=arguments,new x(n)},F=y;F.l=S,F.i=C,F.w=function(e,t){return T(e,{locale:t.$L,utc:t.$u,x:t.$x,$offset:t.$offset})};var x=function(){function g(e){this.$L=S(e.locale,null,!0),this.parse(e)}var b=g.prototype;return b.parse=function(e){this.$d=function(e){var t=e.date,n=e.utc;if(null===t)return new Date(NaN);if(F.u(t))return new Date;if(t instanceof Date)return new Date(t);if("string"==typeof t&&!/Z$/i.test(t)){var l=t.match(m);if(l){var o=l[2]-1||0,i=(l[7]||"0").substring(0,3);return n?new Date(Date.UTC(l[1],o,l[3]||1,l[4]||0,l[5]||0,l[6]||0,i)):new Date(l[1],o,l[3]||1,l[4]||0,l[5]||0,l[6]||0,i)}}return new Date(t)}(e),this.$x=e.x||{},this.init()},b.init=function(){var e=this.$d;this.$y=e.getFullYear(),this.$M=e.getMonth(),this.$D=e.getDate(),this.$W=e.getDay(),this.$H=e.getHours(),this.$m=e.getMinutes(),this.$s=e.getSeconds(),this.$ms=e.getMilliseconds()},b.$utils=function(){return F},b.isValid=function(){return!(this.$d.toString()===p)},b.isSame=function(e,t){var n=T(e);return this.startOf(t)<=n&&n<=this.endOf(t)},b.isAfter=function(e,t){return T(e)<this.startOf(t)},b.isBefore=function(e,t){return this.endOf(t)<T(e)},b.$g=function(e,t,n){return F.u(e)?this[t]:this.set(n,e)},b.unix=function(){return Math.floor(this.valueOf()/1e3)},b.valueOf=function(){return this.$d.getTime()},b.startOf=function(e,t){var n=this,l=!!F.u(t)||t,d=F.p(e),p=function(e,t){var o=F.w(n.$u?Date.UTC(n.$y,t,e):new Date(n.$y,t,e),n);return l?o:o.endOf(r)},m=function(e,t){return F.w(n.toDate()[e].apply(n.toDate("s"),(l?[0,0,0,0]:[23,59,59,999]).slice(t)),n)},h=this.$W,g=this.$M,b=this.$D,y="set"+(this.$u?"UTC":"");switch(d){case c:return l?p(1,0):p(31,11);case u:return l?p(1,g):p(0,g+1);case s:var v=this.$locale().weekStart||0,_=(h<v?h+7:h)-v;return p(l?b-_:b+(6-_),g);case r:case f:return m(y+"Hours",0);case a:return m(y+"Minutes",1);case i:return m(y+"Seconds",2);case o:return m(y+"Milliseconds",3);default:return this.clone()}},b.endOf=function(e){return this.startOf(e,!1)},b.$set=function(e,t){var n,s=F.p(e),d="set"+(this.$u?"UTC":""),p=(n={},n[r]=d+"Date",n[f]=d+"Date",n[u]=d+"Month",n[c]=d+"FullYear",n[a]=d+"Hours",n[i]=d+"Minutes",n[o]=d+"Seconds",n[l]=d+"Milliseconds",n)[s],m=s===r?this.$D+(t-this.$W):t;if(s===u||s===c){var h=this.clone().set(f,1);h.$d[p](m),h.init(),this.$d=h.set(f,Math.min(this.$D,h.daysInMonth())).$d}else p&&this.$d[p](m);return this.init(),this},b.set=function(e,t){return this.clone().$set(e,t)},b.get=function(e){return this[F.p(e)]()},b.add=function(l,d){var f,p=this;l=Number(l);var m=F.p(d),h=function(e){var t=T(p);return F.w(t.date(t.date()+Math.round(e*l)),p)};if(m===u)return this.set(u,this.$M+l);if(m===c)return this.set(c,this.$y+l);if(m===r)return h(1);if(m===s)return h(7);var g=(f={},f[i]=t,f[a]=n,f[o]=e,f)[m]||1,b=this.$d.getTime()+l*g;return F.w(b,this)},b.subtract=function(e,t){return this.add(-1*e,t)},b.format=function(e){var t=this,n=this.$locale();if(!this.isValid())return n.invalidDate||p;var l=e||"YYYY-MM-DDTHH:mm:ssZ",o=F.z(this),i=this.$H,a=this.$m,r=this.$M,s=n.weekdays,u=n.months,d=function(e,n,o,i){return e&&(e[n]||e(t,l))||o[n].slice(0,i)},c=function(e){return F.s(i%12||12,e,"0")},f=n.meridiem||function(e,t,n){var l=e<12?"AM":"PM";return n?l.toLowerCase():l},m={YY:String(this.$y).slice(-2),YYYY:this.$y,M:r+1,MM:F.s(r+1,2,"0"),MMM:d(n.monthsShort,r,u,3),MMMM:d(u,r),D:this.$D,DD:F.s(this.$D,2,"0"),d:String(this.$W),dd:d(n.weekdaysMin,this.$W,s,2),ddd:d(n.weekdaysShort,this.$W,s,3),dddd:s[this.$W],H:String(i),HH:F.s(i,2,"0"),h:c(1),hh:c(2),a:f(i,a,!0),A:f(i,a,!1),m:String(a),mm:F.s(a,2,"0"),s:String(this.$s),ss:F.s(this.$s,2,"0"),SSS:F.s(this.$ms,3,"0"),Z:o};return l.replace(h,(function(e,t){return t||m[e]||o.replace(":","")}))},b.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},b.diff=function(l,f,p){var m,h=F.p(f),g=T(l),b=(g.utcOffset()-this.utcOffset())*t,y=this-g,v=F.m(this,g);return v=(m={},m[c]=v/12,m[u]=v,m[d]=v/3,m[s]=(y-b)/6048e5,m[r]=(y-b)/864e5,m[a]=y/n,m[i]=y/t,m[o]=y/e,m)[h]||y,p?v:F.a(v)},b.daysInMonth=function(){return this.endOf(u).$D},b.$locale=function(){return _[this.$L]},b.locale=function(e,t){if(!e)return this.$L;var n=this.clone(),l=S(e,t,!0);return l&&(n.$L=l),n},b.clone=function(){return F.w(this.$d,this)},b.toDate=function(){return new Date(this.valueOf())},b.toJSON=function(){return this.isValid()?this.toISOString():null},b.toISOString=function(){return this.$d.toISOString()},b.toString=function(){return this.$d.toUTCString()},g}(),O=x.prototype;return T.prototype=O,[["$ms",l],["$s",o],["$m",i],["$H",a],["$W",r],["$M",u],["$y",c],["$D",f]].forEach((function(e){O[e[1]]=function(t){return this.$g(t,e[0],e[1])}})),T.extend=function(e,t){return e.$i||(e(t,x,T),e.$i=!0),T},T.locale=S,T.isDayjs=C,T.unix=function(e){return T(1e3*e)},T.en=_[v],T.Ls=_,T.p={},T}();var dayjs=dayjs_min.exports;const ceKeys=Object.keys(CustomExpression),ceJoin=ceKeys.join(","),$CE$=ceKeys.map((e=>CustomExpression[e])),normalRegExp=/#{([^}]+)?}/g,customRegExp=/{{([^}]+)?}}/g,fillRuleRegExp=/\${([^}]+)?}/g,ACTION_TYPES={ADD:"add",EDIT:"edit",DETAIL:"detail",RELOAD:"reload"};function initDefValueConfig(e,t,n){hasEffectiveValue(t.defVal)&&n.push({field:e,type:t.type,value:t.defVal})}function initSubTableDefValueConfig(e,t){hasEffectiveValue(e.fieldDefaultValue)&&t.push({field:e.key,type:e.type,value:e.fieldDefaultValue})}function loadFormFieldsDefVal(e,t){return __async(this,null,(function*(){if(Array.isArray(e)&&e.length>0){let n={};for(let t of e){let{value:e,type:l,field:o}=t;e=yield handleDefaultValue(e,ACTION_TYPES.ADD,{}),"number"===l&&e&&(e=Number.parseFloat(e)),n[o]=e}t(n)}}))}function loadOneFieldDefVal(e,t,n){return __async(this,null,(function*(){let{defVal:l,type:o}=t;if(hasEffectiveValue(l)){let t=yield handleDefaultValue(l,ACTION_TYPES.ADD,{});"number"===o&&t&&(t=Number.parseFloat(t)),n[e]=t}}))}function hasEffectiveValue(e){return!(!e&&0!==e)}function handleDefaultValue(e,t,n){return __async(this,null,(function*(){if(null!=e&&checkExpressionType(e)){let l=yield getDefaultValue(e,t,n);if(null!=l)return l}return e}))}function checkExpressionType(e){let t=0,n=0,l=0;return e.replace(fillRuleRegExp,(()=>l++)),l>1?(logWarn(`表达式[${e}]不合法：只能同时填写一个填值规则表达式！`),!1):(e.replace(normalRegExp,(()=>t++)),e.replace(customRegExp,(()=>n++)),!(l>0&&t+n>0)||(logWarn(`表达式[${e}]不合法：填值规则表达式不能和其他表达式混用！`),!1))}function getRegExpMap(e,t){let n=new Map;return e.replace(t,(function(e,t){return n.set(e,t.trim()),e})),n}function getDefaultValue(e,t,n){return __async(this,null,(function*(){if((t===ACTION_TYPES.ADD||t===ACTION_TYPES.RELOAD)&&fillRuleRegExp.test(e)){let t=[n];return yield executeRegExp(e,fillRuleRegExp,executeFillRuleExpression,t)}return t===ACTION_TYPES.ADD?(e=yield executeRegExp(e,normalRegExp,executeNormalExpression),e=yield executeRegExp(e,customRegExp,executeCustomExpression)):null}))}function executeRegExp(e,t,n){return __async(this,arguments,(function*(e,t,n,l=[]){let o=getRegExpMap(e,t);for(let i of o.keys()){let t=o.get(i),a=yield n.apply(null,[t,i,...l]);if(i===e)return a;e=replaceAll(e,i,a)}return e}))}function executeNormalExpression(e,t){return __async(this,null,(function*(){switch(e){case"date":return dayjs().format("YYYY-MM-DD");case"time":return dayjs().format("HH:mm:ss");case"datetime":return dayjs().format("YYYY-MM-DD HH:mm:ss");default:let n=getUserInfoByExpression(e);return null!=n?n:t}}))}function getUserInfoByExpression(e){let t=useUserStore().getUserInfo;if(t)switch(e){case"sysUserId":return t.id;case"sysUserCode":case"sys_user_code":return t.username;case"sysUserName":return t.realname;case"sysOrgCode":case"sys_org_code":return t.orgCode}return null}function executeCustomExpression(expression,origin){return __async(this,null,(function*(){let fn=eval(`(function (${ceJoin}){ return ${expression} })`);try{return fn.apply(null,$CE$)}catch(e){return logError(e),origin}}))}function executeFillRuleExpression(e,t,n){return __async(this,null,(function*(){let l=`/sys/fillRule/executeRuleByCode/${e}`,o={};"function"==typeof n&&(o=n());let{success:i,message:a,result:r}=yield defHttp.put({url:l,params:o},{isTransformResponse:!1});return i?r:(logError(`填值规则（${e}）执行失败：${a}`),t)}))}function logWarn(e){}function logError(e){}function useEnhance(onlineTableContext,isList=!0){let EnhanceJS=reactive({});const getAction=(e,t)=>defHttp.get({url:e,params:t},{isTransformResponse:!1}),postAction=(e,t)=>defHttp.post({url:e,params:t},{isTransformResponse:!1}),putAction=(e,t)=>defHttp.put({url:e,params:t},{isTransformResponse:!1}),deleteAction=(e,t)=>defHttp.delete({url:e,params:t},{isTransformResponse:!1});function initCgEnhanceJs(str){if(str){let Obj=eval("("+str+")");return new Obj(getAction,postAction,deleteAction)}return{}}function triggerJsFun(e,t){EnhanceJS&&EnhanceJS[t]&&EnhanceJS[t](e)}function customBeforeSubmit(e,t){return EnhanceJS&&EnhanceJS.beforeSubmit?EnhanceJS.beforeSubmit(e,t):Promise.resolve()}function beforeDelete(e,t){return EnhanceJS&&EnhanceJS.beforeDelete?EnhanceJS.beforeDelete(e,t):Promise.resolve()}return!0===isList?(onlineTableContext._getAction=getAction,onlineTableContext._postAction=postAction,onlineTableContext._putAction=putAction,onlineTableContext._deleteAction=deleteAction):(onlineTableContext.addObject2Context("_getAction",getAction),onlineTableContext.addObject2Context("_postAction",postAction),onlineTableContext.addObject2Context("_putAction",putAction),onlineTableContext.addObject2Context("_deleteAction",deleteAction)),!0===isList&&onlineTableContext&&(onlineTableContext.beforeDelete=e=>{const t=onlineTableContext.EnhanceJS;return t&&t.beforeDelete?t.beforeDelete(onlineTableContext,e):Promise.resolve()},onlineTableContext.beforeEdit=e=>{const t=onlineTableContext.EnhanceJS;return t&&t.beforeEdit?t.beforeEdit(onlineTableContext,e):Promise.resolve()}),{EnhanceJS:EnhanceJS,initCgEnhanceJs:initCgEnhanceJs,customBeforeSubmit:customBeforeSubmit,beforeDelete:beforeDelete,triggerJsFun:triggerJsFun}}const baseUrl="/online/cgform/api/subform",_sfc_main$5={name:"OnlineSubForm",components:{BasicForm:BasicForm,Loading:Loading},props:{properties:{type:Object,required:!0},mainId:{type:String,default:""},table:{type:String,default:""},formTemplate:{type:Number,default:1},requiredFields:{type:Array,default:[]},isUpdate:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["formChange"],setup(e,{emit:t}){const n=ref(null),l=ref(!1),{formSchemas:o,defaultValueFields:i,changeDataIfArray2String:a,tableName:r,dbData:s,checkOnlyFieldValue:u,fieldDisplayStatus:d,createFormSchemas:c,baseColProps:f}=useFormItems(e,n),[p,{setProps:m,validate:h,resetFields:g,setFieldsValue:b,getFieldsValue:y}]=useForm({schemas:o,showActionButtonGroup:!1,baseColProps:f});watch((()=>e.table),(()=>{r.value=e.table}),{immediate:!0}),watch((()=>e.properties),(o=>{l.value=!1,function(){__async(this,null,(function*(){(yield getRefPromise(n)).$formValueChange=(e,n)=>{t("formChange",{[e]:n})}}))}(),c(e.properties,e.requiredFields,u),l.value=!0}),{deep:!0,immediate:!0}),watch((()=>e.mainId),(t=>{setTimeout((()=>{!function(){__async(this,null,(function*(){yield getRefPromise(l),yield g(),function(){if(!1===unref(e.isUpdate)){loadFormFieldsDefVal(toRaw(i[r.value]),(e=>{b(e)}))}}();const{table:t,mainId:n}=e;if(!t||!n)return;let o=yield function(e,t){let n=`${baseUrl}/${e}/${t}`;return new Promise(((e,t)=>{defHttp.get({url:n},{isTransformResponse:!1}).then((n=>{n.success?e(n.result):t()}))})).finally((()=>{s.value=""}))}(t,n);s.value=o,yield b(o)}))}()}),100)}),{immediate:!0}),watch((()=>e.disabled),(e=>{m({disabled:e})}));const v={onlineFormRef:n,baseColProps:f,formSchemas:o,registerForm:p,setFieldsValue:b,getFieldsValue:y,getFormEvent:function(){let e=y();return e.id||(e.id="sub-change-temp-id"),{row:e,target:v}},setValues:function(e){b(e)},getAll:function(){return new Promise(((e,t)=>{h().then((()=>{let t=y();t=a(t),e(t)})).catch((e=>{t(e)}))}))},sh:d};return v}};function _sfc_render$5(e,t,n,l,o,i){const a=resolveComponent("BasicForm");return openBlock(),createBlock(a,{ref:"onlineFormRef",onRegister:e.registerForm},null,8,["onRegister"])}var OnlineSubForm=_export_sfc(_sfc_main$5,[["render",_sfc_render$5]]),OnlineSubForm$1=Object.freeze(Object.defineProperty({__proto__:null,default:OnlineSubForm},Symbol.toStringTag,{value:"Module"}));const urlObject={optPre:"/online/cgform/api/form/",urlButtonAction:"/online/cgform/api/doButton"},_sfc_main$4={name:"OnlinePopForm",components:{BasicForm:BasicForm,Loading:Loading,OnlineSubForm:OnlineSubForm,PrinterOutlined:PrinterOutlined$1,DiffOutlined:DiffOutlined$1,FormOutlined:FormOutlined},props:{id:{type:String,default:""},formTemplate:{type:Number,default:1},disabled:{type:Boolean,default:!1},isTree:{type:Boolean,default:!1},pidField:{type:String,default:""},submitTip:{type:Boolean,default:!0},modalClass:{type:String,default:""},request:{type:Boolean,default:!0},isVxeTableData:{type:Boolean,default:!1}},emits:["success","rendered","dataChange"],setup(e,{emit:t}){const{createMessage:n}=useMessage(),[l,{openModal:o}]=useModal(),i=ref(""),a=ref(null),r=ref(!0),s=ref(!1),u=ref(1),d=ref(!1),c=ref(!1),f=reactive({reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:""}),{onlineFormContext:p,resetContext:m}=useOnlineFormContext(),{formSchemas:h,defaultValueFields:g,changeDataIfArray2String:b,tableName:y,dbData:v,checkOnlyFieldValue:_,hasSubTable:C,subTabInfo:S,refMap:T,subDataSource:F,baseColProps:x,createFormSchemas:O,fieldDisplayStatus:w}=useFormItems(e,a);let{EnhanceJS:k,initCgEnhanceJs:D}=useEnhance(p,!1);const[M,{setProps:P,validate:$,resetFields:V,setFieldsValue:B,updateSchema:A,getFieldsValue:R,scrollToField:I}]=useForm({schemas:h,showActionButtonGroup:!1,baseColProps:x}),N=ref(!1);function E(t){return __async(this,null,(function*(){let l=yield function(t){let l=`${urlObject.optPre}${e.id}/${t}`;return new Promise(((e,t)=>{defHttp.get({url:l},{isTransformResponse:!1}).then((l=>{l.success?e(l.result):(t(),n.warning(l.message))})).catch((()=>{t()}))}))}(t.id);l&&0!=Object.keys(l).length||(l=__spreadValues({},toRaw(t))),v.value=Object.assign({},l);let o=j.value,i=pick$1(l,...o);!0===e.isVxeTableData&&(i=Object.assign({},i,t)),yield B(i)}))}let j=computed((()=>{let e=h.value,t=[];for(let n of e)t.push(n.field);return t}));function L(l){(function(e,t){return k&&k.beforeSubmit?k.beforeSubmit(e,t):Promise.resolve()})(Y,l).then((()=>{!function(l){if(Object.keys(l).map((e=>{Array.isArray(l[e])&&0==l[e].length&&(l[e]="")})),0==e.request)t("success",l);else{let o=`${urlObject.optPre}${e.id}?tabletype=${u.value}`;!0===d.value&&(l[SUBMIT_FLOW_KEY]=1);let i=!0===c.value?"put":"post";defHttp.request({url:o,method:i,params:l},{isTransformResponse:!1}).then((e=>{e.success?(e.result&&(l.id||(l.id=e.result)),t("success",l),v.value=l,c.value=!0,n.success("操作成功!")):n.warning(e.message)})).finally((()=>{s.value=!1}))}}(l)})).catch((e=>{n.warning(e)}))}const H=ref("0"),J=ref(300),U=ref(340);function W(t,l){if("js"==t)k&&k[l]&&k[l].call(p,p);else if("action"==t){let t=v.value,o={formId:e.id,buttonCode:l,dataId:t.id,uiFormData:Object.assign({},t)};defHttp.post({url:`${urlObject.urlButtonAction}`,params:o},{isTransformResponse:!1}).then((e=>{e.success?n.success("处理完成!"):n.warning("处理失败!")}))}}function K(e){let t=T[e].value,n=[...t.getNewDataWithId(),...F.value[e]];if(!n||0==n.length)return!1;let l=[];for(let o of n)l.push(o.id);t.removeRowsById(l)}function z(e,t){if(!t)return!1;let l=T[e].value;"object"==typeof t?l.addRows(t,!0):n.error("添加子表数据,参数不识别!")}let Y={tableName:y,loading:s,subActiveKey:H,onlineFormRef:a,getFieldsValue:R,setFieldsValue:B,submitFlowFlag:d,subFormHeight:J,subTableHeight:U,refMap:T,triggleChangeValues:function(e,t,n){t&&n?n.setValues?n.setValues(e):n.setValues([{rowKey:t,values:e}]):B(e)},triggleChangeValue:function(e,t){let n={};n[e]=t,B(n)},sh:w,clearSubRows:K,addSubRows:z,clearThenAddRows:function(e,t){K(e),z(e,t)},changeOptions:function(e,t){!t&&t.length<=0&&(t=[]),t.map((e=>{e.hasOwnProperty("label")||(e.label=e.text)})),A({field:e,componentProps:{options:t}})},isUpdate:c,getSubTableInstance:function(e){let t=T[e].value;return t instanceof Array&&(t=t[0]),t}};return m(Y),{tableName:y,onlineFormRef:a,registerForm:M,loading:s,subActiveKey:H,hasSubTable:C,subTabInfo:S,refMap:T,subFormHeight:J,getSubTableForeignKeyValue:function(e){if(!0===c.value){return function(e,t){if(e){let n=e[t];return n||0===n||(n=e[t.toLowerCase()],n||0===n||(n=e[t.toUpperCase()])),n}return""}(v.value,e)}return""},isUpdate:c,handleSubFormChange:function(e,t){if(k&&k[t+"_onlChange"]){let n=k[t+"_onlChange"](),l=Object.keys(e)[0];if(n[l]){let o=T[t].value;o instanceof Array&&(o=o[0]);let i=o.getFormEvent(),a=__spreadValues({column:{key:l},value:e[l]},i);n[l].call(p,p,a)}}},subTableHeight:U,onlineFormDisabled:N,subDataSource:F,getSubTableAuthPre:function(e){return"online_"+e+":"},handleAdded:function(e,t){},handleValueChange:function(e,t){if(k&&k[t+"_onlChange"]){let n=k[t+"_onlChange"](p);n[e.column.key]&&n[e.column.key].call(p,p,e)}},openSubFormModalForAdd:function(e){i.value=e.id,o(!0)},openSubFormModalForEdit:function(e){},registerVxeFormModal:l,vxeTableId:i,show:function(t,n,l){return __async(this,null,(function*(){yield V(),v.value="";let o=unref(t);c.value=o,o&&(yield E(n)),yield nextTick((()=>{!o&&l&&B(l),function(){if(!1===unref(c)){loadFormFieldsDefVal(toRaw(g[y.value]),(e=>{B(e)}))}}(),W("js","loaded"),function(){let t=e.disabled;N.value=t,P({disabled:t})}()}))}))},createRootProperties:function(e){return __async(this,null,(function*(){u.value=e.head.tableType,y.value=e.head.tableName,r.value=1==e.head.tableType,function(e){let t={reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:1,modalMinWidth:""};e&&(t=JSON.parse(e));Object.keys(t).map((e=>{f[e]=t[e]}))}(e.head.extConfigJson),O(e.schema.properties,e.schema.required,_),k=D(e.enhanceJs),t("rendered",f),(yield getRefPromise(a)).$formValueChange=(e,n)=>{!function(e,n){__async(this,null,(function*(){if(v.value[e]!=n&&t("dataChange",e),!k||!k.onlChange)return!1;if(!e)return!1;let l=k.onlChange();if(l[e]){let t={row:yield R(),column:{key:e},value:n};l[e].call(p,p,t)}}))}(e,n)}}))},handleSubmit:function(){!0===r.value?function(){__async(this,null,(function*(){try{let e=yield $();e=Object.assign({},v.value,e),e=b(e),s.value=!0,L(e)}finally{s.value=!1}}))}():function(){let e={};return new Promise(((e,t)=>{$().then((t=>e(t)),(({errorFields:e})=>{e&&e.length>0&&I(e[0][0]),t(VALIDATE_FAILED)}))})).then((t=>(Object.assign(e,b(t)),function(){return new Promise(((e,t)=>__async(this,null,(function*(){let n={};try{let e=S.value;for(let t=0;t<e.length;t++){let o=e[t].key,i=T[o].value;if(i instanceof Array&&(i=i[0]),1==e[t].relationType)try{let e=yield i.getAll();n[o]=[],n[o].push(e)}catch(l){throw{code:VALIDATE_FAILED,key:o}}else{if(yield i.fullValidateTable())throw{code:VALIDATE_FAILED,key:o};n[o]=i.getTableData()}}}catch(l){t(l)}e(n)}))))}()))).then((t=>(Object.assign(e,t),Promise.resolve(e)))).catch((e=>(e!==VALIDATE_FAILED&&(null==e?void 0:e.code)!==VALIDATE_FAILED||(n.warning("校验未通过"),e.key&&function(e){let t=S.value;for(let n=0;n<t.length;n++)if(e==t[n].key){H.value=n+"";break}}(e.key)),Promise.reject(null))))}().then((e=>{L(e)}))},sh:w,handleCgButtonClick:W,handleCustomFormSh:function(e,t){let n=toRaw(w);e&&e.length>0?Object.keys(n).map((t=>{!t.endsWith("_load")&&e.indexOf(t)<0&&(w[t]=!1)})):t&&t.length>0&&Object.keys(n).map((e=>{t.indexOf(e)>=0&&(w[e]=!1)}))},handleCustomFormEdit:function(e){return __async(this,null,(function*(){yield V(),v.value="",c.value=!0,yield E(e),yield nextTick((()=>{W("js","loaded")}))}))},dbData:v,onOpenReportPrint:function(){let e=f.reportPrintUrl,t=v.value.id,n=getToken();goJmReportViewPage(e,t,n)},onlineExtConfigJson:f,recoverFormData:function(){return __async(this,null,(function*(){let e=v.value,t=j.value,n=pick$1(e,...t);if(e)yield B(n);else{let e={};for(let n of t)e[n]="";yield B(e)}}))}}}},_hoisted_1$3=["id"];function _sfc_render$4(e,t,n,l,o,i){const a=resolveComponent("BasicForm");return openBlock(),createElementBlock("div",{id:l.tableName+"_form"},[createVNode(a,{ref:"onlineFormRef",onRegister:l.registerForm},null,8,["onRegister"])],8,_hoisted_1$3)}var OnlinePopForm=_export_sfc(_sfc_main$4,[["render",_sfc_render$4]]),OnlinePopForm$1=Object.freeze(Object.defineProperty({__proto__:null,default:OnlinePopForm},Symbol.toStringTag,{value:"Module"}));function useAutoModal(e,{emit:t}={},n){const l=ref(null),o=ref(!1),i=ref(1),a=ref([]),r=ref(!1),s=ref(0),u=ref(!1),d=ref(""),c=ref(!1),f=ref(!1),p=ref(!0),m=reactive({}),h=ref(!0),g=ref(""),b=ref(!0),y=ref(!1),{popModalFixedWidth:v,resetBodyStyle:_,popBodyStyle:C}=useFixedHeightModal(),S=ref(!1),T={handleOpenModal:e=>{}},F=ref(""),x=ref(""),O=ref(!1);let w={};const k=computed((()=>{let e=g.value;return e||(!0===unref(o)?"详情":!0===unref(f)?"编辑":"新增")})),[D,{setModalProps:M,closeModal:P}]=useModalInner((t=>__async(this,null,(function*(){g.value="",y.value=!1,!0===e?yield T.handleOpenModal(t):yield function(e){return __async(this,null,(function*(){M({confirmLoading:!1}),f.value=e.isUpdate,o.value=e.disableSubmit||!1,!0===(null==e?void 0:e.hideSub)&&(h.value=!1),(null==e?void 0:e.title)&&(g.value=e.title),(null==e?void 0:e.record)?x.value=e.record.id:x.value="",yield nextTick((()=>__async(this,null,(function*(){yield getRefPromise(r),function(){let e=x.value;1==w.commentStatus&&e?(O.value=!0,M({defaultFullscreen:!0})):O.value=!1}(),yield l.value.show(null==e?void 0:e.isUpdate,null==e?void 0:e.record,null==e?void 0:e.param)}))))}))}(t),_(),n&&n()})))),$=ref(!1);return{title:k,modalWidth:computed((()=>{let e=200*(i.value-1),t=(unref(p)?800:1100)+e;t=function(e){let t=m.modalMinWidth;if(null!=t&&""!==t)try{if(t=Number.parseInt(t),e<t)return t}catch(n){}return e}(t);let n=s.value;return n&&t<n&&(t=n),t})),registerModal:D,closeModal:P,modalObject:T,onCloseEvent:function(){l.value&&l.value.onCloseModal()},cgButtonList:a,handleCgButtonClick:function(e,t){l.value.handleCgButtonClick(e,t)},disableSubmit:o,handleSubmit:function(){c.value=!0,setTimeout((()=>{c.value=!1}),1500),l.value.handleSubmit()},submitLoading:c,handleCancel:function(){P()},successThenClose:b,handleSuccess:function(e){e[ONL_FORM_TABLE_NAME]=F.value,t("success",e),1==b.value&&P(),y.value=!1,b.value=!0},topTipVisible:y,handleFormConfig:function(e,n){return __async(this,null,(function*(){let o=yield function(e,t={}){let n=`/online/cgform/api/getFormItem/${e}`;return new Promise(((e,l)=>{defHttp.get({url:n,params:t},{isTransformResponse:!1}).then((t=>{t.success?e(t.result):l(t.message)})).catch((()=>{l()}))}))}(e,n),r=o.head.formTemplate;i.value=r?Number(r):1,a.value=o.cgButtonList,u.value="Y"===o.head.isTree,d.value=o.head.treeParentIdField||"",F.value=o.head.tableName,!0===o.form_disable_update?S.value=!0:S.value=!1,$.value=!0,t&&t("formConfig",o),yield nextTick((()=>__async(this,null,(function*(){let e=yield getRefPromise(l);yield e.createRootProperties(o)}))))}))},onlineFormCompRef:l,formTemplate:i,isTreeForm:u,pidFieldName:d,renderSuccess:function(e){r.value=!0,s.value=e.modalMinWidth,1==e.modelFullscreen?M({defaultFullscreen:!0}):M({defaultFullscreen:!1}),w=e},formRendered:r,isUpdate:f,showSub:h,tableName:F,formDataId:x,enableComment:O,popBodyStyle:C,popModalFixedWidth:v,getFormStatus:function(){return __async(this,null,(function*(){return yield getRefPromise($),S.value}))}}}function useFixedHeightModal(){const e=ref(800);let t=window.innerWidth-300;t<800&&(t=800),e.value=t;const n=ref({});return{popModalFixedWidth:e,popBodyStyle:n,resetBodyStyle:function(){let e=window.innerHeight-210;n.value={height:e+"px",overflowY:"auto"}}}}const _sfc_main$3=defineComponent({name:"OnlinePopModal",props:{id:{type:String,default:""},showFields:{type:Array,default:()=>[]},hideFields:{type:Array,default:()=>[]},topTip:{type:Boolean,default:!1},request:{type:Boolean,default:!0},saveClose:{type:Boolean,default:!1},isVxeTableData:{type:Boolean,default:!1}},components:{BasicModal:BasicModal,OnlinePopForm:OnlinePopForm,JModalTip:JModalTip,Button:Button},emits:["success","register","formConfig"],setup(e,{emit:t}){const{title:n,registerModal:l,cgButtonList:o,handleCgButtonClick:i,disableSubmit:a,handleSubmit:r,submitLoading:s,handleCancel:u,handleFormConfig:d,onlineFormCompRef:c,formTemplate:f,isTreeForm:p,pidFieldName:m,renderSuccess:g,formRendered:b,handleSuccess:y,topTipVisible:v,successThenClose:_,isUpdate:C,popBodyStyle:S,popModalFixedWidth:T,getFormStatus:F}=useAutoModal(!1,{emit:t});watch((()=>e.id),(function(){return __async(this,null,(function*(){b.value=!1,e.id&&(yield d(e.id,{}))}))}),{immediate:!0});const x=computed((()=>!!C.value&&e.topTip)),O=computed((()=>{if(1==C.value)return null;{let e=s.value;return[h(Button,{type:"primary",loading:e,onClick:r},(()=>"确定")),h(Button,{onClick:u},(()=>"关闭"))]}}));return{title:n,topTipVisible:v,handleSaveData:function(){!1===e.saveClose&&(_.value=!1),r()},handleRecover:function(){v.value=!1,c.value.recoverFormData()},onlineFormCompRef:c,renderSuccess:g,registerModal:l,handleSubmit:r,handleSuccess:y,handleCancel:u,formTemplate:f,disableSubmit:a,cgButtonList:o,handleCgButtonClick:i,isTreeForm:p,pidFieldName:m,submitLoading:s,handleDataChange:function(){v.value=!0},isUpdate:C,showTopTip:x,modalFooter:O,popBodyStyle:S,popModalFixedWidth:T,getFormStatus:F}}});function _sfc_render$3(e,t,n,l,o,i){const a=resolveComponent("j-modal-tip"),r=resolveComponent("online-pop-form"),s=resolveComponent("BasicModal");return openBlock(),createBlock(s,mergeProps({width:e.popModalFixedWidth,dialogStyle:{top:"70px"},bodyStyle:e.popBodyStyle},e.$attrs,{footer:e.modalFooter,cancelText:"关闭",onRegister:e.registerModal,wrapClassName:"jeecg-online-pop-modal",onOk:e.handleSubmit}),{title:withCtx((()=>[createTextVNode(toDisplayString(e.title)+" ",1),e.showTopTip?(openBlock(),createBlock(a,{key:0,visible:e.topTipVisible,onSave:e.handleSaveData,onCancel:e.handleRecover},null,8,["visible","onSave","onCancel"])):createCommentVNode("",!0)])),default:withCtx((()=>[createVNode(r,{ref:"onlineFormCompRef",id:e.id,disabled:e.disableSubmit,"form-template":e.formTemplate,isTree:e.isTreeForm,pidField:e.pidFieldName,request:e.request,isVxeTableData:e.isVxeTableData,onRendered:e.renderSuccess,onSuccess:e.handleSuccess,onDataChange:e.handleDataChange,"modal-class":"jeecg-online-pop-modal"},null,8,["id","disabled","form-template","isTree","pidField","request","isVxeTableData","onRendered","onSuccess","onDataChange"])])),_:1},16,["width","bodyStyle","footer","onRegister","onOk"])}var OnlinePopModal=_export_sfc(_sfc_main$3,[["render",_sfc_render$3]]),OnlinePopModal$1=Object.freeze(Object.defineProperty({__proto__:null,default:OnlinePopModal},Symbol.toStringTag,{value:"Module"}));function queryTableData(e,t){const n="/online/cgform/api/getData/"+e;return defHttp.get({url:n,params:t})}function queryTableColumns(e,t){const n="/online/cgform/api/getColumns/"+e;return defHttp.get({url:n,params:t})}function useLinkTable(e){const t=ref("1"),n=ref({}),l=ref({}),o=ref(""),i=reactive({add:!0,update:!0}),a=computed((()=>e.textField?e.textField.split(","):[])),r=ref([]),s=computed((()=>{let t=r.value;return 1==e.multi?t.slice(0,3):t.slice(0,6)}));watchEffect((()=>__async(this,null,(function*(){if(e.tableName){let t=e.valueField||"",l=e.textField||"",a=[];if(t&&a.push(t),l){let e=l.split(",");o.value=e[0];for(let t of e)a.push(t)}let s=e.imageField||"";s&&a.push(s),n.value={linkTableSelectFields:a.join(",")},yield function(){return __async(this,null,(function*(){let t=n.value;const l=yield queryTableColumns(e.tableName,t);if(c.value=l.columns,l.columns){let t=e.imageField,n=l.columns.filter((e=>e.dataIndex!=o.value&&e.dataIndex!=t));r.value=n}if(f.value=l.dictOptions,l.hideColumns){let e=l.hideColumns;e.indexOf("add")>=0?i.add=!1:i.add=!0,e.indexOf("update")>=0?i.update=!1:i.update=!0}}))}(),yield p()}}))));const u=computed((()=>{let t=e.textField||"",n=[],l="";if(t){let e=t.split(",");l=e[0];for(let t=0;t<e.length;t++)t>0&&n.push(e[t])}return{others:n,labelField:l}})),d=ref([]),c=ref([]),f=ref({});function p(){return __async(this,null,(function*(){let o=Object.assign({pageSize:10,pageNo:t.value},n.value,l.value);let i=(yield queryTableData(e.tableName,o)).records,a=[],{others:r,labelField:s}=u.value,c=e.imageField;if(i&&i.length>0)for(let t of i){let n=__spreadValues({},t);m(n);let l=Object.assign({},pick$1(n,r),{id:n.id,label:n[s],value:n[e.valueField]});c&&(l[c]=n[c]),a.push(l)}a.push({}),d.value=a}))}function m(e){let t=c.value,n=f.value;for(let l of t){const{dataIndex:t,customRender:o}=l;(e[t]||0===e[t])&&o&&o==t&&n[o]&&(e[t]=filterMultiDictText(n[o],e[t]))}}const h=computed((()=>!!e.imageField));return{pageNo:t,otherColumns:r,realShowColumns:s,selectOptions:d,reloadTableLinkOptions:p,textFieldArray:a,addQueryParams:function(e){if(e){let t=a.value,n=[],o=[];for(let l=0;l<t.length;l++)l<=1&&(o.push(t[l]),n.push({field:t[l],rule:"like",val:e}));n.superQueryMatchType="or",n.superQueryParams=encodeURI(JSON.stringify(n)),l.value=n}else l.value={}},tableColumns:c,transData:m,mainContentField:o,loadOne:function(l){return __async(this,null,(function*(){if(!l)return[];let o=e.valueField,i=__spreadProps(__spreadValues({},n.value),{pageSize:10,pageNo:t.value});i.superQueryMatchType="and";let a=[{field:o,rule:"in",val:l}];i.superQueryParams=encodeURI(JSON.stringify(a));let r=(yield queryTableData(e.tableName,i)).records,s=[];if(r&&r.length>0)for(let e of r){let t=__spreadValues({},e);m(t),s.push(t)}return s}))},compareData:function(t,n){if(!t||0==t.length)return!1;let l=n.split(",");if(l.length!=t.length)return!1;let o=!0;for(let i of t){let t=i[e.valueField];l.indexOf(t)<0&&(o=!1)}return o},formatData:function(e){Object.keys(e).map((t=>{e[t]instanceof Array&&(e[t]=e[t].join(","))}))},initFormData:function(e,t,n){if(n||(n={}),t&&t.length>0)for(let l of t){let t=l.split(","),o=t[0],i=t[1];if(e[o])e[o].push(n[i]);else{let t=n[i]||"";e[o]=[t]}}},getImageSrc:function(t){if(e.imageField){let n=t[e.imageField];return getFileAccessHttpUrl(n)}return""},showImage:h,auths:i}}const _sfc_main$2={name:"LinkTableSelect",components:{PlusOutlined:PlusOutlined,EditOutlined:EditOutlined,OnlinePopModal:OnlinePopModal},props:{valueField:propTypes.string.def(""),textField:propTypes.string.def(""),tableName:propTypes.string.def(""),multi:propTypes.bool.def(!1),value:propTypes.oneOfType([propTypes.string,propTypes.number,propTypes.array]),linkFields:propTypes.array.def([]),imageField:propTypes.string.def([])},emits:["change","update:value"],setup(e,{emit:t}){const n=ref([]),{auths:l,mainContentField:o,textFieldArray:i,selectOptions:a,reloadTableLinkOptions:r,addQueryParams:s,formatData:u,initFormData:d,getImageSrc:c,showImage:f}=useLinkTable(e),[p,{openModal:m}]=useModal(),h=computed((()=>e.tableName)),g=computed((()=>!0===e.multi?{mode:"multiple"}:{}));function b(n){let l={},i=e.linkFields,r=[];if(n){let t=toRaw(a.value),s=toRaw(n);r=s instanceof Array?[...s]:1==e.multi?s.split(","):[s];let u=t.filter((t=>r.indexOf(t[e.valueField])>=0));if(u&&u.length>0){let e=__spreadValues({},u[0]);if(u.length>1)for(let t=1;t<u.length;t++)e=y(e,u[t]);e[o.value]=e.label,d(l,i,e)}}else d(l,i);u(l),t("change",r.join(",")||"",l),t("update:value",r.join(",")||"")}function y(e,t){let n={};return Object.keys(e).map((l=>{n[l]=(e[l]||"")+","+(t[l]||"")})),n}return watch((()=>e.value),(t=>__async(this,null,(function*(){t?(1==e.multi?n.value=t.split(","):n.value=t,e.linkFields&&e.linkFields.length>0&&b(t)):n.value=[]}))),{immediate:!0}),watch((()=>a.value),(t=>{t&&t.length>0&&e.linkFields&&e.linkFields.length>0&&n.value&&n.value.length>0&&b(n.value)})),{selectValue:n,selectOptions:a,registerPopModal:p,popTableName:h,textFieldArray:i,handleClickAdd:function(e){null==e||e.stopPropagation(),null==e||e.preventDefault(),m(!0,{})},handleClickEdit:function(e,t){null==e||e.stopPropagation(),null==e||e.preventDefault(),0!=l.update&&m(!0,{isUpdate:!0,record:t})},getFormData:function(t){return __async(this,null,(function*(){yield r();let l=t[e.valueField];n.value=l}))},handleSearch:useDebounceFn((function(e){s(e),r()}),800),handleChange:function(e){b(e),e||(s(),r())},bindValue:g,showImage:f,getImageSrc:c,auths:l}}},_hoisted_1$2={key:1,class:"online-select-item"},_hoisted_2$2={key:0,class:"left-avatar"},_hoisted_3$2=["src"],_hoisted_4$2={class:"right-content"},_hoisted_5$2={class:"label"},_hoisted_6$2={class:"others"},_hoisted_7$1={class:"other-item ellipsis"};function _sfc_render$2(e,t,n,l,o,i){const a=resolveComponent("PlusOutlined"),r=resolveComponent("EditOutlined"),s=resolveComponent("a-select"),u=resolveComponent("online-pop-modal");return openBlock(),createElementBlock("div",null,[createVNode(s,mergeProps({value:l.selectValue,"onUpdate:value":t[1]||(t[1]=e=>l.selectValue=e),style:{width:"100%"},placeholder:"请选择","option-label-prop":"label",dropdownClassName:"table-link-select",allowClear:"","show-search":""},l.bindValue,{options:l.selectOptions,"filter-option":!1,"not-found-content":null,onSearch:l.handleSearch,onChange:l.handleChange}),{option:withCtx((e=>[!e.value&&l.auths.add?(openBlock(),createElementBlock("div",{key:0,class:"opt-add",onClick:t[0]||(t[0]=(...e)=>l.handleClickAdd&&l.handleClickAdd(...e))},[createVNode(a),createTextVNode(" 记录 ")])):(openBlock(),createElementBlock("div",_hoisted_1$2,[l.showImage?(openBlock(),createElementBlock("div",_hoisted_2$2,[l.getImageSrc(e)?(openBlock(),createElementBlock("img",{key:0,src:l.getImageSrc(e),alt:""},null,8,_hoisted_3$2)):createCommentVNode("",!0)])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_4$2,[createBaseVNode("div",_hoisted_5$2,[l.auths.update?(openBlock(),createBlock(r,{key:0,onClick:t=>l.handleClickEdit(t,e)},null,8,["onClick"])):createCommentVNode("",!0),createTextVNode(" "+toDisplayString(e.label),1)]),createBaseVNode("div",_hoisted_6$2,[(openBlock(!0),createElementBlock(Fragment,null,renderList(l.textFieldArray,(t=>(openBlock(),createElementBlock("div",_hoisted_7$1,toDisplayString(e[t]),1)))),256))])])]))])),_:1},16,["value","options","onSearch","onChange"]),createVNode(u,{id:l.popTableName,onRegister:l.registerPopModal,onSuccess:l.getFormData,topTip:""},null,8,["id","onRegister","onSuccess"])])}var LinkTableSelect=_export_sfc(_sfc_main$2,[["render",_sfc_render$2],["__scopeId","data-v-2f5e23a7"]]),LinkTableSelect$1=Object.freeze(Object.defineProperty({__proto__:null,default:LinkTableSelect},Symbol.toStringTag,{value:"Module"}));function useTableColumns(onlineTableContext,extConfigJson){let router=useRouter();const columns=ref([]),dictOptionInfo=ref({}),selectedKeys=ref([]),rowSelection=ref(null);let enableScrollBar=ref(!0),tableScroll=computed((()=>1==enableScrollBar.value?void 0:{x:!1}));const[registerOnlineHrefModal,{openModal:openOnlineHrefModal}]=useModal(),hrefMainTableId=ref(""),[registerPopModal,{openModal:openPopModal}]=useModal(),popTableId=ref("");function handleColumnResult(e){dictOptionInfo.value=e.dictOptions,"Y"==e.checkboxFlag?rowSelection.value={selectedRowKeys:selectedKeys,onChange:onSelectChange}:rowSelection.value=null,enableScrollBar.value=1==e.scrollFlag;let t=e.columns;t.forEach((e=>{Object.keys(e).map((t=>{null==e[t]&&delete e[t]}))}));let n=e.fieldHrefSlots;const l={};n.forEach((e=>l[e.slotName]=e));let o=[];if(o=handleColumnHrefAndDict(t,l),bpmStatusFilter(o),!0===onlineTableContext.isTree()){let t=e.textField,n=-1;for(let e=0;e<o.length;e++)if(o[e].dataIndex==t){n=e;break}if(n>0){let e=o.splice(n,1);o.unshift(e[0])}o.length>0&&(o[0].align="left")}columns.value=o,onlineTableContext.reloadTable()}function onSelectChange(e,t){selectedKeys.value=e,onlineTableContext.selectedRows=toRaw(t),onlineTableContext.selectedRowKeys=toRaw(e)}function handleColumnHrefAndDict(e,t){for(let n of e){let{customRender:e,hrefSlotName:l,fieldType:o}=n;if("date"==o||"Date"==o)n.customRender=({text:e})=>e?e.length>10?e.substring(0,10):e:"";else if("link_table"==o)n.customRender=({text:e,record:t})=>{if(!e)return"";if(!0===onlineTableContext.isPopList)return t[n.dataIndex+"_dictText"];{let o=(e+"").split(","),i=t[n.dataIndex+"_dictText"].split(","),a=[];for(let e=0;e<o.length;e++){let t=h(LinkTableListPiece,{id:o[e],text:i[e],onTab:e=>handleClickLinkTable(e,l)});a.push(t)}return 0==a.length?"":h("div",{style:{overflow:"hidden"}},a)}};else{if(!l&&n.scopedSlots&&n.scopedSlots.customRender&&t.hasOwnProperty(n.scopedSlots.customRender)&&(l=n.scopedSlots.customRender),e||l){let o=e,i="_replace_text_";n.ellipsis=!0,n.customRender=({text:e,record:a})=>{let r=e;if(o)if(o.startsWith(i)){let e=o.replace(i,"");r=a[e]}else r=filterMultiDictText(unref(dictOptionInfo)[o],e+"");if(n.showLength&&r&&r.length>n.showLength&&(r=r.substr(0,n.showLength)+"..."),l){let e=t[l];if(e)return h("a",{onClick:()=>handleClickFieldHref(e,a)},r)}return r}}if(n.scopedSlots){n.ellipsis=!0;let e=n.scopedSlots;n.slots=e,delete n.scopedSlots}}}return e}function handleClickFieldHref(field,record){let href=field.href,urlPattern=/(ht|f)tp(s?)\:\/\/[0-9a-zA-Z]([-.\w]*[0-9a-zA-Z])*(:(0-9)*)*(\/?)([a-zA-Z0-9\-\.\?\,\'\/\\\+&amp;%\$#_]*)?/,compPattern=/\.vue(\?.*)?$/,jsPattern=/{{([^}]+)}}/g;if("string"==typeof href)if(href.startsWith("ONLINE:")){let e=href.split(":");hrefMainTableId.value=e[1];let t=e[2];openOnlineHrefModal(!0,{isUpdate:!0,disableSubmit:!0,hideSub:!0,record:{id:record[t]}})}else href=href.trim().replace(/\${([^}]+)?}/g,((e,t)=>record[t])),jsPattern.test(href)&&(href=href.replace(jsPattern,(function(text,s0){try{return eval(s0)}catch(e){return text}}))),urlPattern.test(href)?window.open(href,"_blank"):compPattern.test(href)?openHrefCompModal(href):router.push(href)}const dialogStyle={top:0,left:0,height:"100%",margin:0,padding:0},hrefComponent=reactive({model:{title:"",okText:"关闭",width:"100%",visible:!1,destroyOnClose:!0,style:dialogStyle,bodyStyle:{padding:"8px",height:"calc(100vh - 108px)",overflow:"auto",overflowX:"hidden"},cancelButtonProps:{style:{display:"none"}}},on:{ok:()=>hrefComponent.model.visible=!1,cancel:()=>hrefComponent.model.visible=!1},is:null,params:{}});function openHrefCompModal(e){let t=e.indexOf("?"),n=e;if(-1!==t){n=e.substring(0,t);let l=e.substring(t+1,e.length).split("&"),o={};l.forEach((e=>{let t=e.split("=");o[t[0]]=t[1]})),hrefComponent.params=o}else hrefComponent.params={};hrefComponent.model.visible=!0,hrefComponent.model.title="操作",hrefComponent.is=markRaw(defineAsyncComponent((()=>importViewsFile(n))))}let fixedAction="left";onlineTableContext.isTree()&&(fixedAction="right");const actionColumn=reactive({title:"操作",dataIndex:"action",slots:{customRender:"action"},fixed:fixedAction,align:"center",width:150});function bpmStatusFilter(e){let t=!1;for(let n=0;n<e.length;n++){if("bpm_status"==e[n].dataIndex.toLowerCase()){t=!0;break}}return onlineTableContext.hasBpmStatus=t,t}function downloadRowFile(e){if(!e)return;e.indexOf(",")>0&&(e=e.substring(0,e.indexOf(",")));let t=getFileAccessHttpUrl(e);window.open(t)}function getImgView(e){return e&&e.indexOf(",")>0&&(e=e.substring(0,e.indexOf(","))),getFileAccessHttpUrl(e)}function getPcaText(e){return e?getAreaTextByCode(e):""}function getFormatDate(e){if(!e)return"";let t=e;return t.length>10&&(t=t.substring(0,10)),t}function viewOnlineCellImage(e){if(e){let t=[],n=e.split(",");for(let e of n)e&&t.push(getFileAccessHttpUrl(e));createImgPreview({imageList:t})}}watch((()=>null==extConfigJson?void 0:extConfigJson.value),(()=>{var e,t;1===(null==(e=null==extConfigJson?void 0:extConfigJson.value)?void 0:e.tableFixedAction)&&(actionColumn.fixed=(null==(t=null==extConfigJson?void 0:extConfigJson.value)?void 0:t.tableFixedActionType)||"right",onlineTableContext.isTree()&&(actionColumn.fixed="right"))})),watch(selectedKeys,(()=>{onlineTableContext.selectedRowKeys=toRaw(selectedKeys.value)})),onlineTableContext.clearSelectedRow=()=>{selectedKeys.value=[],onlineTableContext.selectedRows=[],onlineTableContext.selectedRowKeys=[]};const onlinePopModalRef=ref();function handleClickLinkTable(e,t){return __async(this,null,(function*(){popTableId.value=t,1==(yield onlinePopModalRef.value.getFormStatus())?(hrefMainTableId.value=t,openOnlineHrefModal(!0,{isUpdate:!0,disableSubmit:!0,hideSub:!0,record:{id:e}})):openPopModal(!0,{isUpdate:!0,record:{id:e}})}))}return{columns:columns,actionColumn:actionColumn,selectedKeys:selectedKeys,rowSelection:rowSelection,enableScrollBar:enableScrollBar,tableScroll:tableScroll,downloadRowFile:downloadRowFile,getImgView:getImgView,getPcaText:getPcaText,getFormatDate:getFormatDate,handleColumnResult:handleColumnResult,onSelectChange:onSelectChange,hrefComponent:hrefComponent,viewOnlineCellImage:viewOnlineCellImage,hrefMainTableId:hrefMainTableId,registerOnlineHrefModal:registerOnlineHrefModal,registerPopModal:registerPopModal,openPopModal:openPopModal,openOnlineHrefModal:openOnlineHrefModal,onlinePopModalRef:onlinePopModalRef,popTableId:popTableId}}const _sfc_main$1=defineComponent({name:"OnlinePopListModal",props:{id:{type:String,default:""},multi:{type:Boolean,default:!1},addAuth:{type:Boolean,default:!0}},components:{BasicModal:BasicModal,BasicTable:BasicTable,TableAction:TableAction,PlusOutlined:PlusOutlined,OnlinePopModal:OnlinePopModal},emits:["success","register"],setup(e,{emit:t}){const{createMessage:n}=useMessage(),{popModalFixedWidth:l,resetBodyStyle:o,popBodyStyle:i}=useFixedHeightModal(),a=ref(""),r=ref(800),[s,{closeModal:u}]=useModalInner((()=>{a.value="",M.value=[],P.value=[],k({current:1}),w(),o()})),[d,{openModal:c}]=useModal();const f=computed((()=>{const e=M.value;return!(e&&e.length>0)})),p=ref(!1);const m={isPopList:!0,reloadTable(){},isTree:()=>!1},h=ref({}),{columns:g,downloadRowFile:b,getImgView:y,getPcaText:v,getFormatDate:_,handleColumnResult:C,hrefComponent:S,viewOnlineCellImage:T}=useTableColumns(m,h);const F=ref("");watch((()=>e.id),(()=>__async(this,null,(function*(){let t=yield function(){const t="/online/cgform/api/getColumns/"+e.id;return new Promise(((e,l)=>{defHttp.get({url:t},{isTransformResponse:!1}).then((t=>{t.success?e(t.result):(n.warning(t.message),l())}))}))}();C(t),F.value=t.description}))),{immediate:!0});const{tableContext:x}=useListPage({designScope:"process-design",pagination:!0,tableProps:{title:"",api:function(t){return t.column="id",new Promise(((n,l)=>__async(this,null,(function*(){const l=yield function(t){const n="/online/cgform/api/getData/"+e.id;return defHttp.get({url:n,params:t})}(t);n(l)}))))},clickToRowSelect:!0,columns:g,showTableSetting:!1,immediate:!1,canResize:!1,showActionColumn:!1,actionColumn:{dataIndex:"action",slots:{customRender:"action"}},useSearchForm:!1,beforeFetch:e=>function(e){let t=a.value;if(!t)return e.superQueryMatchType="or",e.superQueryParams="",e;let n=g.value,l=[];if(n&&n.length>0)for(let o of n)o.dbType&&("string"==o.dbType?l.push({field:o.dataIndex,type:o.dbType.toLowerCase(),rule:"like",val:t}):"Date"==o.dbType?t.length=="2020-10-10".length&&l.push({field:o.dataIndex,type:o.dbType.toLowerCase(),rule:"eq",val:t}):"Datetime"==o.dbType?t.length=="2020-10-10 10:10:10".length&&l.push({field:o.dataIndex,type:o.dbType.toLowerCase(),rule:"eq",val:t}):V.indexOf(o.dbType)&&l.push({field:o.dataIndex,type:o.dbType.toLowerCase(),rule:"eq",val:t}));return e.superQueryMatchType="or",e.superQueryParams=encodeURI(JSON.stringify(l)),e}(e)}}),[O,{reload:w,setPagination:k},{rowSelection:D,selectedRowKeys:M,selectedRows:P}]=x;function $(e){}watch((()=>e.multi),(e=>{D.type=1==e?"checkbox":"radio"}),{immediate:!0});const V=["int","double","Date","Datetime","BigDecimal"];return{registerModal:s,modalWidth:r,handleCancel:function(){u()},submitDisabled:f,submitLoading:p,handleSubmit:function(){p.value=!0;let e=toRaw(P.value);e&&e.length>0&&(t("success",e),u()),setTimeout((()=>{p.value=!1}),200)},registerTable:O,getTableAction:function(e){return[{label:"编辑",onClick:$.bind(null,e)}]},searchText:a,onSearch:function(){w()},downloadRowFile:b,getImgView:y,getPcaText:v,getFormatDate:_,hrefComponent:S,viewOnlineCellImage:T,rowSelection:D,modalTitle:F,registerPopModal:d,handleAdd:function(){c(!0,{})},reload:w,popModalFixedWidth:l,popBodyStyle:i,handleDataSave:function(e){t("success",[e]),u()}}}}),_hoisted_1$1={style:{display:"inline-block",width:"calc(100% - 140px)","text-align":"left"}},_hoisted_2$1={key:0,style:{"font-size":"12px","font-style":"italic"}},_hoisted_3$1={key:0,style:{"font-size":"12px","font-style":"italic"}},_hoisted_4$1=["src","onClick"],_hoisted_5$1=["innerHTML"],_hoisted_6$1=["title"];function _sfc_render$1(e,t,n,l,o,i){const a=resolveComponent("PlusOutlined"),r=resolveComponent("a-button"),s=resolveComponent("a-input-search"),u=resolveComponent("TableAction"),d=resolveComponent("BasicTable"),c=resolveComponent("BasicModal"),f=resolveComponent("online-pop-modal");return openBlock(),createElementBlock(Fragment,null,[createVNode(c,{onRegister:e.registerModal,width:e.popModalFixedWidth,dialogStyle:{top:"70px"},bodyStyle:e.popBodyStyle,title:e.modalTitle,wrapClassName:"jeecg-online-pop-list-modal"},{footer:withCtx((()=>[createBaseVNode("div",_hoisted_1$1,[e.addAuth?(openBlock(),createBlock(r,{key:0,style:{"border-radius":"50px"},type:"primary",onClick:e.handleAdd},{default:withCtx((()=>[createVNode(a),createTextVNode("新增记录")])),_:1},8,["onClick"])):createCommentVNode("",!0)]),createVNode(r,{key:"back",onClick:e.handleCancel},{default:withCtx((()=>[createTextVNode("关闭")])),_:1},8,["onClick"]),createVNode(r,{disabled:e.submitDisabled,key:"submit",type:"primary",onClick:e.handleSubmit,loading:e.submitLoading},{default:withCtx((()=>[createTextVNode("确定")])),_:1},8,["disabled","onClick","loading"])])),default:withCtx((()=>[createVNode(d,{onRegister:e.registerTable,rowSelection:e.rowSelection},{title:withCtx((()=>[createVNode(s,{value:e.searchText,"onUpdate:value":t[0]||(t[0]=t=>e.searchText=t),onSearch:e.onSearch,placeholder:"请输入关键词，按回车搜索",style:{width:"100%"}},null,8,["value","onSearch"])])),action:withCtx((({record:t})=>[createVNode(u,{actions:e.getTableAction(t)},null,8,["actions"])])),fileSlot:withCtx((({text:t})=>[t?(openBlock(),createBlock(r,{key:1,ghost:!0,type:"primary",preIcon:"ant-design:download",size:"small",onClick:n=>e.downloadRowFile(t)},{default:withCtx((()=>[createTextVNode(" 下载 ")])),_:2},1032,["onClick"])):(openBlock(),createElementBlock("span",_hoisted_2$1,"无文件"))])),imgSlot:withCtx((({text:t})=>[t?(openBlock(),createElementBlock("img",{key:1,src:e.getImgView(t),alt:"图片不存在",class:"online-cell-image",onClick:n=>e.viewOnlineCellImage(t)},null,8,_hoisted_4$1)):(openBlock(),createElementBlock("span",_hoisted_3$1,"无图片"))])),htmlSlot:withCtx((({text:e})=>[createBaseVNode("div",{innerHTML:e},null,8,_hoisted_5$1)])),pcaSlot:withCtx((({text:t})=>[createBaseVNode("div",{title:e.getPcaText(t)},toDisplayString(e.getPcaText(t)),9,_hoisted_6$1)])),dateSlot:withCtx((({text:t})=>[createBaseVNode("span",null,toDisplayString(e.getFormatDate(t)),1)])),_:1},8,["onRegister","rowSelection"])])),_:1},8,["onRegister","width","bodyStyle","title"]),createVNode(f,{id:e.id,onRegister:e.registerPopModal,onSuccess:e.handleDataSave,topTip:""},null,8,["id","onRegister","onSuccess"])],64)}var OnlinePopListModal=_export_sfc(_sfc_main$1,[["render",_sfc_render$1]]),OnlinePopListModal$1=Object.freeze(Object.defineProperty({__proto__:null,default:OnlinePopListModal},Symbol.toStringTag,{value:"Module"}));const _sfc_main={name:"LinkTableCard",props:{valueField:propTypes.string.def(""),textField:propTypes.string.def(""),tableName:propTypes.string.def(""),multi:propTypes.bool.def(!1),value:propTypes.oneOfType([propTypes.string,propTypes.number]),linkFields:propTypes.array.def([]),disabled:propTypes.bool.def(!1),detail:propTypes.bool.def(!1),imageField:propTypes.string.def([])},components:{PlusOutlined:PlusOutlined,MinusCircleFilled:MinusCircleFilled$1,OnlinePopListModal:OnlinePopListModal,OnlinePopModal:OnlinePopModal},emits:["change","update:value"],setup(e,{emit:t}){const n=computed((()=>e.tableName)),[l,{openModal:o}]=useModal(),[i,{openModal:a}]=useModal(),r=ref([]),s=ref([]),u=computed((()=>1!=e.disabled&&!(!1===e.multi&&s.value.length>0))),{auths:d,otherColumns:c,realShowColumns:f,tableColumns:p,textFieldArray:m,transData:h,loadOne:g,compareData:b,formatData:y,initFormData:v,getImageSrc:_,showImage:C}=useLinkTable(e),S=computed((()=>!0===e.multi?12:24)),T=computed((()=>!0===e.multi?24:12));function F(e){null==e||e.stopPropagation(),null==e||e.preventDefault()}function x(){let n=s.value,l=[],o={},i=e.linkFields;if(n.length>0)for(let t=0;t<n.length;t++)l.push(n[t][e.valueField]),v(o,i,n[t]);else v(o,i);let a=l.join(",");y(o),t("change",a,o),t("update:value",a)}return watch((()=>e.value),(t=>__async(this,null,(function*(){if(t){if(!1===b(s.value,t)){let e=yield g(t);s.value=e}e.linkFields&&e.linkFields.length>0&&x()}else s.value=[]}))),{immediate:!0}),{popTableName:n,selectRecords:s,otherColumns:c,realShowColumns:f,showButton:u,selectValue:r,handleAddRecord:function(e){o(!0,{})},handleDeleteRecord:function(e,t){F(e);let n=s.value;n&&n.length>t&&(n.splice(t,1),s.value=n),x()},getMainContent:function(e){if(e&&m.value.length>0){return e[m.value[0]]}},itemSpan:S,columnSpan:T,tableColumns:p,addCard:function(e){let t=s.value;for(let n of e){let e=__spreadValues({},n);h(e),t.push(e)}s.value=t,x()},registerListModal:l,registerFormModal:i,handleClickEdit:function(t,n){F(t),0!=d.update&&0==e.disabled&&a(!0,{isUpdate:!0,record:n})},updateCardData:function(e){let t=s.value;for(let n=0;n<t.length;n++)if(t[n].id===e.id){let l=__spreadValues({},e);h(l),t.splice(n,1,l)}s.value=t,x()},getImageSrc:_,showImage:C,auths:d}}},_hoisted_1={class:"table-link-card"},_hoisted_2={style:{width:"100%",height:"100%"}},_hoisted_3={key:0,class:"card-button"},_hoisted_4=["onClick"],_hoisted_5={key:0,class:"card-delete"},_hoisted_6={class:"card-inner"},_hoisted_7={class:"card-main-content"},_hoisted_8={class:"other-content"},_hoisted_9={class:"label ellipsis"},_hoisted_10={class:"text ellipsis"},_hoisted_11={key:0,class:"card-item-image"},_hoisted_12=["src"];function _sfc_render(e,t,n,l,o,i){const a=resolveComponent("PlusOutlined"),r=resolveComponent("a-button"),s=resolveComponent("minus-circle-filled"),u=resolveComponent("a-col"),d=resolveComponent("a-row"),c=resolveComponent("online-pop-list-modal"),f=resolveComponent("online-pop-modal");return openBlock(),createElementBlock("div",null,[createBaseVNode("div",_hoisted_1,[createBaseVNode("div",_hoisted_2,[l.showButton?(openBlock(),createElementBlock("div",_hoisted_3,[createVNode(r,{onClick:l.handleAddRecord},{default:withCtx((()=>[createVNode(a),createTextVNode("记 录")])),_:1},8,["onClick"])])):createCommentVNode("",!0),createVNode(d,null,{default:withCtx((()=>[(openBlock(!0),createElementBlock(Fragment,null,renderList(l.selectRecords,((e,t)=>(openBlock(),createBlock(u,{span:l.itemSpan},{default:withCtx((()=>[createBaseVNode("div",{class:normalizeClass(["card-item",{"disabled-chunk":1==n.detail}]),onClick:t=>l.handleClickEdit(t,e)},[createBaseVNode("div",{class:normalizeClass(["card-item-left",{"show-right-image":l.showImage}])},[0==n.disabled?(openBlock(),createElementBlock("span",_hoisted_5,[createVNode(s,{onClick:e=>l.handleDeleteRecord(e,t)},null,8,["onClick"])])):createCommentVNode("",!0),createBaseVNode("div",_hoisted_6,[createBaseVNode("div",_hoisted_7,toDisplayString(l.getMainContent(e)),1),createBaseVNode("div",_hoisted_8,[createVNode(d,null,{default:withCtx((()=>[(openBlock(!0),createElementBlock(Fragment,null,renderList(l.realShowColumns,(t=>(openBlock(),createBlock(u,{span:l.columnSpan},{default:withCtx((()=>[createBaseVNode("span",_hoisted_9,toDisplayString(t.title),1),createBaseVNode("span",_hoisted_10,toDisplayString(e[t.dataIndex]),1)])),_:2},1032,["span"])))),256))])),_:2},1024)])])],2),l.showImage?(openBlock(),createElementBlock("div",_hoisted_11,[l.getImageSrc(e)?(openBlock(),createElementBlock("img",{key:0,src:l.getImageSrc(e),alt:""},null,8,_hoisted_12)):createCommentVNode("",!0)])):createCommentVNode("",!0)],10,_hoisted_4)])),_:2},1032,["span"])))),256))])),_:1})])]),createVNode(c,{onRegister:l.registerListModal,multi:n.multi,id:l.popTableName,addAuth:l.auths.add,onSuccess:l.addCard},null,8,["onRegister","multi","id","addAuth","onSuccess"]),createVNode(f,{id:l.popTableName,onRegister:l.registerFormModal,onSuccess:l.updateCardData,topTip:""},null,8,["id","onRegister","onSuccess"])])}var LinkTableCard=_export_sfc(_sfc_main,[["render",_sfc_render],["__scopeId","data-v-f6bb6746"]]),LinkTableCard$1=Object.freeze(Object.defineProperty({__proto__:null,default:LinkTableCard},Symbol.toStringTag,{value:"Module"}));const LINK_DOWN="link_down",LINK_TABLE_FIELD="link_table_field",LINK_TABLE="link_table";function useFormItems(e,t){add("OnlineSelectCascade",OnlineSelectCascade),add("LinkTableSelect",LinkTableSelect),add("LinkTableCard",LinkTableCard);const n=e.modalClass,l=ref([]),o=ref(""),i=ref({}),a=reactive({}),r=ref(!1),s=ref([]),u=ref({}),d={},c=ref([]),f=reactive({}),p=ref("");return p.value={sm:24,xs:24,md:12,lg:12,xl:12,xxl:12},watch(a,(e=>{let n=t.value,l=[],o=toRaw(e);Object.keys(o).map((e=>{if(e.endsWith("_load"));else{let t={field:e,show:o[e]},n=e+"_load";o.hasOwnProperty(n)&&(t.ifShow=o[n]),l.push(t)}})),n&&n.updateSchema(l)}),{immediate:!1}),watch((()=>e.formTemplate),(()=>{p.value=function(){let t=e.formTemplate;return 2==t?{sm:24,xs:24,md:12,lg:12,xl:12,xxl:12}:3==t?{sm:24,xs:24,md:8,lg:8,xl:8,xxl:8}:4==t?{sm:24,xs:24,md:6,lg:6,xl:6,xxl:6}:{span:24}}()}),{immediate:!0}),{formSchemas:l,defaultValueFields:f,tableName:o,dbData:i,checkOnlyFieldValue:function(e,t){return new Promise((n=>{t||n("");let l={tableName:o.value.replace(/\$\d+/,""),fieldName:e.field,fieldVal:t},a=i.value;a.id&&(l.dataId=a.id),duplicateCheck(l).then((e=>{e.success?n(""):n(e.message)})).catch((e=>{n(e)}))}))},createFormSchemas:function(e,i,c){clearObj(f),f[o.value]=[];let p=[],m=[],h=[],g={},b={};Object.keys(e).map((n=>{const l=e[n];if("tab"==l.view){r.value=!0,f[n]=[];let e={key:n,foreignKey:l.foreignKey,describe:l.describe,relationType:l.relationType,requiredFields:l.required||[],order:l.order,id:l.id};1==l.relationType?(d[n]=ref(null),e.properties=l.properties):(!function(e){useOnlineVxeTableColumns(e,(t=>{initSubTableDefValueConfig(t,f[e.key])}))}(l),d[n]=ref(),e.columns=l.columns,g[n]=[]),p.push(e),handleSubTableButtonAuth(n,l)}else if(initDefValueConfig(n,l,f[o.value]),l.view===LINK_DOWN){let e=handleLinkDown(l,n);for(let n of e){a[n.key]=!0,a[n.key+"_load"]=!0;let e=FormSchemaFactory.createFormSchema(n.key,n);c&&e.setOnlyValidateFun(c),e.isRequired(i),e.setFormRef(t),e.handleWidgetAttr(l);let o=getFieldIndex(m,n.key);-1==o?m.push(e):m[o]=e}}else{if(a[n]=!0,a[n+"_load"]=!0,-1==getFieldIndex(m,n)){let e=FormSchemaFactory.createFormSchema(n,l);if(c&&e.setOnlyValidateFun(c),e.isRequired(i),e.setFormRef(t),m.push(e),h.push(...e.getRelatedHideFields()),l.view===LINK_TABLE_FIELD){let t=e.getLinkFieldInfo();if(t)if(b[t[0]]){b[t[0]].push(t[1])}else b[t[0]]=[t[1]]}}}})),m.sort((function(e,t){return e.order-t.order}));let y=[];y.push(FormSchemaFactory.createIdField());for(let t of m)t.view&&t.view==LINK_TABLE&&b[t.field]&&t.setOtherInfo(b[t.field]),h.indexOf(t.field)>=0&&t.isHidden(),n&&t.setCustomPopContainer(n),y.push(t.getFormItemSchema());l.value=y,p.sort((function(e,t){return e.order-t.order})),s.value=p,u.value=g},fieldDisplayStatus:a,subTabInfo:s,hasSubTable:r,subDataSource:u,baseColProps:p,changeDataIfArray2String:function(e){return Object.keys(e).map((t=>{e[t]&&e[t]instanceof Array&&(e[t]=e[t].join(","))})),e},linkDownList:c,refMap:d}}function useOnlineVxeTableColumns(e,t){const n={inputNumber:"input-number",sel_depart:"depart-select",sel_user:"user-select",list_multi:"select-multiple",input_pop:"textarea",sel_search:"select-search","select-dict-search":"selectDictSearch"};e.columns.forEach((e=>{"radio"===e.type?e.type="select":n[e.type]?e.type=n[e.type]:"popup"===e.type&&function(e){let{destFields:t,orgFields:n}=e,l=[];if(t&&0!=t.length){let e=t.split(","),o=n.split(",");for(let t=0;t<e.length;t++)l.push({target:e[t],source:o[t]})}else;e.fieldConfig=l}(e),"depart-select"===e.type&&(e.checkStrictly=!0),"user-select"===e.type&&function(e){let t=e.fieldExtendJson,n=!1;if(t)try{!1===JSON.parse(t).multiSelect&&(n=!0)}catch(l){}e.isRadioSelection=n}(e),120!=e.width&&"120px"!=e.width||"image"!=e.type&&"file"!=e.type||(e.width="130px"),e.width||(e.width="200px"),t&&t(e)}))}function useOnlineFormContext(){let e={};const t=new Proxy({},{get:(t,n)=>Reflect.get(e,n)});function n(t,n){e[t]=n}return n("$nextTick",nextTick),n("addObject2Context",n),{onlineFormContext:t,addObject2Context:n,resetContext:function(t){Object.keys(t).map((n=>{e[n]=t[n]}))}}}function handleLinkDown(e,t){const{config:{table:n,key:l,txt:o,linkField:i,idField:a,pidField:r,condition:s},others:u,order:d,title:c}=e;let f={dictTable:n,dictText:o,dictCode:l,pidField:r,idField:a,view:LINK_DOWN,type:e.type},p=[],m=__spreadValues({key:t,title:c,order:d,condition:s,origin:!0},f);if(i&&i.length>0){let e=i.split(",");m.next=e[0];for(let t=0;t<e.length;t++)for(let n of u)if(n.field==e[t]){let l=__spreadValues({key:n.field,title:n.title,order:n.order,origin:!1},f);t+1<e.length&&(l.next=e[t+1]),p.push(l)}}return p.push(m),p}function getFieldIndex(e,t){let n=-1;for(let l=0;l<e.length;l++){if(e[l].field===t){n=l;break}}return n}function getRefPromise(e){return new Promise((t=>{!function n(){let l=e.value;l?t(l):setTimeout((()=>{n()}),100)}()}))}function clearObj(e){Object.keys(e).map((t=>{delete e[t]}))}const permissionStore=usePermissionStore();function handleSubTableButtonAuth(e,t){let n=t.hideButtons,l=ONL_AUTH_PRE+e+":";n||(n=[]),permissionStore.setOnlineSubTableAuth(l,n)}function getDetailFormSchemas(e){const t=ref([]),n={},l=ref(!1),o=ref([]),i=ref({}),a=computed((()=>{let t=e.formTemplate;return"2"==t?12:"3"==t?8:"4"==t?6:24}));function r(e,t){let n=-1;for(let l=0;l<e.length;l++){if(e[l].field===t){n=l;break}}return n}return{detailFormSchemas:t,hasSubTable:l,subTabInfo:o,refMap:n,createFormSchemas:function(e){let s=[],u=[],d={};Object.keys(e).map((t=>{const o=e[t];if("tab"==o.view){l.value=!0;let e={key:t,foreignKey:o.foreignKey,describe:o.describe,relationType:o.relationType,requiredFields:o.required||[],order:o.order};1==o.relationType?(n[t]=ref(null),e.properties=o.properties):(!function(e){useOnlineVxeTableColumns(e)}(o),n[t]=ref(),e.columns=o.columns,d[t]=[]),s.push(e)}else if(o.view===LINK_DOWN){let e=function(e,t){let n=[];const{config:{table:l,key:o,txt:i,linkField:a},order:r,title:s,others:u}=e;let d={table:l,key:o,txt:i},c={view:"link_down",order:r,title:s,dictTable:JSON.stringify(d)};if(n.push(Object.assign({},{linkField:a,key:t},c)),a){let e=a.split(",");for(let t of e){let e="";for(let n of u)n.field==t&&(e=n.title);n.push(Object.assign({},{key:t},c,{title:e}))}}return n}(o,t);for(let t of e){let e=r(u,t.key),n={field:t.key,label:t.title,view:t.view,order:t.order,dictTable:t.dictTable,linkField:t.linkField||""};-1==e?u.push(n):u[e]=n}}else if("hidden"==o.view);else{if(-1==r(u,t)){let e=Object.assign({field:t,label:o.title},pick$1(o,["view","order","fieldExtendJson","dictTable","dictText","dictCode","dict"]));if("file"==o.view&&(e.span=24,e.isFile=!0),"image"==o.view&&(e.span=24,e.isImage=!0),"link_table"==o.view&&o.fieldExtendJson)try{let t=JSON.parse(o.fieldExtendJson);"select"!=t.showType&&(e.isCard=!0),1==t.multiSelect&&(e.multi=!0)}catch(i){}"umeditor"!=o.view&&"markdown"!=o.view||(e.isHtml=!0,e.span=24),u.push(e)}}})),u.sort((function(e,t){return e.order-t.order})),s.sort((function(e,t){return e.order-t.order})),o.value=s;for(let t=0;t<u.length;t++){let e=u[t];if((!0===e.isFile||!0===e.isImage||!0===e.isHtml)&&t>0){let e=u[t-1],n=e.span||a.value;e.span=n}}t.value=u,i.value=d},formSpan:a,subDataSource:i}}var useAutoForm=Object.freeze(Object.defineProperty({__proto__:null,L:LinkTableCard,O:OnlineSubForm,a:OnlinePopModal,b:useFormItems,c:useEnhance,d:getDetailFormSchemas,e:loadOneFieldDefVal,f:LINK_DOWN,g:getRefPromise,h:handleLinkDown,i:getFieldIndex,j:useTableColumns,k:useAutoModal,l:loadFormFieldsDefVal,m:OnlineSubForm$1,n:OnlinePopForm$1,o:OnlinePopModal$1,p:LinkTableSelect$1,q:OnlinePopListModal$1,r:LinkTableCard$1,u:useOnlineFormContext},Symbol.toStringTag,{value:"Module"}));export{DiffOutlined$1 as D,LinkTableCard as L,OnlineSubForm as O,PrinterOutlined$1 as P,OnlinePopModal as a,useFormItems as b,useEnhance as c,getDetailFormSchemas as d,loadOneFieldDefVal as e,LINK_DOWN as f,getRefPromise as g,handleLinkDown as h,getFieldIndex as i,useTableColumns as j,useAutoModal as k,loadFormFieldsDefVal as l,useAutoForm as m,useOnlineFormContext as u};

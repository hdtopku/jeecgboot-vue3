import{f0 as e,ew as t,F as a,a8 as o,o as l,bI as n,t as i,v as r,x as s,y as u,W as d,V as c,z as f,ax as p,bc as m,Y as b,X as h,ac as g,f1 as y,a1 as v,r as j,fa as F,u as S,L as w,Q as k}from"./index.435ab247.js";import{B as C}from"./BasicForm.d9f6c231.js";import"./helper.1c9dc9a5.js";import{u as T}from"./useForm.45d68074.js";import"./JAddInput.8c125e2c.js";import{V as P,S as x,b as O,O as A}from"./FormSchemaFactory.255c9043.js";import{O as V,P as R,D,a as M,u as _,b as B,c as I,l as J,g as K}from"./useAutoForm.8caa5d39.js";import"./index.e1e06dd6.js";import{p as E}from"./pick.dbff1c58.js";import{o as $}from"./omit.d6518a29.js";import"./JUpload.e164672b.js";import"./JUploadModal.3912f1fd.js";import"./OnlineSelectCascade.57c81c27.js";import{F as U}from"./BasicTable.0748ea8a.js";import"./TableImg.e204e8e3.js";import"./Area.a75a656a.js";import"./functional.be5901d6.js";import"./LinkTableListPiece.9242d2bb.js";import"./_flatRest.ff1861ce.js";import"./isArray.40a4ed15.js";import"./toString.cf909882.js";import"./_arrayPush.8821345e.js";import"./_baseClone.a8082016.js";import"./uniqBy.91f18935.js";import"./BasicModal.c66de981.js";import"./useWindowSizeFn.3d5b1a05.js";import"./useFormItem.816007c4.js";import"./download.5dc68cfb.js";import"./base64Conver.030fa32c.js";import"./index.a5502478.js";import"./index.64086148.js";import"./useCountdown.adc4ab77.js";import"./index.cdc49bf1.js";import"./api.bc301b0f.js";import"./props.5467b933.js";import"./index.713dc63d.js";import"./bem.0e923c54.js";import"./props.37836c63.js";import"./useContextMenu.82ce6d89.js";import"./index.e1ec35e6.js";import"./onMountedOrActivated.e9ddbd41.js";import"./index.627c6cd3.js";import"./htmlmixed.749cbc8c.js";import"./vue.f62dfd4a.js";/* empty css             */import"./depart.api.c07add53.js";import"./user.api.f3bf5333.js";import"./_commonjsHelpers.7ef9cff5.js";import"./customExpression.58041e91.js";import"./useListPage.26849a0d.js";import"./useTable.6359f662.js";import"./index.4cdbd2ab.js";import"./useContentHeight.60ff243a.js";import"./useContentViewHeight.f55d8457.js";import"./usePageContext.56c44530.js";import"./RedoOutlined.9fc7613c.js";import"./JModalTip.2169c74d.js";import"./_baseSlice.23bb44df.js";var q=Object.defineProperty,N=Object.getOwnPropertySymbols,H=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable,W=(e,t,a)=>t in e?q(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a,z=(e,t)=>{for(var a in t||(t={}))H.call(t,a)&&W(e,a,t[a]);if(N)for(var a of N(t))L.call(t,a)&&W(e,a,t[a]);return e},Q=(e,t,a)=>new Promise(((o,l)=>{var n=e=>{try{r(a.next(e))}catch(t){l(t)}},i=e=>{try{r(a.throw(e))}catch(t){l(t)}},r=e=>e.done?o(e.value):Promise.resolve(e.value).then(n,i);r((a=a.apply(e,t)).next())}));const G="/online/cgform/api/form/",X="/online/cgform/api/doButton",Y={name:"OnlineForm",components:{BasicForm:C,Loading:t,OnlineSubForm:V,PrinterOutlined:R,DiffOutlined:D,FormOutlined:U,OnlinePopModal:M},props:{id:{type:String,default:""},formTemplate:{type:Number,default:1},disabled:{type:Boolean,default:!1},isTree:{type:Boolean,default:!1},pidField:{type:String,default:""},submitTip:{type:Boolean,default:!0}},emits:["success","rendered"],setup(e,{emit:t}){const{createMessage:i}=S(),r=a(null),s=a(!0),u=a(!1),d=a(1),c=a(""),f=a(!1),p=a(!1),m=o({reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:0,modalMinWidth:"",commentStatus:0}),{onlineFormContext:b,resetContext:h}=_(),{formSchemas:C,defaultValueFields:V,changeDataIfArray2String:R,tableName:D,dbData:M,checkOnlyFieldValue:U,hasSubTable:q,subTabInfo:N,refMap:H,subDataSource:L,baseColProps:W,createFormSchemas:Y,linkDownList:Z,fieldDisplayStatus:ee}=B(e,r);let{EnhanceJS:te,initCgEnhanceJs:ae}=I(b,!1);const[oe,{setProps:le,validate:ne,resetFields:ie,setFieldsValue:re,updateSchema:se,getFieldsValue:ue,scrollToField:de}]=T({schemas:C,showActionButtonGroup:!1,baseColProps:W}),ce=a(!1);function fe(e,t){let a=g(V[e.key]);J(a,(e=>{const{row:a,target:o}=t;let l=[{rowKey:a.id,values:z({},e)}];o.setValues(l)}))}function pe(t){return Q(this,null,(function*(){let a=yield function(t){let a=`${G}${e.id}/${t}`;return new Promise(((e,t)=>{v.get({url:a},{isTransformResponse:!1}).then((a=>{a.success?e(a.result):(t(),i.warning(a.message))})).catch((()=>{t()}))}))}(t.id);M.value=Object.assign({},t,a);let o=be.value,l=E(a,...o);e.disabled&&Object.keys(l).map((e=>{l[e]||0===l[e]||"0"===l[e]||delete l[e]})),yield re(l),me(a)}))}function me(e){e||(e={});let t=Object.keys(L.value);if(t&&t.length>0){let a={};for(let o of t)a[o]=e[o]||[];L.value=a}}let be=l((()=>{let e=C.value,t=[];for(let a of e)t.push(a.field);return t}));function he(a){(function(e,t){return te&&te.beforeSubmit?te.beforeSubmit(e,t):Promise.resolve()})(xe,a).then((()=>{!function(a){Object.keys(a).map((e=>{Array.isArray(a[e])&&0==a[e].length&&(a[e]="")}));let o=c.value,l=`${G}${e.id}?tabletype=${d.value}`;o&&(l=`${o}?tabletype=${d.value}`);!0===f.value&&(a[x]=1);let n=!0===p.value?"put":"post";v.request({url:l,method:n,params:a},{isTransformResponse:!1}).then((o=>{o.success?(o.result&&(a[O]=o.result),t("success",a),!0===e.submitTip&&i.success(o.message)):i.warning(o.message)})).finally((()=>{u.value=!1}))}(a)})).catch((e=>{i.warning(e)}))}const ge=a("0"),ye=a(300),ve=a(340);function je(t,a){if("js"==t)te&&te[a]&&te[a].call(b,b);else if("action"==t){let t=M.value,o={formId:e.id,buttonCode:a,dataId:t.id,uiFormData:Object.assign({},t)};v.post({url:`${X}`,params:o},{isTransformResponse:!1}).then((e=>{e.success?i.success("处理完成!"):i.warning("处理失败!")}))}}function Fe(e){let t=H[e].value,a=[...t.getNewDataWithId(),...L.value[e]];if(!a||0==a.length)return!1;let o=[];for(let l of a)o.push(l.id);t.removeRowsById(o)}function Se(e,t){if(!t)return!1;let a=H[e].value;"object"==typeof t?a.addRows(t,!0):this.$message.error("添加子表数据,参数不识别!")}function we(e){let t=H[e].value;return t instanceof Array&&(t=t[0]),t}const[ke,{openModal:Ce}]=n(),Te=a(""),Pe=a(!0);let xe={tableName:D,loading:u,subActiveKey:ge,onlineFormRef:r,getFieldsValue:ue,setFieldsValue:re,submitFlowFlag:f,subFormHeight:ye,subTableHeight:ve,refMap:H,triggleChangeValues:function(e,t,a){t&&a?a.vxeProps?a.setValues([{rowKey:t,values:e}]):a.setValues(e):re(e)},triggleChangeValue:function(e,t){let a={};a[e]=t,re(a)},sh:ee,clearSubRows:Fe,addSubRows:Se,clearThenAddRows:function(e,t){Fe(e),Se(e,t)},changeOptions:function(e,t){!t&&t.length<=0&&(t=[]),t.map((e=>{e.hasOwnProperty("label")||(e.label=e.text)})),se({field:e,componentProps:{options:t}})},isUpdate:p,getSubTableInstance:we,updateSchema:se};return h(xe),{tableName:D,onlineFormRef:r,registerForm:oe,loading:u,subActiveKey:ge,hasSubTable:q,subTabInfo:N,refMap:H,subFormHeight:ye,getSubTableForeignKeyValue:function(e){if(!0===p.value){return function(e,t){if(e){let a=e[t];return a||0===a||(a=e[t.toLowerCase()],a||0===a||(a=e[t.toUpperCase()])),a}return""}(M.value,e)}return""},isUpdate:p,handleSubFormChange:function(e,t){if(te&&te[t+"_onlChange"]){let a=te[t+"_onlChange"](),o=Object.keys(e)[0];if(a[o]){let l=H[t].value;l instanceof Array&&(l=l[0]);let n=l.getFormEvent(),i=z({column:{key:o},value:e[o]},n);a[o].call(b,b,i)}}},subTableHeight:ve,onlineFormDisabled:ce,subDataSource:L,getSubTableAuthPre:function(e){return"online_"+e+":"},handleAdded:function(e,t){fe(e,t)},handleSubTableDefaultValue:fe,handleValueChange:function(e,t){if(te&&te[t+"_onlChange"]){let a=te[t+"_onlChange"](b);if("all"===e.column){let t=Object.keys(a);if(t.length>0)for(let o of t)a[o].call(b,b,e)}else{let t=e.column.key||e.col.key;a[t]&&e.row&&e.row.id&&a[t].call(b,b,e)}}},openSubFormModalForAdd:function(e){Te.value=e.id,Pe.value=!1,Ce(!0,{})},openSubFormModalForEdit:function(e){let t=H[e.key];if(!t||!t.value)return void i.warning("子表ref找不到:"+e.key);t=t.value,Array.isArray(t)&&(t=t[0]);let a=t.getSelectedData();1==a.length?(Te.value=e.id,Pe.value=!1,Ce(!0,{isUpdate:!0,record:a[0]})):i.warning("请选择一条数据")},show:function(t,a,o){return Q(this,null,(function*(){yield function(){return Q(this,null,(function*(){if(!0===e.isTree){let t=e.pidField,a=C.value;if(a&&a.length>0){a.filter((e=>e.field===t)).length>0&&(yield se({field:t,componentProps:{reload:(new Date).getTime()}}))}}}))}(),c.value="",yield ie(),M.value="";let l=w(t);p.value=l,l?yield pe(a):me(),k((()=>{!l&&o&&re(o),function(){if(!1===w(p)){let e=g(V[D.value]);J(e,(e=>{re(e)}))}}(),je("js","loaded"),function(){let t=e.disabled;ce.value=t,le({disabled:t})}()}))}))},createRootProperties:function(e){return Q(this,null,(function*(){d.value=e.head.tableType,D.value=e.head.tableName,s.value=1==e.head.tableType,function(e){let t={reportPrintShow:0,reportPrintUrl:"",joinQuery:0,modelFullscreen:1,modalMinWidth:"",commentStatus:0};e&&(t=JSON.parse(e));Object.keys(t).map((e=>{m[e]=t[e]}))}(e.head.extConfigJson),Y(e.schema.properties,e.schema.required,U),te=ae(e.enhanceJs),t("rendered",m),(yield K(r)).$formValueChange=(e,t,a)=>{!function(e,t){Q(this,null,(function*(){if(!te||!te.onlChange)return!1;if(!e)return!1;let a=te.onlChange();if(a[e]){let o={row:yield ue(),column:{key:e},value:t};a[e].call(b,b,o)}}))}(e,t),a&&re(a)}}))},handleSubmit:function(){!0===s.value?function(){Q(this,null,(function*(){try{let e=yield ne();e=Object.assign({},M.value,e),e=R(e),u.value=!0,he(e)}finally{u.value=!1}}))}():function(){let e={};return new Promise(((e,t)=>{ne().then((t=>e(t)),(({errorFields:e})=>{e&&e.length>0&&de(e[0][0]),t(P)}))})).then((t=>(Object.assign(e,R(t)),function(){return new Promise(((e,t)=>Q(this,null,(function*(){let a={};try{let e=N.value;for(let t=0;t<e.length;t++){let l=e[t].key,n=H[l].value;if(n instanceof Array&&(n=n[0]),1==e[t].relationType)try{let e=yield n.getAll();a[l]=[],a[l].push(e)}catch(o){throw{code:P,key:l}}else{if(yield n.fullValidateTable())throw{code:P,key:l};a[l]=n.getTableData()}}}catch(o){t(o)}e(a)}))))}()))).then((t=>(Object.assign(e,t),Promise.resolve(e)))).catch((e=>(e!==P&&(null==e?void 0:e.code)!==P||(i.warning("校验未通过"),e.key&&function(e){let t=N.value;for(let a=0;a<t.length;a++)if(e==t[a].key){let o=a+"";if(ge.value===o)break;if(ge.value=o,0===t[a].relationType){let t=H[e].value;t=Array.isArray(t)?t[0]:t,y(300,(()=>null==t?void 0:t.validateTable()))}break}}(e.key)),Promise.reject(null))))}().then((e=>{he(e)}))},sh:ee,handleCgButtonClick:je,handleCustomFormSh:function(e,t){let a=g(ee);e&&e.length>0?Object.keys(a).map((t=>{!t.endsWith("_load")&&e.indexOf(t)<0&&(ee[t]=!1)})):t&&t.length>0&&Object.keys(a).map((e=>{t.indexOf(e)>=0&&(ee[e]=!1)}))},handleCustomFormEdit:function(e,t){return Q(this,null,(function*(){c.value=t,yield ie(),M.value="",p.value=!0,yield pe(e),yield k((()=>{je("js","loaded")}))}))},dbData:M,onOpenReportPrint:function(){let e=m.reportPrintUrl,t=M.value.id,a=j();F(e,t,a)},onlineExtConfigJson:m,registerPopModal:ke,popTableName:Te,getPopFormData:function(e){const t=e[A];let a=$(e,[A]);if(a.id){const e=H[t];if(!e||!e.value)return void i.warning("子表ref找不到:"+t);let o=$(z({},a),"id"),l=[{rowKey:a.id,values:o}],n=e.value;n instanceof Array&&(n=n[0]),n.setValues(l)}else{let e=H[t].value;e instanceof Array&&(e=e[0]),e.addRows(a,{isOnlineJS:!1,setActive:!1,emitChange:!0})}},popModalRequest:Pe,onCloseModal:function(){let e=N.value;if(e&&e.length>0)for(let t of e)if(1==t.relationType);else{let e=we(t.key);e&&e.clearSelection()}}}}},Z=["id"],ee={key:0,style:{"text-align":"right",position:"absolute",top:"6px",right:"20px","z-index":"999"}},te={key:1};var ae=e(Y,[["render",function(e,t,a,o,l,n){const g=i("PrinterOutlined"),y=i("BasicForm"),v=i("online-sub-form"),j=i("diff-outlined"),F=i("a-button"),S=i("form-outlined"),w=i("JVxeTable"),k=i("a-tab-pane"),C=i("a-tabs"),T=i("Loading"),P=i("online-pop-modal");return r(),s("div",{id:o.tableName+"_form"},[o.dbData.id&&o.onlineExtConfigJson.reportPrintShow?(r(),s("div",ee,[u(g,{title:"打印",onClick:o.onOpenReportPrint,style:{"font-size":"16px"}},null,8,["onClick"])])):d("",!0),u(y,{ref:"onlineFormRef",onRegister:o.registerForm},null,8,["onRegister"]),o.hasSubTable?(r(),c(C,{key:1,activeKey:o.subActiveKey,"onUpdate:activeKey":t[0]||(t[0]=e=>o.subActiveKey=e)},{default:f((()=>[(r(!0),s(p,null,m(o.subTabInfo,((e,t)=>(r(),c(k,{tab:e.describe,key:t+"",forceRender:!0},{default:f((()=>[1==e.relationType?(r(),s("div",{key:0,style:b({"overflow-y":"auto","overflow-x":"hidden","max-height":o.subFormHeight+"px"})},[u(v,{ref_for:!0,ref:o.refMap[e.key],table:e.key,disabled:o.onlineFormDisabled,"form-template":a.formTemplate,"main-id":o.getSubTableForeignKeyValue(e.foreignKey),properties:e.properties,"required-fields":e.requiredFields,"is-update":o.isUpdate,onFormChange:t=>o.handleSubFormChange(t,e.key)},null,8,["table","disabled","form-template","main-id","properties","required-fields","is-update","onFormChange"])],4)):(r(),s("div",te,[u(w,{ref_for:!0,ref:o.refMap[e.key],toolbar:"","keep-source":"","row-number":"","row-selection":"",height:o.subTableHeight,disabled:o.onlineFormDisabled,columns:e.columns,dataSource:o.subDataSource[e.key],onValueChange:t=>o.handleValueChange(t,e.key),authPre:o.getSubTableAuthPre(e.key),onAdded:t=>o.handleAdded(e,t),onExecuteFillRule:t=>o.handleSubTableDefaultValue(e,t)},{toolbarSuffix:f((()=>[u(F,{type:"primary",onClick:t=>o.openSubFormModalForAdd(e)},{default:f((()=>[u(j)])),_:2},1032,["onClick"]),u(F,{type:"primary",onClick:t=>o.openSubFormModalForEdit(e)},{default:f((()=>[u(S)])),_:2},1032,["onClick"])])),_:2},1032,["height","disabled","columns","dataSource","onValueChange","authPre","onAdded","onExecuteFillRule"])]))])),_:2},1032,["tab"])))),128))])),_:1},8,["activeKey"])):d("",!0),u(T,{loading:o.loading,absolute:!1},null,8,["loading"]),h(e.$slots,"bottom"),u(P,{request:o.popModalRequest,id:o.popTableName,onRegister:o.registerPopModal,onSuccess:o.getPopFormData,topTip:"",isVxeTableData:""},null,8,["request","id","onRegister","onSuccess"])],8,Z)}]]);export{ae as default};
